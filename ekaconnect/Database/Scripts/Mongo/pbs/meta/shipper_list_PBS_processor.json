{
  "_id": "shipper_list_PBS_processor",
  "name": "shipper_list",
  "type": "processor",
  "refType": "app",
  "refTypeId": "4e20f754-574e-43e7-8d11-87c6fae060f5",
  "snippet": "var platformUrl =\r\n    req.body.propertyList.eka_connect_host +\r\n    '/collectionmapper/' +\r\n    req.body.appId +\r\n    '/9c98c493-ee2f-490d-be92-fe2424f513e5/fetchCollectionRecords';\r\nvar connectUrl = req.body.propertyList.eka_connect_host + '/workflow/data';\r\nvar connectBody = {\r\n    appId: req.body.appId,\r\n    workFlowTask: 'createshipperlistCOPY'\r\n};\r\nvar connect = {\r\n    method: 'POST',\r\n    body: connectBody,\r\n    url: connectUrl,\r\n    headers: {\r\n        Authorization: req.headers.authorization,\r\n        'X-TenantID': req.headers['x-tenantid']\r\n    },\r\n    json: true\r\n};\r\nif (req.headers.hasOwnProperty('device-id')) {\r\n    connect.headers['Device-Id'] = req.headers['device-id'];\r\n}\r\nfunction get_connect() {\r\n    return new Promise(function (resolve, reject) {\r\n        request(connect, function (err, response, body) {\r\n            if (response.statusCode >= 200 && response.statusCode <= 299) {\r\n                resolve(body);\r\n            }\r\n            else {\r\n                reject(body);\r\n            }\r\n        });\r\n    });\r\n}\r\nvar filterarr = [];\r\nif (req && req.body && req.body.queryParams) {\r\n    var obj1 = {};\r\n    obj1['fieldName'] = 'Planned Bulk Shipment Ref No';\r\n    obj1['value'] = req.body.queryParams.plannedBulkShipmentNo[0];\r\n    obj1['operator'] = 'eq';\r\n    filterarr.push(obj1);\r\n}\r\nvar platformBody = {\r\n    criteria: {\r\n        filter: filterarr\r\n    },\r\n    collectionName: req.body.propertyList.shipper_collection_name\r\n};\r\nvar collection = {\r\n    method: 'POST',\r\n    url: platformUrl,\r\n    body: platformBody,\r\n    headers: {\r\n        Authorization: req.headers.authorization,\r\n        'Content-Type': 'application/json',\r\n        ttl: 300,\r\n        'X-TenantID': req.headers['x-tenantid'],\r\n        'X-Remote-User': 'ekaApp'\r\n    },\r\n    json: true\r\n};\r\nif (req.headers.hasOwnProperty('device-id')) {\r\n    collection.headers['Device-Id'] = req.headers['device-id'];\r\n}\r\n\r\nfunction get_collection() {\r\n    return new Promise(function (resolve, reject) {\r\n        console.log('Request - ' + collection.url);\r\n        request(collection, function (err, response, body) {\r\n            console.log('Response - ' + body);\r\n            if (response.statusCode >= 200 && response.statusCode <= 299) {\r\n                resolve(body);\r\n            }\r\n            else {\r\n                reject(body);\r\n            }\r\n        });\r\n    });\r\n}\r\nPromise.all([get_collection(), get_connect()])\r\n    .then(function (result) {\r\n        var collection = result[0];\r\n        var collection_shipper = result[1].data;\r\n        var collectiondata = [];\r\n        for (var i = 0; i < collection.length; i++) {\r\n            collection[i]['Shipper Details'] = collection[i]['Shipper Details'].trim();\r\n            if (collection[i]['Planned Bulk Shipment Ref No'] === req.body.queryParams.plannedBulkShipmentNo[0]) {\r\n                collectiondata.push({\r\n                    shipper: collection[i]['Shipper Details'],\r\n                    shipper_id: collection[i]['Shipper Details'],\r\n                    plannedBulkShipmentNo: req.body.queryParams.plannedBulkShipmentNo[0],\r\n                    shipperpbs: req.body.queryParams.plannedBulkShipmentNo[0] + collection[i]['Shipper Details']\r\n                });\r\n            }\r\n        }\r\n        if (collection_shipper.length == 0) {\r\n            collectiondata = collectiondata;\r\n        } else {\r\n            for (var i = 0; i < collectiondata.length; i++) {\r\n                for (var j = 0; j < collection_shipper.length; j++) {\r\n                    if (collection_shipper[j]['shipperpbs'] === collectiondata[i]['shipperpbs'])\r\n                        collectiondata[i] = {\r\n                            shipper: collection[i]['Shipper Details'],\r\n                            shipper_id: collection[i]['Shipper Details'],\r\n                            plannedBulkShipmentNo: req.body.queryParams.plannedBulkShipmentNo[0],\r\n                            shipperpbs: req.body.queryParams.plannedBulkShipmentNo[0] + collection[i]['Shipper Details'],\r\n                            ...collection_shipper[j]\r\n                        };\r\n                }\r\n            }\r\n        }\r\n        collectiondata = collectiondata.reduce((unique, o) => {\r\n            if (!unique.some(obj => obj.shipperpbs === o.shipperpbs)) {\r\n                unique.push(o);\r\n            }\r\n            return unique;\r\n        }, []);\r\n        res.status(200).send(collectiondata);\r\n    })\r\n    .catch(err => {\r\n        res.status(500).send(err);\r\n    });\r\n",
  "sys__UUID": "0041837a-0259-45cd-a326-a15bae84ebdc",
  "sys__createdBy": "ekauser@ekaplus.com"
}
