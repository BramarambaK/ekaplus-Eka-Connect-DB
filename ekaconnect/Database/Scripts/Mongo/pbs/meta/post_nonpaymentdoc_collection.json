{
  "_id": "post_nonpaymentdoc_collection",
  "name": "post_nonpaymentdoc_collection",
  "type": "processor",
  "refType": "app",
  "refTypeId": "4e20f754-574e-43e7-8d11-87c6fae060f5",
  "snippet": "var moment = require(\"moment\");\r\nvar updateCollection = {\r\n    method: \"PUT\",\r\n    url: req.body.propertyList.platform_url + \"/collection/v1/append/data\",\r\n    headers: {\r\n        Authorization: req.headers.authorization,\r\n    },\r\n    json: true,\r\n    body: {\r\n        collectionName: \"seller_nonpaymentdoc\",\r\n        collectionData: [],\r\n        format: \"JSON\",\r\n    },\r\n};\r\nfunction update_collection() {\r\n    return new Promise(function (resolve, reject) {\r\n        request(updateCollection, function (err, response, body) {\r\n            if (response.statusCode >= 200 && response.statusCode <= 299) {\r\n                resolve(body);\r\n            }\r\n            else {\r\n                reject(body);\r\n            }\r\n        });\r\n    });\r\n}\r\nif (req.body.bulkPayLoadData && req.body.bulkPayLoadData[0].seller)\r\n    updateCollection.body.collectionName = \"seller_nonpaymentdoc\";\r\nelse if (req.body.bulkPayLoadData && req.body.bulkPayLoadData[0].shipper)\r\n    updateCollection.body.collectionName = \"shipper_nonpaymentdoc\";\r\nfunction preparePayload(index) {\r\n    return new Promise((resolve, reject) => {\r\n        var body = [];\r\n        var data = req.body.bulkPayLoadData[index];\r\n        var id;\r\n        if (req.body.bulkPayLoadData[index].seller) {\r\n            req.body.bulkPayLoadData[index].uniqueId =\r\n                data.plannedBulkShipmentNo + data.seller + data.documentName;\r\n            id = data.seller;\r\n        } else if (req.body.bulkPayLoadData[index].shipper) {\r\n            req.body.bulkPayLoadData[index].uniqueId =\r\n                data.plannedBulkShipmentNo + data.shipper + data.documentName;\r\n            id = data.shipper;\r\n        }\r\n        if (data.documentDate) {\r\n            var date = moment\r\n                .utc(data.documentDate)\r\n                .utcOffset(\"+0530\")\r\n                .format(\"DD-MMM-YYYY\");\r\n            body = [\r\n                req.body.bulkPayLoadData[index].uniqueId,\r\n                data.plannedBulkShipmentNo,\r\n                id,\r\n                data.documentName,\r\n                date,\r\n            ];\r\n        }\r\n        resolve(body);\r\n    });\r\n}\r\npreparePayload(0).then(async (result) => {\r\n    if (result.length > 0) updateCollection.body.collectionData.push(result);\r\n    for (var i = 1; i < req.body.bulkPayLoadData.length; i++) {\r\n        await preparePayload(i).then(function (data) {\r\n            if (data.length > 0) updateCollection.body.collectionData.push(data);\r\n        });\r\n    }\r\n    console.log(updateCollection.body);\r\n    await update_collection().then((msg) => {\r\n        res.status(200).send(req.body.bulkPayLoadData);\r\n    });\r\n});\r\n",
  "sys__UUID": "e56394c2-d28d-4f8a-8ef1-a80f496be2ee"
}
