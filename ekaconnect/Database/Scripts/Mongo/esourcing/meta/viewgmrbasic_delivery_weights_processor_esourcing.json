{
    "_id" : "viewgmrbasicDelWeight_esourcing",
    "name" : "viewgmrbasic_delivery_weights",
    "type" : "processor",
    "refType" : "app",
    "refTypeId" : "7e484cae-36aa-46dc-b9ae-33c8d246f056",
    "snippet" : "var intGmrRefNo =\r\n req.body.selectedData.selected[\"deliveryWeightsListing\"][\"internalGmrRefNo\"];\r\n  var gmrRefNo =\r\n req.body.selectedData.selected[\"deliveryWeightsListing\"][\"gmrRefNo\"];\r\nvar collection = {\r\n  method: \"POST\",\r\n  url: req.body.propertyList.eka_utility_host + \"/collection/assayAndStockList\",\r\n  headers: {\r\n    \"Content-Type\": \"application/json\",\r\n    Accept: \"application/json\",\r\n    Authorization: req.headers.authorization,\r\n    \"X-TenantID\": req.headers[\"x-tenantid\"]\r\n  },\r\n  body: {\r\n    intGmrRefNo: intGmrRefNo,\r\n\tgmrRefNo: gmrRefNo\r\n  },\r\n  json: true\r\n};\r\nDate.prototype.monthName = function() {\r\n    return this.toUTCString().split(' ')[2]\r\n\t};\r\n\r\nvar viewgmr = {\r\n  method: \"POST\",\r\n  url: req.body.propertyList.eka_connect_host + \"/workflow\",\r\n  headers: {\r\n    \"Content-Type\": \"application/json\",\r\n    Accept: \"application/json\",\r\n    Authorization: req.headers.authorization,\r\n    \"X-TenantID\": req.headers[\"x-tenantid\"]\r\n  },\r\n  body:{\r\n\t\t\"appId\": \"7e484cae-36aa-46dc-b9ae-33c8d246f056\",\r\n\t\t\"workflowTaskName\": \"viewgmrdata_SC\",\r\n\t\t\"task\": \"viewgmrdata_SC\",\r\n\t\t\"payLoadData\": \"\",\r\n\t\t\"output\": {\r\n\t\t\t\"viewgmrdata_SC\": {\r\n\t\t\t\t\"intGmrRefNo\": intGmrRefNo\r\n\t\t\t}\r\n\t\t}\r\n\t  },\r\n  json: true\r\n};\r\n\r\nvar activityLog = {\r\n  method: \"POST\",\r\n  url: req.body.propertyList.eka_ctrm_host + \"/api/logistic/viewAuditLog\",\r\n  headers: {\r\n    \"Content-Type\": \"application/json\",\r\n    Accept: \"application/json\",\r\n    Authorization: req.headers.authorization,\r\n    \"X-TenantID\": req.headers[\"x-tenantid\"]\r\n  },\r\n  body: {\r\n    \"internalGMRRefNo\": intGmrRefNo\r\n  },\r\n  json: true\r\n};\r\n\r\nfunction get_activitylog() {\r\n  return new Promise(function(resolve, reject) {\r\n    console.log(\"Request - \" + activityLog.url);\r\n    console.log(\"Payload -\" + JSON.stringify(activityLog));\r\n    request(activityLog, function(err, response, body) {\r\n      console.log(\"Request Body - \" + JSON.stringify(body));\r\n      if (err || body.error) reject(body);\r\n      else {\r\n        resolve(body);\r\n      }\r\n    });\r\n  });\r\n}\r\n\r\nfunction get_collection() {\r\n  return new Promise(function(resolve, reject) {\r\n    console.log(\"Request - \" + collection.url);\r\n    console.log(\"Payload -\" + JSON.stringify(collection));\r\n    request(collection, function(err, response, body) {\r\n      console.log(\"Request Body - \" + JSON.stringify(body));\r\n      if (err || body.error) reject(body);\r\n      else {\r\n        resolve(body);\r\n      }\r\n    });\r\n  });\r\n}\r\n\r\nfunction get_viewgmr() {\r\n  return new Promise(function(resolve, reject) {\r\n    console.log(\"Request - \" + viewgmr.url);\r\n    console.log(\"Payload -\" + JSON.stringify(viewgmr));\r\n    request(viewgmr, function(err, response, body) {\r\n      console.log(\"Request Body - \" + JSON.stringify(body));\r\n      if (err || body.error) reject(body);\r\n      else {\r\n        resolve(body);\r\n      }\r\n    });\r\n  });\r\n}\r\n\r\nvar connectGmr = {\r\n  method: \"GET\",\r\n  url:\r\n    req.body.propertyList.eka_connect_host +\r\n    \"/data/\" +\r\n    req.body.appId +\r\n    \"/\" +\r\n    req.body.selectedData.objectId +\r\n    \"?GmrRefNo=\" +\r\n     req.body.selectedData.selected[\"deliveryWeightsListing\"][\"gmrRefNo\"],\r\n  headers: {\r\n    Authorization: req.headers.authorization,\r\n    \"X-TenantID\": req.headers[\"x-tenantid\"]\r\n  },\r\n\r\n  json: true\r\n};\r\n\r\nvar platform = {\r\n  method: \"POST\",\r\n  url: req.body.propertyList.eka_utility_host + \"/list\",\r\n  headers: {\r\n    \"Content-Type\": \"application/json\",\r\n    Authorization: req.headers.authorization,\r\n    \"X-TenantID\": req.headers[\"x-tenantid\"]\r\n  },\r\n  body: {\r\n    otherAttributes: {\r\n      internalRefNo: intGmrRefNo\r\n    }\r\n  },\r\n\r\n  json: true\r\n};\r\nfunction get_platform() {\r\n  return new Promise(function(resolve, reject) {\r\n    console.log(\"Request - \" + platform.url);\r\n    console.log(\"Payload -\" + JSON.stringify(platform));\r\n    request(platform, function(err, response, body) {\r\n      console.log(\"Request Body - \" + JSON.stringify(body));\r\n      if (err || body.error) reject(body);\r\n      else {\r\n        resolve(body);\r\n      }\r\n    });\r\n  });\r\n}\r\n\r\nfunction get_GmrDetails() {\r\n  return new Promise(function(resolve, reject) {\r\n    console.log(\"Request - \" + connectGmr.url);\r\n    request(connectGmr, function(err, response, body) {\r\n      console.log(\"Response - \" + body);\r\n      if (err || body.error) reject(body);\r\n      else {\r\n        console.log(\"Success\");\r\n        resolve(body);\r\n      }\r\n    });\r\n  });\r\n}\r\n\r\nPromise.all([get_collection(), get_viewgmr(), get_platform(), get_GmrDetails(), get_activitylog()])\r\n  .then(function(result) {\r\n    var data = {};\r\n    data[\"assayStockList\"] = result[0];\r\n    let connectData = {};\r\n    if (result[3] && Array.isArray(result[3]) && result[3].length > 0) {\r\n      connectData[\"particleSize\"] = result[3][0][\"particleSize\"];\r\n      connectData[\"MaterialDescription\"] = result[3][0][\"MaterialDescription\"];\r\n      connectData[\"maxLotSize\"] = result[3][0][\"maxLotSize\"];\r\n      connectData[\"containerFlag\"] = result[3][0][\"containerFlag\"];\r\n    }\r\n\tresult[1] = result[1][\"data\"];\r\n    connectData = { ...connectData, ...result[1] };\r\n     \r\n      if (connectData['latestAssayType'] !== null){\r\n               if (connectData['latestAssayType'].toLowerCase() === 'self assay') connectData.latestAssayType = 'Boliden assay';\r\n               else if (connectData['latestAssayType'].toLowerCase() === 'counter party assay')\r\n                 connectData.latestAssayType = 'Supplier assay';}\r\n               if (connectData.landingDate === null) {\r\n                 connectData.assayDueDate = null;\r\n               } else {\r\n                 let date = new Date(connectData['landingDate']);\r\n                 if (\r\n                   connectData['productName'].toLowerCase() == 'cu material' ||\r\n                   connectData['productName'].toLowerCase() == 'pm material'\r\n                 ) {\r\n                   date.setDate(date.getDate() + 20);\r\n                 } else if (\r\n                   connectData['qualityName'].toLowerCase() == 'alloys coarse' ||\r\n                   connectData['qualityName'].toLowerCase() == 'alloys coarse iba' ||\r\n                   connectData['qualityName'].toLowerCase() == 'alloys fine' ||\r\n                   connectData['qualityName'].toLowerCase() == 'alloys fine iba' ||\r\n                   connectData['qualityName'].toLowerCase() == 'alloys ingots'\r\n                 ) {\r\n                   date.setDate(date.getDate() + 35);\r\n                 } else {\r\n                   date.setDate(date.getDate() + 42);\r\n                 }\r\n                 var dd = date.getDate();\r\n                 var mm = date.monthName();\r\n                 var y = date.getFullYear();\r\n     if(dd < 10) dd = '0' + dd;\r\n     if(mm < 10) mm = '0' + mm;\r\n                 var formattedDate = dd + '-' + mm + '-' + y;\r\n                 connectData['assayDueDate'] = formattedDate;\r\n               }\r\n             \r\n\r\n    data[\"viewGmr\"] = connectData;\r\n\r\n    data[\"activityLog\"] = result[4];\r\n\r\n    var y = result[2];\r\n    if(Array.isArray(y) && y.length> 0)\r\nfor (var j = 0; j < y.length; j++) {\r\n      y[j][\"id\"] = y[j].documentId;\r\n\t  y[j][\"internalRefNo\"] = intGmrRefNo;\r\n      if(y[j][\"description\"].includes(':-')){\r\n        var typesDesc = y[j][\"description\"].split(\":-\");\r\n        if (typesDesc.length > 0) {\r\n          if (typesDesc[0] === \"packinglist\") y[j][\"types\"] = \"Packing List\";\r\n          else if (typesDesc[0] === \"billoflading\")\r\n            y[j][\"types\"] = \"Bill of Lading\";\r\n          else if (typesDesc[0] === \"proofofdelivery\")\r\n            y[j][\"types\"] = \"Proof of Delivery\";\r\n\t\t  else if (typesDesc[0] === \"annexIB\")\r\n            y[j][\"types\"] = \"Annex IB\";\r\n\t\t  else if (typesDesc[0] === \"annexVII\")\r\n            y[j][\"types\"] = \"Annex VII\";\r\n\t\t  else if (typesDesc[0] === \"photoofMaterial\")\r\n            y[j][\"types\"] = \"Photo of Material\";\r\n\t\t  else if (typesDesc[0] === \"transportDocument\")\r\n            y[j][\"types\"] = \"Transport Document\";\r\n\t\t  else if (typesDesc[0] === \"other\")\r\n            y[j][\"types\"] = \"Other\";\r\n          y[j][\"description\"] = typesDesc[1];\r\n        }\r\n      } \r\n    }\r\n\r\n    data[\"documentList\"] = y;\r\n\r\n    console.log(\"Response - \" + JSON.stringify(data));\r\n    res.status(200).send(data);\r\n  })\r\n  .catch(err => {\r\n    console.log(\"Error Executing Processor -\" + err);\r\n    res.status(500).send(err);\r\n  });",
    "sys__UUID" : "40d8e416-f318-4b58-a621-883f2f1b0f4e"
}