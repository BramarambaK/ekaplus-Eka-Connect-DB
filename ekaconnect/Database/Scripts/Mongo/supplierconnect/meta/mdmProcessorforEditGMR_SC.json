{
    "_id" : "mdmProcessorforEditGMR_SC",
    "name" : "mdmProcessorforEditGMR_SC",
    "type" : "processor",
    "refType" : "app",
    "refTypeId" : "467a28cc-bc93-4e38-8ff5-0a56ae128f3b",
    "snippet" : "\r\n\r\n    req.body.mdmProcessorServiceKey = JSON.parse(req.body.mdmProcessorServiceKey);\r\n    function getDropdown(data) {\r\n      let deleveryItem = data.find(item => item.serviceKey === 'contractQuality')\r\n      deleveryItem = deleveryItem ? deleveryItem.dependsOn[1] :''\r\n      let dependsOnForBusin = data.find(item => item.serviceKey === 'businesspartnercontactpersoncustom')\r\n      dependsOnForBusin = dependsOnForBusin.dependsOn\r\n\r\n      var businesspartnercontactperson = [\r\n        {\r\n          serviceKey: 'businesspartnercontactperson',\r\n          dependsOn: dependsOnForBusin\r\n        },  {\r\n          serviceKey: 'contractQuality',\r\n          dependsOn:[pcdiId,deleveryItem]\r\n        },\r\n        {\r\n          serviceKey: 'incoTermDestination',\r\n          dependsOn: [pcdiId,deleveryItem]\r\n        }\r\n      ];\r\n      var obj = {\r\n        method: 'POST',\r\n        body: businesspartnercontactperson,\r\n        \/\/ url: req.body.propertyList.eka_ctrm_host + '\/mdmapi\/data',\r\n        url: `${req.body.propertyList.eka_mdm_host}\/mdm\/${req.body.appId}\/data`,\r\n        headers: {\r\n          Authorization: req.headers.authorization,\r\n          'Content-Type': 'application\/json',\r\n          'X-TenantID': req.headers['X-TenantID']\r\n        },\r\n        json: true\r\n      };\r\n      console.log('mdm url', obj.url);\r\n      return new Promise(function (resolve, reject) {\r\n        request(obj, function (err, response, body) {\r\n            if(response.statusCode >= 200 && response.statusCode <=299) {\r\n                resolve(body);\r\n            } else {\r\n                reject(body);\r\n            }\r\n        });\r\n      });\r\n    }\r\n    let pcdiId = req.body.selectedData.viewgmrbasic ? req.body.selectedData.viewgmrbasic.pcdiId : \"\"\r\n\r\n    let businesspartnercontactperson =\r\n      req &&\r\n      req.body &&\r\n      req.body.mdmProcessorServiceKey &&\r\n      req.body.mdmProcessorServiceKey.find(item => item.serviceKey === 'businesspartnercontactpersoncustom');\r\n\r\n    let contractQuality =  req &&\r\n    req.body &&\r\n    req.body.mdmProcessorServiceKey &&\r\n    req.body.mdmProcessorServiceKey.find(item => item.serviceKey === 'contractQuality');\r\n\r\n    let incoTermDestination =  req &&\r\n    req.body &&\r\n    req.body.mdmProcessorServiceKey &&\r\n    req.body.mdmProcessorServiceKey.find(item => item.serviceKey === 'incoTermDestination');\r\n\r\n    if (businesspartnercontactperson &&contractQuality &&  incoTermDestination) {\r\n      getDropdown([businesspartnercontactperson,contractQuality,incoTermDestination])\r\n        .then(output => {\r\n          \/\/ material classification addition\r\n          var materialClassification = {\r\n            method: 'POST',\r\n            url:\r\n              req.body.propertyList.eka_connect_host +\r\n              '\/collectionmapper\/467a28cc-bc93-4e38-8ff5-0a56ae128f3b\/c05cacf5-200c-4d97-8e8d-a67329ff286c\/fetchCollectionRecords',\r\n            headers: {\r\n              'Content-Type': 'application\/json',\r\n              'X-TenantID': req.headers['x-tenantid'],\r\n              Authorization: req.headers.authorization,\r\n              ttl: 300\r\n            },\r\n            body: {\r\n              collectionName: 'Approve GMR LOV',\r\n              criteria: {\r\n                filter: [\r\n                  {\r\n                    fieldName: 'Component',\r\n                    value: 'Material Classification',\r\n                    operator: 'eq'\r\n                  }\r\n                ]\r\n              }\r\n            },\r\n            json: true\r\n          };\r\n\r\n          function getMaterialClassification() {\r\n            return new Promise(function(resolve, reject) {\r\n              console.log('Request - ' + materialClassification.url);\r\n              console.log('Payload -' + JSON.stringify(materialClassification));\r\n              request(materialClassification, function(err, response, body) {\r\n                console.log('Request Body - ' + JSON.stringify(body));\r\n                if (response.statusCode >= 200 && response.statusCode <= 299) {\r\n                  console.log('Success');\r\n                  resolve(body);\r\n                } else {\r\n                  console.log(body.error);\r\n                  reject(err || body);\r\n                }\r\n              });\r\n            });\r\n          }\r\n\r\n          getMaterialClassification().then(data => {\r\n            data = data.reduce((acc, item) => {\r\n              acc.push({\r\n                key: item.Value,\r\n                value: item.Value\r\n              });\r\n              return acc;\r\n            }, []);\r\n            \/\/ to patch values from selectedData\r\n            \/\/ if(req.body.selectedData.materialClassification){\r\n            \/\/   data.push({key:req.body.selectedData.materialClassification , value:req.body.selectedData.materialClassification})\r\n            \/\/ }\r\n\r\n          \/\/ material classification addition\r\n          if (output && output.businesspartnercontactperson && output.contractQuality && output.incoTermDestination) {\r\n            return res.status(200).send({\r\n              businesspartnercontactpersoncustom: [\r\n                { key: 'none', value: 'None' },\r\n                ...output.businesspartnercontactperson\r\n              ],\r\n              contractQuality: [\r\n                ...output.contractQuality\r\n              ],\r\n              incoTermDestination: [\r\n                ...output.incoTermDestination\r\n              ],\r\n              materialClassification: [...data] \r\n            });\r\n          }\r\n        })\r\n        })\r\n        .catch(err => res.status(200).send(err));\r\n    } \r\n    else{\r\n      return res.status(200).send({})\r\n    }\r\n  ",
    "sys__UUID" : "1f0a2bec-ea54-4a20-b75e-eb39869c9ee1"
}
