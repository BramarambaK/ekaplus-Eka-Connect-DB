{
    "_id" : "supplierlisting_V2_processor",
    "name" : "supplierlisting_V2",
    "refType" : "app",
    "refTypeId" : "467a28cc-bc93-4e38-8ff5-0a56ae128f3b",
    "snippet" : "\r\n    var moment = require('moment');\r\n    var result = {};\r\n    result.data = req.body.bulkPayLoadData;\r\n    Date.prototype.monthName = function() {\r\n      return this.toUTCString().split(' ')[2];\r\n    };\r\n\r\n    for (var i = 0; i < result.data.length; i++) {\r\n      if (result.data[i].portalCreatedUser) {\r\n        result.data[i].createdBy = result.data[i].portalCreatedUser;\r\n      }\r\n      \/\/ Added for Approval Status\r\n      if(!result.data[i].hasOwnProperty('gmrApprovalStatus')){\r\n        result.data[i]['gmrApprovalStatus'] = \"Approved\"\r\n      }\r\n\r\n      \/\/Added to sort based on GMR Ref\r\n      result.data[i].gmrRefNo_hidden = result.data[i].gmrRefNo.split('-')[1];\r\n\r\n      \/\/Added for contract delivery sort\r\n      let item = result.data[i].deliveryItemRefNo.split('-');\r\n      item[3] = parseInt(item[3].toString().replace('.', ''), 10);\r\n      result.data[i].deliveryItemRefNo_hidden = parseFloat(item[1] + '.' + item[3]);\r\n\r\n      \/\/Added for concatening columns in Destination\r\n      result.data[i].incoLocation_concat = result.data[i].dischargeCity + ',' + result.data[i].dischargeCountry;\r\n\r\n      if (result.data[i].eta) {\r\n        result.data[i].eta = result.data[i].eta ? result.data[i].eta.substring(0, 10) : null;\r\n        result.data[i].shipmentdate = result.data[i].shipmentdate ? result.data[i].shipmentdate.substring(0, 10) : null;\r\n        result.data[i].blDate = result.data[i].blDate ? result.data[i].blDate.substring(0, 10) : null;\r\n        result.data[i].gmrCreatedDate = result.data[i].gmrCreatedDate\r\n          ? result.data[i].gmrCreatedDate.substring(0, 10)\r\n          : null;\r\n        result.data[i].landingDate = result.data[i].landingDate ? result.data[i].landingDate.substring(0, 10) : null;\r\n        result.data[i].invoiceDueDate = result.data[i].invoiceDueDate\r\n          ? result.data[i].invoiceDueDate.substring(0, 10)\r\n          : null;\r\n        result.data[i].gmrDueDate = result.data[i].gmrDueDate ? result.data[i].gmrDueDate.substring(0, 10) : null;\r\n      }\r\n\r\n      \/\/SC-1827 - Provision to search Adviced Deliveries\r\n      if (result.data[i].shipmentdate) {\r\n        var today = moment().format('YYYY-MM-DD');\r\n        var shipmentDate = moment(result.data[i].shipmentdate, 'YYYY-MM-DD');\r\n        var isLoaded = shipmentDate.isSameOrAfter(today);\r\n        result.data[i].isShipmentLoaded = isLoaded ? 'Not Loaded' : 'Loaded';\r\n      }\r\n\r\n      if (result.data[i].latestActivityBy === 'Supplier Portal') {\r\n        result.data[i].updatedBy = result.data[i].portalUpdatedUser;\r\n      }\r\n\r\n      if (result.data[i]['latestAssayType']) {\r\n        if (result.data[i]['latestAssayType'].toLowerCase() === 'self assay')\r\n          result.data[i].latestAssayType = 'Boliden Assay';\r\n        else if (result.data[i]['latestAssayType'].toLowerCase() === 'counterparty assay')\r\n          result.data[i].latestAssayType = 'Supplier Assay';\r\n      }\r\n      if (!result.data[i].landingDate || result.data[i].landingDate == null) {\r\n        result.data[i]['assayDueDate'] = null;\r\n      } else {\r\n        let date = new Date(result.data[i]['landingDate']);\r\n        if (\r\n          result.data[i]['product'] &&\r\n          (result.data[i]['product'].toLowerCase() == 'cu material' ||\r\n            result.data[i]['product'].toLowerCase() == 'pm material')\r\n        ) {\r\n          date.setDate(date.getDate() + 20);\r\n        } else if (\r\n          result.data[i]['qualityName'] &&\r\n          (result.data[i]['qualityName'].toLowerCase() == 'alloys coarse' ||\r\n            result.data[i]['qualityName'].toLowerCase() == 'alloys coarse iba' ||\r\n            result.data[i]['qualityName'].toLowerCase() == 'alloys fine' ||\r\n            result.data[i]['qualityName'].toLowerCase() == 'alloys fine iba' ||\r\n            result.data[i]['qualityName'].toLowerCase() == 'alloys ingots')\r\n        ) {\r\n          date.setDate(date.getDate() + 35);\r\n        } else {\r\n          date.setDate(date.getDate() + 42);\r\n        }\r\n        var dd = date.getDate();\r\n        var mm = date.monthName();\r\n        var y = date.getFullYear();\r\n        if (dd < 10) dd = '0' + dd;\r\n        if (mm < 10) mm = '0' + mm;\r\n        var formattedDate = dd + '-' + mm + '-' + y;\r\n        result.data[i]['assayDueDate'] = formattedDate;\r\n      }\r\n      if (result.data[i]['bolidenAssayAsFinal'] == 'Y') {\r\n        result.data[i]['bolidenAssayAsFinalDisplay'] = 'Yes';\r\n      } else {\r\n        result.data[i]['bolidenAssayAsFinalDisplay'] = 'No';\r\n      }\r\n      if (result.data[i]['markedForUmpire'] == 'Y') {\r\n        result.data[i]['markedForUmpireDisplay'] = 'Yes';\r\n      } else {\r\n        result.data[i]['markedForUmpireDisplay'] = 'No';\r\n      }\r\n      if (result.data[i]['latestAssayType'] == 'Partial Self Assay') {\r\n        result.data[i]['latestAssayType'] = 'Partial Boliden Assay';\r\n      }\r\n    }\r\n    console.log('Response length - ' + result.data.length);\r\n    res.status(200).send(result);\r\n ",
    "sys__UUID" : "b9f57b26-fbb5-4339-b34b-a29a92efda17",
    "type" : "processor"
}