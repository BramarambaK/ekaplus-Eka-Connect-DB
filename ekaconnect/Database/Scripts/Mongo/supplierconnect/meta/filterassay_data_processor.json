{
  "_id": "filterassay_data_processor",
  "name": "filterassay_data_processor",
  "refType": "app",
  "refTypeId": "467a28cc-bc93-4e38-8ff5-0a56ae128f3b",
  "snippet": "var shipment = {\r\n  method: \"POST\",\r\n  url:\r\n    req.body.propertyList.eka_ctrm_host +\r\n    \"/api/logistic/finalAssayContractList\",\r\n  headers: {\r\n    \"Content-Type\": \"application/json\",\r\n    Accept: \"application/json\",\r\n  },\r\n  json: true,\r\n};\r\n// for contract Items dependent on Suppliers\r\nfunction get_shipment(body = {}) {\r\n  shipment[\"body\"] = body;\r\n  return new Promise(function (resolve, reject) {\r\n    console.log(\"Request - \" + shipment.url);\r\n    request(shipment, function (err, response, body) {\r\n      if (response.statusCode === 200) {\r\n        resolve(body);\r\n      } else {\r\n        reject(body);\r\n      }\r\n    });\r\n  });\r\n}\r\nvar connect = {\r\n  method: \"GET\",\r\n  url: req.body.propertyList.eka_connect_host + \"/api/userinfo\",\r\n  headers: {\r\n    Authorization: req.headers.authorization,\r\n    \"X-TenantID\": req.headers[\"x-tenantid\"],\r\n  },\r\n  json: true,\r\n};\r\n\r\nfunction get_userinfo1() {\r\n  return new Promise(function (resolve, reject) {\r\n    console.log(\"Request - \" + connect.url);\r\n    request(connect, function (err, response, body) {\r\n      console.log(\"Response - \" + body);\r\n      if (response.statusCode === 200) {\r\n        console.log(\"Success\");\r\n        // body.businessPartys.sort();\r\n        // irrespective of case\r\n        // body.businessPartys.push(\"acid\",\"desk\",\"grid\")\r\n        body.businessPartys.sort((a, b) =>\r\n          a.localeCompare(b, undefined, { sensitivity: \"base\" })\r\n        );\r\n        resolve(body);\r\n      } else {\r\n        reject(body);\r\n      }\r\n    });\r\n  });\r\n}\r\n\r\n// In case of admin user, all suppliers shown.\r\nvar adminPlatform = {\r\n  method: \"POST\",\r\n  url:\r\n    req.body.propertyList.eka_connect_host +\r\n    \"/collectionmapper/467a28cc-bc93-4e38-8ff5-0a56ae128f3b/User_Info/fetchCollectionRecords\",\r\n  headers: {\r\n    Authorization: req.headers.authorization,\r\n    \"X-TenantID\": req.headers[\"x-tenantid\"],\r\n    \"Content-Type\": \"application/json\",\r\n    ttl: 0,\r\n  },\r\n  body: {\r\n    collectionName: \"Business Partners\",\r\n    getAllRecords: true,\r\n  },\r\n  json: true,\r\n};\r\n\r\nfunction getadminData() {\r\n  return new Promise(function (resolve, reject) {\r\n    console.log(\"Request - \" + adminPlatform.url);\r\n    request(adminPlatform, function (err, response, body) {\r\n      console.log(\"Response - \" + body);\r\n      if (response.statusCode === 200) {\r\n        console.log(\"Success\");\r\n        // body.sort((a, b) => (a['BP Name'] > b['BP Name']) ? 1 : -1);\r\n        // irrespective of case\r\n        body.sort((a, b) =>\r\n          a[\"BP Name\"].toLowerCase().localeCompare(b[\"BP Name\"].toLowerCase())\r\n        );\r\n        console.log(\"body sort\", body);\r\n        resolve(body);\r\n      } else {\r\n        reject(body);\r\n      }\r\n    });\r\n  });\r\n}\r\nif (\r\n  req &&\r\n  req.body &&\r\n  req.body.selectedData &&\r\n  req.body.selectedData.contractItem\r\n) {\r\n  var output = {};\r\n  output.supplier = \"\";\r\n  output.supplier = req.body.selectedData.supplier;\r\n  output.dropdownValuesupplier = \"\";\r\n  output.dropdownValuesupplier = req.body.selectedData.dropdownValuesupplier;\r\n  output.contractItem = \"\";\r\n  output.contractItem = req.body.selectedData.contractItem;\r\n  output.dropdownValueContract = \"\";\r\n  output.dropdownValueContract = req.body.selectedData.dropdownValueContract;\r\n  res.status(200).send(output);\r\n} else {\r\n  getadminData()\r\n    .then((adminData) => {\r\n      get_userinfo1()\r\n        .then((userinfo) => {\r\n          var output = {};\r\n          if (userinfo.userType == 3) {\r\n            output.supplier = \"\";\r\n            output.supplier = userinfo.businessPartys[0];\r\n            output.dropdownValuesupplier = \"\";\r\n            output.dropdownValuesupplier = userinfo.businessPartys[0];\r\n          } else {\r\n            output.supplier = \"\";\r\n            output.supplier = adminData[0][\"BP Name\"];\r\n            output.dropdownValuesupplier = \"\";\r\n            output.dropdownValuesupplier = adminData[0][\"BP Name\"];\r\n          }\r\n          let shipmentBody = {};\r\n          shipmentBody = { cpName: output.supplier };\r\n          get_shipment(shipmentBody)\r\n            .then((shipmentData) => {\r\n              if (shipmentData.length > 0) {\r\n                output.contractItem = \"\";\r\n                output.contractItem = shipmentData[0];\r\n                output.dropdownValueContract = \"\";\r\n                output.dropdownValueContract = shipmentData[0];\r\n              }\r\n              res.status(200).send(output);\r\n            })\r\n            .catch((err) => {\r\n              res.status(500).send(err);\r\n            });\r\n        })\r\n        .catch((err) => {\r\n          res.status(500).send(err);\r\n        });\r\n    })\r\n    .catch((err) => {\r\n      res.status(500).send(err);\r\n    });\r\n}\r\n",
  "sys__UUID": "82dcafb5-1406-4af8-851e-f669275cb200",
  "type": "processor"
}
