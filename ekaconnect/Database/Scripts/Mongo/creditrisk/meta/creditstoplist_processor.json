{
    "_id": "processor_creditstoplist",
    "name": "creditstoplist",
    "type": "processor",
    "refType": "app",
    "refTypeId": "5539617b-5075-4482-8bcc-26f76849eb89",
    "snippet": "  var start = req.body.queryParams.start ? parseInt(req.body.queryParams.start) : 0;\r\n    var end = req.body.queryParams.limit ? parseInt(req.body.queryParams.limit) : 100000;\r\n    var connectUrl = req.body.propertyList.eka_connect_host + '\/workflow\/data';\r\n    var columnMapping = req.body.propertyList.creditrisk_creditstop_collection_object_column_mapping;\r\n    \/\/ var platformUrl =\r\n    \/\/   req.body.propertyList.platform_url +\r\n    \/\/   '\/collection\/v1?collectionName=' +\r\n    \/\/   req.body.propertyList.creditrisk_creditstop_collection_name +\r\n    \/\/   '&limit=' +\r\n    \/\/   end +\r\n    \/\/   '&start=' +\r\n    \/\/   start;\r\n    var platformUrl =\r\n      req.body.propertyList.eka_connect_host +\r\n      '\/collectionmapper\/' +\r\n      req.body.appId +\r\n      '\/26a63eb4-79f9-4585-ab6a-6633fd19b8ea\/fetchCollectionRecords';\r\n    var platformBody = null;\r\n    var connectQueryParams = null;\r\n    var connectBody = {\r\n      appId: req.body.appId,\r\n      workFlowTask: 'creditstoplistConnect'\r\n    };\r\n    var filterarr = [];\r\n    if (req.body.filterData && req.body.filterData.filter) {\r\n      connectBody.filterData = req.body.filterData;\r\n      for (let i = 0; i < req.body.filterData.filter.length; i++) {\r\n        let filterObj = req.body.filterData.filter[i];\r\n        var obj = {};\r\n        obj['fieldName'] = columnMapping.hasOwnProperty(filterObj['fieldName'])\r\n          ? columnMapping[filterObj['fieldName']]\r\n          : filterObj['fieldName'];\r\n        obj['operator'] = filterObj['operator'];\r\n        obj['value'] = filterObj['value'];\r\n        if (obj['operator'] == 'in') obj['value'] = filterObj['value'].toString();\r\n        filterarr.push(obj);\r\n      }\r\n      platformBody = {\r\n        criteria: { filter: filterarr },\r\n        collectionName: req.body.propertyList.creditrisk_creditstop_collection_name,\r\n        start: start,\r\n        limit: end\r\n      };\r\n      console.log('platform Filter ::' + JSON.stringify(platformBody));\r\n    } else {\r\n      platformBody = {\r\n        collectionName: req.body.propertyList.creditrisk_creditstop_collection_name,\r\n        start: start,\r\n        limit: end\r\n      };\r\n    }\r\n    var collection = {\r\n      method: 'POST',\r\n      url: platformUrl,\r\n      body: platformBody,\r\n      headers: {\r\n        Authorization: req.headers.authorization,\r\n        'Content-Type': 'application\/json',\r\n        ttl: 300,\r\n        'X-TenantID': req.headers['x-tenantid']\r\n      },\r\n      json: true\r\n    };\r\n    var connect = {\r\n      method: 'POST',\r\n      url: connectUrl,\r\n      body: connectBody,\r\n      headers: {\r\n        Authorization: req.headers.authorization,\r\n        'X-TenantID': req.headers['x-tenantid']\r\n      },\r\n      json: true\r\n    };\r\n    function get_collection() {\r\n      return new Promise(function(resolve, reject) {\r\n        console.log('Request - ' + collection.url);\r\n        request(collection, function(err, response, body) {\r\n          body = JSON.parse(JSON.stringify(body));\r\n          console.log('Response - success ');\r\n          if (err || body.error) reject(body);\r\n          else {\r\n            console.log('Success');\r\n            resolve(body);\r\n          }\r\n        });\r\n      });\r\n    }\r\n    function get_connect() {\r\n      return new Promise(function(resolve, reject) {\r\n        console.log('Request - ' + connect.url);\r\n        request(connect, function(err, response, body) {\r\n          console.log('Response - success');\r\n          if (err || body.error) reject(body);\r\n          else {\r\n            console.log('Success');\r\n            resolve(body);\r\n          }\r\n        });\r\n      });\r\n    }\r\n\r\n    get_collection().then(function(result) {\r\n      var collection = result;\r\n      var mergedData = [];\r\n      var keyVals = req.body.propertyList.creditrisk_creditstop_collection_object_column_mapping;\r\n      collection = JSON.stringify(collection);\r\n      var connectKeys = Object.keys(keyVals);\r\n      for (var i = 0; i < connectKeys.length; i++) {\r\n        collection = collection.split('\"' + keyVals[connectKeys[i]] + '\"').join('\"' + connectKeys[i] + '\"');\r\n      }\r\n      collection = JSON.parse(collection);\r\n      get_connect()\r\n        .then(function(result1) {\r\n          var connect = result1.data;\r\n          for (var i = 0; i < collection.length; i++) {\r\n            collection[i]['eligible'] = true;\r\n            collection[i]['declared'] = true;\r\n            collection[i]['overdue'] = false;\r\n          }\r\n          if (connect.length === 0) {\r\n            \/\/ break;\r\n          } else {\r\n            for (var i = 0; i < collection.length; i++) {\r\n              for (var j = 0; j < connect.length; j++) {\r\n                if (\r\n                  collection[i].counterpartyGroup === connect[j].counterpartyGroup &&\r\n                  collection[i].invoiceRefNo === connect[j].invoiceRefNo\r\n                )\r\n                  for (var key in connect) {\r\n                    collection[key] = { ...collection[key], ...connect[key] };\r\n                  }\r\n              }\r\n            }\r\n          }\r\n\r\n          res.status(200).send(collection);\r\n        })\r\n        .catch(function(err) {\r\n          res.status(500).send(err);\r\n        });\r\n    });",
    "sys__UUID": "8ff94f3e-9952-423e-be81-40b88895a2ae",
    "sys__createdOn": ISODate("2019-05-22T12:27:26.689Z"),
    "sys__createdBy": "srini@ekaplus.com"
}