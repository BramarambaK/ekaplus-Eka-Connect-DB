{
    "_id" : ObjectId("5d1c48220dd90a09def1c715"),
    "name" : "MarginData_Lisitng_processor",
    "type" : "processor",
    "refType" : "app",
    "version":"V2",
    "refTypeId" : "40a27e7f-3f50-406f-a872-2ee7d9436df9",
    "snippet" : "\r\n    var connectData = {\r\n      method: 'GET',\r\n      url:\r\n        req.body.propertyList.eka_connect_host +\r\n        '/data/40a27e7f-3f50-406f-a872-2ee7d9436df9/3ef370f9-febe-41a0-8e43-4ef6ce769b3b',\r\n      headers: {\r\n        Authorization: req.headers.authorization,\r\n        'X-TenantID': req.headers['x-tenantid'],\r\n        json: true\r\n      }\r\n    };\r\n\r\n    var start = req.body.queryParams.start ? parseInt(req.body.queryParams.start) : 0;\r\n    var end = req.body.queryParams.limit ? parseInt(req.body.queryParams.limit) : 10000;\r\n    var allocation_group_header = {\r\n      method: 'POST',\r\n      url:\r\n        req.body.propertyList.eka_connect_host +\r\n        '/collectionmapper/40a27e7f-3f50-406f-a872-2ee7d9436df9/3ef370f9-febe-41a0-8e43-4ef6ce769b3b/fetchCollectionRecords',\r\n\r\n      headers: {\r\n        Authorization: req.headers.authorization,\r\n        'X-TenantID': req.headers['x-tenantid'],\r\n\r\n        'Content-Type': 'application/json',\r\n        ttl: 300\r\n      },\r\n      body: {\r\n        collectionName: 'AllocationGroupHeader',\r\n        start: start,\r\n        limit: end\r\n      },\r\n      json: true\r\n    };\r\n\r\n    var connectDataActualMargin = {\r\n      method: 'GET',\r\n      url:\r\n        req.body.propertyList.eka_connect_host +\r\n        '/data/40a27e7f-3f50-406f-a872-2ee7d9436df9/a094c021-4870-4b9c-940e-3858e2405e9e',\r\n      headers: {\r\n        Authorization: req.headers.authorization,\r\n        'X-TenantID': req.headers['x-tenantid'],\r\n        json: true\r\n      }\r\n    };\r\n\r\n    function get_connectDataActualMargin() {\r\n      return new Promise(function(resolve, reject) {\r\n        // console.log('Request - ' + connectData.url);\r\n        //console.log('Payload -' + JSON.stringify(connectData));\r\n        request(connectDataActualMargin, function(err, response, body) {\r\n          //  console.log('Response - ' + body);\r\n          if (err || body.error) reject(body);\r\n          else {\r\n            resolve(body);\r\n          }\r\n        });\r\n      });\r\n    }\r\n\r\n    function get_header() {\r\n      return new Promise(function(resolve, reject) {\r\n        //console.log('Request - ' + allocation_group_header.url);\r\n\r\n        //console.log('Payload -' + JSON.stringify(allocation_group_header));\r\n        request(allocation_group_header, function(err, response, body) {\r\n          //  console.log('Response - ' + body);\r\n\r\n          if (body.message === '403 Forbidden') reject(body);\r\n          if (err || body.error) reject(body);\r\n          else {\r\n            resolve(body);\r\n          }\r\n        });\r\n      });\r\n    }\r\n\r\n    function get_connectData() {\r\n      return new Promise(function(resolve, reject) {\r\n        // console.log('Request - ' + connectData.url);\r\n        //console.log('Payload -' + JSON.stringify(connectData));\r\n        request(connectData, function(err, response, body) {\r\n          //  console.log('Response - ' + body);\r\n          if (err || body.error) reject(body);\r\n          else {\r\n            resolve(body);\r\n          }\r\n        });\r\n      });\r\n    }\r\n    var result = [];\r\n    var collectiontime = 0;\r\n    var listingtime = 0;\r\n\r\n    var timeInMss1 = new Date().getTime();\r\n    get_header().then(result1 => {\r\n      var resultn = { data: result1 };\r\n      result.push(resultn);\r\n      var timeInMss2 = new Date().getTime();\r\n      collectiontime = collectiontime + timeInMss2 - timeInMss1;\r\n      timeInMss1 = new Date().getTime();\r\n      get_connectData().then(result2 => {\r\n        result.push(result2);\r\n\r\n        timeInMss2 = new Date().getTime();\r\n        collectiontime = collectiontime + timeInMss2 - timeInMss1;\r\n        timeInMss1 = new Date().getTime();\r\n        get_connectDataActualMargin().then(result6 => {\r\n          result.push(result6);\r\n          //  result[0] = JSON.parse(result[0]);\r\n          result[1] = JSON.parse(result[1]);\r\n          result[2] = JSON.parse(result[2]);\r\n          //error handling\r\n          if (result[0].data.length == 0) {\r\n       error('Unable to get data from Allocation Header',500);    \r\n          } else if (result[1].message == '400 Bad Request' || result[1].message == '404 Not Found') {\r\n             error('Unable to get data from Connect Saved data',500);\r\n          } else {\r\n            //  result[2] = JSON.parse(result[2]);\r\n\r\n            let response = [];\r\n            let uniqueno = 0;\r\n\r\n            var keyVals = req.body.propertyList.margin_collection_object_column_mapping;\r\n            var collection = JSON.stringify(result);\r\n\r\n            var connectKeys = Object.keys(keyVals);\r\n\r\n            for (var i = 0; i < connectKeys.length; i++) {\r\n              collection = collection.split(keyVals[connectKeys[i]]).join(connectKeys[i]);\r\n            }\r\n            result = JSON.parse(collection);\r\n\r\n            var status;\r\n            var actualmargindata;\r\n            var actualmarginvalue;\r\n            var actualmarginsysuuid;\r\n            if (result[0].data.length) {\r\n              for (var i = 0; i < result[0].data.length; i++) {\r\n                //quantity released\r\n                if (result[0].data[i]['QUANTITY RELEASED']) {\r\n                  if (result[0].data[i]['QUANTITY RELEASED'] > 0) {\r\n                    status = 'Progress';\r\n                  }\r\n                } else {\r\n                  status = 'Open';\r\n                }\r\n                // for (let k = 0; k < result[2].data.length; k++) {\r\n                //   if (\r\n                //     result[0].data[i]['INT ALLOC GROUP ID'] == result[2].data[k]['INT ALLOC GROUP ID'] &&\r\n                //     result[0].data[i]['PRODUCT SPECS'] == result[2].data[k]['PRODUCT SPECS'] &&\r\n                //     result[0].data[i]['INTERNAL CONTRACT REF NO'] == result[2].data[k]['INTERNAL CONTRACT REF NO']\r\n                //   ) {\r\n                //     result[0].data[i]['PROFIT CENTER NAME'] = result[2].data[k]['PROFIT CENTER NAME'];\r\n                //   }\r\n                // }\r\n                result[0].data[i]['PROFIT CENTER NAME'] = result[0].data[i]['PROFIT CENTER'];\r\n                for (var k = 0; k < result[2].length; k++) {\r\n                  if (\r\n                    result[0].data[i]['INT ALLOC GROUP ID'] == result[2][k]['INT ALLOC GROUP ID'] &&\r\n                    result[0].data[i]['PRODUCT SPECS'] == result[2][k]['PRODUCT SPECS'] &&\r\n                    result[0].data[i]['CONTRACT ITEM NO'] == result[2][k]['CONTRACT ITEM NO']\r\n                  ) {\r\n                    actualmargindata = result[2][k]['actualmargindata'];\r\n                    actualmarginvalue = result[2][k]['actualmargin'];\r\n                    actualmarginsysuuid = result[2][k]['sys__UUID'];\r\n                    break;\r\n                  } else {\r\n                    actualmargindata = '-';\r\n                    actualmarginvalue = '-';\r\n                    actualmarginsysuuid = '-';\r\n                  }\r\n                }\r\n                if (result[2].length == 0) {\r\n                  actualmargindata = '-';\r\n                  actualmarginvalue = '-';\r\n                  actualmarginsysuuid = '-';\r\n                }\r\n                if (result[1].length == 0) {\r\n                  var data = {\r\n                    ...result[0].data[i],\r\n                    ...{\r\n                      budgetmargin: '-',\r\n                      time: '',\r\n                      cpname: result[0].data[i]['CP NAME'],\r\n                      quantityr: result[0].data[i]['RELEASED QTY'],\r\n                      actualmargin: actualmarginvalue,\r\n                      EXECUTION_STATUS: status,\r\n                      status: 'Active',\r\n                      uniqueno: uniqueno,\r\n                      margin: 'budget',\r\n                      refTypeId: '40a27e7f-3f50-406f-a872-2ee7d9436df9',\r\n                      actualmargindata: actualmargindata,\r\n                      fxrefno: '-',\r\n\r\n                      actualmarginsysuuid: actualmarginsysuuid\r\n                    }\r\n                  };\r\n\r\n                  response.push(data);\r\n                  uniqueno++;\r\n                } else {\r\n                  for (var j = 0; j < result[1].length; j++) {\r\n                    if (\r\n                      result[0].data[i]['INT ALLOC GROUP ID'] == result[1][j]['INT ALLOC GROUP ID'] &&\r\n                      result[0].data[i]['PRODUCT SPECS'] == result[1][j]['PRODUCT SPECS'] &&\r\n                      result[0].data[i]['CONTRACT ITEM NO'] == result[1][j]['CONTRACT ITEM NO']\r\n                    ) {\r\n                      if (result[1][j].fxrefno) {\r\n                        var fxr = result[1][j].fxrefno;\r\n                      } else {\r\n                        fxr = '-';\r\n                      }\r\n                      if (result[1][j]['status'] == 'Active') {\r\n                        var data = {\r\n                          ...result[0].data[i],\r\n                          ...{\r\n                            budgetmargin: result[1][j].budgetmargin,\r\n                            time: result[1][j].sys__updatedOn\r\n                              ? result[1][j].sys__updatedOn\r\n                              : result[1][j].sys__createdOn,\r\n                            quantityr: result[0].data[i]['RELEASED QTY'],\r\n                            actualmargin: actualmarginvalue,\r\n                            cpname: result[0].data[i]['CP NAME'],\r\n                            margindata: result[1][j].margindata,\r\n                            status: 'Active',\r\n                            EXECUTION_STATUS: status,\r\n                            margin: 'budget',\r\n                            refTypeId: '40a27e7f-3f50-406f-a872-2ee7d9436df9',\r\n                            sys__UUID: result[1][j].sys__UUID,\r\n                            uniqueno: uniqueno,\r\n                            actualmargindata: actualmargindata,\r\n                            fxrefno: fxr,\r\n                            statusremark: result[1][j].statusremark,\r\n                            actualmarginsysuuid: actualmarginsysuuid\r\n                          }\r\n                        };\r\n\r\n                        response.push(data);\r\n                      } else if (result[1][j]['status'] == '-' && result[1][j]['budgetmargin'] != 0) {\r\n                        var data = {\r\n                          ...result[0].data[i],\r\n                          ...{\r\n                            budgetmargin: result[1][j].budgetmargin,\r\n                            time: result[1][j].sys__updatedOn\r\n                              ? result[1][j].sys__updatedOn\r\n                              : result[1][j].sys__createdOn,\r\n\r\n                            quantityr: result[0].data[i]['RELEASED QTY'],\r\n                            actualmargin: actualmarginvalue,\r\n                            margindata: result[1][j].margindata,\r\n                            status: 'Active',\r\n                            EXECUTION_STATUS: status,\r\n                            margin: 'budget',\r\n                            refTypeId: '40a27e7f-3f50-406f-a872-2ee7d9436df9',\r\n                            sys__UUID: result[1][j].sys__UUID,\r\n                            uniqueno: uniqueno,\r\n                            actualmargindata: actualmargindata,\r\n                            fxrefno: fxr,\r\n                            statusremark: result[1][j].statusremark,\r\n                            actualmarginsysuuid: actualmarginsysuuid\r\n                          }\r\n                        };\r\n\r\n                        response.push(data);\r\n                      } else if (result[1][j]['status'] == '-') {\r\n                        var data = {\r\n                          ...result[0].data[i],\r\n                          ...{\r\n                            budgetmargin: result[1][j].budgetmargin,\r\n                            time: result[1][j].sys__updatedOn\r\n                              ? result[1][j].sys__updatedOn\r\n                              : result[1][j].sys__createdOn,\r\n\r\n                            quantityr: result[0].data[i]['RELEASED QTY'],\r\n                            actualmargin: actualmarginvalue,\r\n                            cpname: result[0].data[i]['CP NAME'],\r\n                            margindata: result[1][j].margindata,\r\n                            status: 'Active',\r\n                            EXECUTION_STATUS: status,\r\n                            margin: 'budget',\r\n                            refTypeId: '40a27e7f-3f50-406f-a872-2ee7d9436df9',\r\n                            sys__UUID: result[1][j].sys__UUID,\r\n                            uniqueno: uniqueno,\r\n                            actualmargindata: actualmargindata,\r\n                            fxrefno: fxr,\r\n                            statusremark: result[1][j].statusremark,\r\n                            actualmarginsysuuid: actualmarginsysuuid\r\n                          }\r\n                        };\r\n\r\n                        response.push(data);\r\n                      } else if (result[1][j]['status'] == 'Failed') {\r\n                        var data = {\r\n                          ...result[0].data[i],\r\n                          ...{\r\n                            budgetmargin: result[1][j].budgetmargin,\r\n                            time: result[1][j].sys__updatedOn\r\n                              ? result[1][j].sys__updatedOn\r\n                              : result[1][j].sys__createdOn,\r\n\r\n                            quantityr: result[0].data[i]['RELEASED QTY'],\r\n                            actualmargin: actualmarginvalue,\r\n                            cpname: result[0].data[i]['CP NAME'],\r\n                            margindata: result[1][j].margindata,\r\n                            status: 'Failed',\r\n                            EXECUTION_STATUS: status,\r\n                            margin: 'budget',\r\n                            refTypeId: '40a27e7f-3f50-406f-a872-2ee7d9436df9',\r\n                            sys__UUID: result[1][j].sys__UUID,\r\n                            uniqueno: uniqueno,\r\n                            actualmargindata: actualmargindata,\r\n                            fxrefno: fxr,\r\n                            statusremark: result[1][j].statusremark,\r\n                            actualmarginsysuuid: actualmarginsysuuid\r\n                          }\r\n                        };\r\n\r\n                        response.push(data);\r\n                      } else if (result[1][j]['status'] == 'Closing') {\r\n                        var data = {\r\n                          ...result[0].data[i],\r\n                          ...{\r\n                            budgetmargin: result[1][j].budgetmargin,\r\n                            time: result[1][j].sys__updatedOn\r\n                              ? result[1][j].sys__updatedOn\r\n                              : result[1][j].sys__createdOn,\r\n\r\n                            quantityr: result[0].data[i]['RELEASED QTY'],\r\n                            actualmargin: actualmarginvalue,\r\n                            cpname: result[0].data[i]['CP NAME'],\r\n                            margindata: result[1][j].margindata,\r\n                            status: 'Closing',\r\n                            EXECUTION_STATUS: status,\r\n                            margin: 'budget',\r\n                            refTypeId: '40a27e7f-3f50-406f-a872-2ee7d9436df9',\r\n                            sys__UUID: result[1][j].sys__UUID,\r\n                            uniqueno: uniqueno,\r\n                            statusremark: result[1][j].statusremark,\r\n                            actualmargindata: actualmargindata,\r\n                            fxrefno: fxr,\r\n                            actualmarginsysuuid: actualmarginsysuuid\r\n                          }\r\n                        };\r\n\r\n                        response.push(data);\r\n                      } else {\r\n                        var data1 = {\r\n                          ...result[0].data[i],\r\n                          ...{\r\n                            budgetmargin: result[1][j].budgetmargin,\r\n                            time: result[1][j].sys__updatedOn\r\n                              ? result[1][j].sys__updatedOn\r\n                              : result[1][j].sys__createdOn,\r\n\r\n                            quantityr: result[0].data[i]['RELEASED QTY'],\r\n                            margindata: result[1][j].margindata,\r\n                            actualmargin: actualmarginvalue,\r\n                            status: 'Closed',\r\n                            statusremark: result[1][j].statusremark,\r\n                            EXECUTION_STATUS: status,\r\n                            cpname: result[0].data[i]['CP NAME'],\r\n                            refTypeId: '40a27e7f-3f50-406f-a872-2ee7d9436df9',\r\n                            sys__UUID: result[1][j].sys__UUID,\r\n                            uniqueno: uniqueno,\r\n                            actualmargindata: actualmargindata,\r\n                            fxrefno: fxr,\r\n                            actualmarginsysuuid: actualmarginsysuuid\r\n                          }\r\n                        };\r\n\r\n                        response.push(data1);\r\n                      }\r\n                      uniqueno++;\r\n                      break;\r\n                    }\r\n                    if (j == result[1].length - 1) {\r\n                      var data = {\r\n                        ...result[0].data[i],\r\n                        ...{\r\n                          budgetmargin: '-',\r\n                          time: '',\r\n                          quantityr: result[0].data[i]['RELEASED QTY'],\r\n                          actualmargin: actualmarginvalue,\r\n                          cpname: result[0].data[i]['CP NAME'],\r\n                          status: 'Active',\r\n                          margin: 'budget',\r\n                          EXECUTION_STATUS: status,\r\n                          uniqueno: uniqueno,\r\n\r\n                          refTypeId: '40a27e7f-3f50-406f-a872-2ee7d9436df9',\r\n                          actualmargindata: actualmargindata,\r\n                          fxrefno: '-',\r\n                          actualmarginsysuuid: actualmarginsysuuid\r\n                        }\r\n                      };\r\n\r\n                      response.push(data);\r\n                      uniqueno++;\r\n                      break;\r\n                    }\r\n                  }\r\n                }\r\n              }\r\n            } else {\r\n           error('Unable to get data from Allocation Header',500);  \r\n            }\r\n\r\n            //console.log('Response - ' + JSON.stringify(response));debugger;\r\n    success(response,200);        \r\n            timeInMss2 = new Date().getTime();\r\n            listingtime = timeInMss2 - timeInMss1;\r\n            console.log('Collection time ' + collectiontime / 1000 + ' s');\r\n            console.log('Listing time' + listingtime / 1000 + ' s');\r\n          }\r\n        });\r\n      });\r\n    });\r\n    // .catch(function(err) {\r\n    //   console.log('Error Executing Processor -' + err);\r\n    // error(err,500); \r\n    // });\r\n    ",
    "sys__createdOn" : ISODate("2019-05-26T09:52:10.548Z"),
    "sys__UUID" : "99482286-6030-4c40-b1ec-3fd7522b688e",
    "sys__createdBy" : "admin@ekaplus.com"
}