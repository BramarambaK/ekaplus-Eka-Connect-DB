{
    "_id" : "affiliateMdmProcessorKey",
    "name" : "mdmProcessorKey",
    "type" : "processor",
    "refType" : "app",
    "refTypeId" : "40a27e7f-3f50-406f-a872-2ee7d9436df9",
    "version":"V2",
    "snippet" : "\r\n    var affiliateMargin = {\r\n      method: 'POST',\r\n      url: req.body.propertyList.eka_connect_host + '/collectionmapper/40a27e7f-3f50-406f-a872-2ee7d9436df9/3ef370f9-febe-41a0-8e43-4ef6ce769b3b/fetchCollectionRecords',\r\n      headers: {\r\n        Authorization: req.headers.authorization,\r\n        'X-TenantID': req.headers['x-tenantid'],\r\n        'Content-Type': 'application/json',\r\n        'ttl': 300\r\n      },\r\n      body: {\r\n        collectionName: \"affiliateMarginShare\",\r\n      },\r\n      json: true\r\n    };\r\n\r\n    var deafultTradeMargin = {\r\n      method: 'POST',\r\n      url: req.body.propertyList.eka_connect_host + '/collectionmapper/40a27e7f-3f50-406f-a872-2ee7d9436df9/3ef370f9-febe-41a0-8e43-4ef6ce769b3b/fetchCollectionRecords',\r\n      headers: {\r\n        Authorization: req.headers.authorization,\r\n        'X-TenantID': req.headers['x-tenantid'],\r\n        'Content-Type': 'application/json',\r\n        'ttl': 300\r\n      },\r\n      body: {\r\n        collectionName: \"DefaultTradeMargin\",\r\n      },\r\n      json: true\r\n    };\r\n    function defaultTradeMargin() {\r\n      return new Promise(function(resolve, reject) {\r\n        // console.log('Request - ' + sales_estimates.url);\r\n        request(deafultTradeMargin, function(err, response, body) {\r\n          // console.log('Response - ' + JSON.stringify(body));\r\n          if (err || body.error) reject(body);\r\n          else {\r\n            // console.log('Success');\r\n            resolve(body);\r\n          }\r\n        });\r\n      });\r\n    }\r\n    function affiliatemargin() {\r\n      return new Promise(function(resolve, reject) {\r\n        // console.log('Request - ' + sales_estimates.url);\r\n        request(affiliateMargin, function(err, response, body) {\r\n          // console.log('Response - ' + JSON.stringify(body));\r\n          if (err || body.error) reject(body);\r\n          else {\r\n            // console.log('Success');\r\n            resolve(body);\r\n          }\r\n        });\r\n      });\r\n    }\r\n\r\n    var affiliateMarginDropdown = [];\r\n    var result = [];\r\n    var defaultMargin = [];\r\n    var compositeData;\r\n    affiliatemargin().then(data9 => {\r\n      var datanew={\r\n        data:data9\r\n      }\r\n      affiliateMarginDropdown.push(datanew);\r\n      defaultTradeMargin().then(data1 => {\r\n        var datanew={\r\n          data:data1\r\n        }\r\n        defaultMargin.push(datanew);\r\n\r\n        result[0] = {\r\n          data: [req.body.selectedData]\r\n        };\r\n        if (\r\n          affiliateMarginDropdown[0].data.length ==0\r\n        ) {\r\n      error('Unable to get data from Affiliate Margin for affiliate shares',500);   \r\n        } else if (defaultMargin[0].data.length==0) {\r\n           error('Unable to get data from Default Margin for affiliate shares',500);\r\n        } else {\r\n          req.body.mdmProcessorServiceKey = JSON.parse(req.body.mdmProcessorServiceKey);\r\n          var mdmData1 = {};\r\n          var affiliatedropdowns = [];\r\n          var affiliatepercentage;\r\n          if (req.body.selectedData.compositeView) {\r\n            compositeData = req.body.selectedData.compositeView;\r\n          } else {\r\n            compositeData = req.body.selectedData.compositeViewInterestEdit;\r\n          }\r\n         \r\n          if (\r\n            req.body &&\r\n            req.body.mdmProcessorServiceKey &&\r\n            req.body.mdmProcessorServiceKey[0] &&\r\n            req.body.mdmProcessorServiceKey[0].dependsOn &&\r\n            req.body.mdmProcessorServiceKey[0].dependsOn[0]\r\n          ) {\r\n            if (\r\n              req.body.selectedData.margindata &&\r\n              req.body.selectedData.margindata.shares.shares == req.body.mdmProcessorServiceKey[0].dependsOn[0]\r\n            ) {\r\n              affiliatepercentage = req.body.selectedData.margindata.shares.sharepercentage;\r\n            } else {\r\n              for (let u = 0; u < affiliateMarginDropdown[0].data.length; u++) {\r\n                if (req.body.mdmProcessorServiceKey[0].dependsOn[0] == affiliateMarginDropdown[0].data[u].Affiliate) {\r\n                  affiliatepercentage = affiliateMarginDropdown[0].data[u]['Margin Share %'];\r\n                  break;\r\n                } else if (\r\n                  req.body.mdmProcessorServiceKey[0].dependsOn[0] == affiliateMarginDropdown[0].data[u].Affiliate &&\r\n                  result[0].data[0]['PRODUCT DESC'] == affiliateMarginDropdown[0].data[u].Product\r\n                ) {\r\n                  affiliatepercentage = affiliateMarginDropdown[0].data[u]['Margin Share %'];\r\n                  break;\r\n                } else {\r\n                  affiliatepercentage = parseFloat(defaultMargin[0].data[1].Value);\r\n                }\r\n              }\r\n            }\r\n            mdmData1 = {\r\n              sharepercentage: affiliatepercentage\r\n            };\r\n     success(mdmData1,200);      \r\n          } else if (result[0].data[0]['BROKER NAME'] != '' && result[0].data[0]['BROKER NAME']) {\r\n            mdmData1 = {\r\n              shares: [\r\n                {\r\n                  key: result[0].data[0]['BROKER NAME'],\r\n                  value: result[0].data[0]['BROKER NAME']\r\n                }\r\n              ]\r\n              // sharepercentage: { value: parseFloat(defaultMargin[0].data[1].Value), disable: false }\r\n            };\r\n            success(mdmData1,200);\r\n          } else {\r\n            for (let u = 0; u < affiliateMarginDropdown[0].data.length; u++) {\r\n              if (affiliateMarginDropdown[0].data[u].Product == result[0].data[0]['PRODUCT DESC']) {\r\n                affiliatedropdowns.push({\r\n                  key: affiliateMarginDropdown[0].data[u]['Affiliate'],\r\n                  value: affiliateMarginDropdown[0].data[u]['Affiliate']\r\n                });\r\n              }\r\n              mdmData1 = {\r\n                shares: affiliatedropdowns\r\n              };\r\n              // mdmData1 = { shares: affiliatedropdowns, sharepercentage: affiliatepercentage };\r\n            }\r\n            if (mdmData1.shares.length == 0) {\r\n              mdmData1 = {\r\n                shares: [{ key: 'Default Value', value: 'Default Value' }],\r\n                sharepercentage: parseFloat(defaultMargin[0].data[1].Value)\r\n              };\r\n            }\r\n   success(mdmData1,200);       \r\n          }\r\n        }\r\n      });\r\n    });\r\n     ",
    "sys__createdOn" : ISODate("2019-06-03T13:38:13.102Z"),
    "sys__UUID" : "03375fe9-5ce8-4419-a2fa-c4cfe55ff499",
    "sys__createdBy" : "admin@ekaplus.com"
}