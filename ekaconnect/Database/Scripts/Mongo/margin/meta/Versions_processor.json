{
    "_id" : ObjectId("5d19ddea0dd90a09def08cd0"),
    "name" : "Versions_processor",
    "type" : "processor",
    "refType" : "app",
    "version" : "V2",
    "refTypeId" : "40a27e7f-3f50-406f-a872-2ee7d9436df9",
    "snippet" : "\r\n    if (req.body.selectedData) {\r\n      var sel = req.body.selectedData.sys__UUID;\r\n      if (req.body.selectedData.compositeViewactualmargin) {\r\n        var versionUT = '_UT_VIEW_VERSION_HISTORY_ACTUAL_MARGIN';\r\n      } else {\r\n        var versionUT = '_UT_VIEW_VERSION_HISTORY';\r\n      }\r\n    } else {\r\n      if (req.body.actuallisting) {\r\n        var sel = req.body.actuallisting.sys__UUID;\r\n        var versionUT = '_UT_VIEW_VERSION_HISTORY_ACTUAL_MARGIN';\r\n      } else {\r\n        var sel = req.body.listing.sys__UUID;\r\n        var versionUT = '_UT_VIEW_VERSION_HISTORY';\r\n      }\r\n    }\r\n\r\n    var versioningData = {\r\n      method: 'GET',\r\n      url:\r\n        req.body.propertyList.eka_connect_host +\r\n        '/workflow/' +\r\n        '40a27e7f-3f50-406f-a872-2ee7d9436df9/' +\r\n        versionUT +\r\n        '/data/' +\r\n        sel +\r\n        '/versions',\r\n      headers: {\r\n        Authorization: req.headers.authorization,\r\n        'X-TenantID': req.headers['x-tenantid'],\r\n        json: true\r\n      }\r\n    };\r\n\r\n    function get_header() {\r\n      return new Promise(function(resolve, reject) {\r\n        // console.log('Request - ' + versioningData.url);\r\n        request(versioningData, function(err, response, body) {\r\n          // console.log('Response - ' + body);\r\n          if (err || body.error) reject(body);\r\n          else {\r\n            // console.log('Success');\r\n            resolve(body);\r\n          }\r\n        });\r\n      });\r\n    }\r\n\r\n    Promise.all([get_header()])\r\n      .then(function(result) {\r\n        result = JSON.parse(result);\r\n        // console.log(result);\r\n        var response = result.versions;\r\n\r\n        var responseversion;\r\n        var vervar;\r\n        var stat;\r\n\r\n        if (req.body.versionmargin) {\r\n          vervar = req.body.versionmargin;\r\n        } else if (req.body.versionmarginInterestEdit) {\r\n          vervar = req.body.versionmarginInterestEdit;\r\n        } else {\r\n          vervar = req.body.viewmarginlisting;\r\n          if (req.body.selectedData) {\r\n            if (req.body.selectedData.status == 'Failed' || req.body.selectedData.status == 'Closed') {\r\n              stat = req.body.selectedData.status;\r\n            }\r\n          } else {\r\n            //stat = req.body.listing.status;\r\n            stat = response[vervar.versiondropdown.version.split('n')[1] - 1].status;\r\n            console.log(stat);\r\n          }\r\n        }\r\n        if (vervar) {\r\n          var versionno = vervar.versiondropdown.version.split('n')[1];\r\n\r\n          if (response[versionno - 1].margindata) {\r\n            responseversion = response[versionno - 1].margindata;\r\n          } else {\r\n            responseversion = response[versionno - 1].actualmargindata;\r\n          }\r\n          var createdate = new Date(\r\n            response[versionno - 1].sys__createdOn\r\n              ? response[versionno - 1].sys__createdOn\r\n              : response[versionno - 1].sys__updatedOn\r\n          ).toString();\r\n          var username = response[versionno - 1].sys__createdBy\r\n            ? response[versionno - 1].sys__createdBy\r\n            : response[versionno - 1].sys__updatedBy;\r\n          createdate = createdate.split(' ');\r\n          responseversion.versiondropdown = {\r\n            history:\r\n              'By ' + username + ' ' + createdate[2] + '-' + createdate[1] + '-' + createdate[3] + ' ' + createdate[4]\r\n          };\r\n\r\n          if (stat) {\r\n            responseversion.viewmargin.status = stat;\r\n            responseversion.viewmarginInterestEdit.status = stat;\r\n          }\r\n\r\n          if (\r\n            responseversion.shares.sharepercentage.disable == true ||\r\n            responseversion.shares.sharepercentage.disable == false\r\n          ) {\r\n            responseversion.shares.versionsharemerge = '';\r\n            responseversion.shares.trademarginaftershare = '';\r\n            responseversion.shares.roceaftershare = '';\r\n          } else if (responseversion.shares.shares.disable == true || responseversion.shares.shares.disable == false) {\r\n            responseversion.shares.versionsharemerge =\r\n              responseversion.shares.sharepercentage + '% | ' + responseversion.shares.sharevalue;\r\n          } else {\r\n            responseversion.shares.versionsharemerge =\r\n              responseversion.shares.shares +\r\n              ' | ' +\r\n              responseversion.shares.sharepercentage +\r\n              '% | ' +\r\n              responseversion.shares.sharevalue;\r\n          }\r\n          if (responseversion.remark.remark) {\r\n            responseversion.remark.remark = responseversion.remark.remark;\r\n          } else {\r\n            responseversion.remark.remark = '';\r\n          }\r\n\r\n          if (responseversion.ratesinput) {\r\n            responseversion.ratesinput.fxrefno = responseversion.ratesinput.fxrefno;\r\n          } else {\r\n            responseversion.ratesinput = {\r\n              fxrefno: ''\r\n            };\r\n            responseversion.ratesinput.fxrefno = '';\r\n          }\r\n        } else {\r\n          if (response[response.length - 1].margindata) {\r\n            var createdate = new Date(\r\n              response[response.length - 1].sys__createdOn\r\n                ? response[response.length - 1].sys__createdOn\r\n                : response[response.length - 1].sys__updatedOn\r\n            ).toString();\r\n            var username = response[response.length - 1].sys__createdBy\r\n              ? response[response.length - 1].sys__createdBy\r\n              : response[response.length - 1].sys__updatedBy;\r\n            createdate = createdate.split(' ');\r\n            response[response.length - 1].margindata.versiondropdown = {\r\n              version: 'version' + response.length.toString(),\r\n              history:\r\n                'By ' + username + ' ' + createdate[2] + '-' + createdate[1] + '-' + createdate[3] + ' ' + createdate[4]\r\n            };\r\n            responseversion = response[response.length - 1].margindata;\r\n          } else {\r\n            response[response.length - 1].actualmargindata.versiondropdown = {\r\n              version: 'version' + (response.length - 1).toString()\r\n            };\r\n            responseversion = response[response.length - 1].actualmargindata;\r\n          }\r\n          if (responseversion.shares.sharepercentage.value != '') {\r\n            responseversion.shares.versionsharemerge =\r\n              responseversion.shares.shares +\r\n              ' | ' +\r\n              responseversion.shares.sharepercentage +\r\n              '% | ' +\r\n              responseversion.shares.sharevalue;\r\n          } else {\r\n            responseversion.shares.versionsharemerge = '';\r\n            responseversion.shares.trademarginaftershare = '';\r\n            responseversion.shares.roceaftershare = '';\r\n          }\r\n          if (responseversion.remark.remark) {\r\n            responseversion.remark.remark = responseversion.remark.remark;\r\n          } else {\r\n            responseversion.remark.remark = '';\r\n          }\r\n        }\r\n        responseversion.sharesversion = responseversion.shares;\r\n        responseversion.ratesinputversion = responseversion.ratesinput;\r\n        responseversion.ratesversion = responseversion.rates;\r\n        responseversion.listingmarginversion = responseversion.listingmargin;\r\n        responseversion.tradeMarginVersion = responseversion.tradeMargin;\r\n        responseversion.remarkversion = responseversion.remark;\r\n\r\n        success(responseversion,200);\r\n      })\r\n      .catch(function(err) {\r\n  error(err,500);    \r\n      });\r\n   ",
    "sys__UUID" : "3301982c-8666-4108-b94f-2e498ee6c270",
    "sys__createdOn" : ISODate("2019-05-26T09:52:10.548Z"),
    "sys__createdBy" : "admin@ekaplus.com"
}