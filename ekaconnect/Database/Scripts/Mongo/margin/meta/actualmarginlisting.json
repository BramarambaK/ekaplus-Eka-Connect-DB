{
  "_id": ObjectId("5d5bb92c5064b968e29f3e9e"),
  "name": "actualmarginlisting",
  "type": "processor",
  "refType": "app",
  "version": "V2",
  "refTypeId": "40a27e7f-3f50-406f-a872-2ee7d9436df9",
  "snippet": "\r\n    var connectDataActualMargin = {\r\n      method: 'GET',\r\n      url:\r\n        req.body.propertyList.eka_connect_host +\r\n        '/data/40a27e7f-3f50-406f-a872-2ee7d9436df9/a094c021-4870-4b9c-940e-3858e2405e9e',\r\n      headers: {\r\n        Authorization: req.headers.authorization,\r\n        'X-TenantID': req.headers['x-tenantid'],\r\n        json: true\r\n      }\r\n    };\r\n    var status;\r\n    var start = req.body.queryParams.start ? parseInt(req.body.queryParams.start) : 0;\r\n    var end = req.body.queryParams.limit ? parseInt(req.body.queryParams.limit) : 10000;\r\n    var allocation_group_header = {\r\n      method: 'POST',\r\n      url:\r\n        req.body.propertyList.eka_connect_host +\r\n        '/collectionmapper/40a27e7f-3f50-406f-a872-2ee7d9436df9/3ef370f9-febe-41a0-8e43-4ef6ce769b3b/fetchCollectionRecords',\r\n\r\n      headers: {\r\n        Authorization: req.headers.authorization,\r\n        'X-TenantID': req.headers['x-tenantid'],\r\n        'Content-Type': 'application/json',\r\n        ttl: 300\r\n      },\r\n      body: {\r\n        collectionName: 'AllocationGroupHeader',\r\n        start: start,\r\n        limit: end\r\n      },\r\n      json: true\r\n    };\r\n    function get_header() {\r\n      return new Promise(function(resolve, reject) {\r\n        //console.log('Request - ' + allocation_group_header.url);\r\n\r\n        //console.log('Payload -' + JSON.stringify(allocation_group_header));\r\n        request(allocation_group_header, function(err, response, body) {\r\n          //  console.log('Response - ' + body);\r\n          if (err || body.error) reject(body);\r\n          else {\r\n            resolve(body);\r\n          }\r\n        });\r\n      });\r\n    }\r\n\r\n    function get_connectDataActualMargin() {\r\n      return new Promise(function(resolve, reject) {\r\n        // console.log('Request - ' + connectData.url);\r\n        //console.log('Payload -' + JSON.stringify(connectData));\r\n        request(connectDataActualMargin, function(err, response, body) {\r\n          //  console.log('Response - ' + body);\r\n          if (err || body.error) reject(body);\r\n          else {\r\n            resolve(body);\r\n          }\r\n        });\r\n      });\r\n    }\r\n    Promise.all([get_header(), get_connectDataActualMargin()])\r\n      .then(function(resultnew) {\r\n        var result = [];\r\n        //result[0] = JSON.parse(result[0]);\r\n        result[0] = {\r\n          data: resultnew[0]\r\n        };\r\n        result[1] = JSON.parse(resultnew[1]);\r\n\r\n        let response = [];\r\n        let uniqueno = 0;\r\n\r\n        var keyVals = req.body.propertyList.margin_collection_object_column_mapping;\r\n        var collection = JSON.stringify(result);\r\n\r\n        var connectKeys = Object.keys(keyVals);\r\n\r\n        for (var i = 0; i < connectKeys.length; i++) {\r\n          collection = collection.split(keyVals[connectKeys[i]]).join(connectKeys[i]);\r\n        }\r\n        result = JSON.parse(collection);\r\n\r\n        for (var i = 0; i < result[0].data.length; i++) {\r\n          if (result[0].data[i]['QUANTITY RELEASED']) {\r\n            if (result[0].data[i]['QUANTITY RELEASED'] > 0) {\r\n              status = 'Progress';\r\n            }\r\n          } else {\r\n            status = 'Open';\r\n          }\r\n          result[0].data[i]['PROFIT CENTER NAME'] = result[0].data[i]['PROFIT CENTER'];\r\n          if (result[1].length == 0) {\r\n            var data = {\r\n              ...result[0].data[i],\r\n              ...{\r\n                budgetmargin: 0,\r\n                cpname: result[0].data[i]['CP NAME'],\r\n                quantityr: '-',\r\n                actualmargin: '-',\r\n                EXECUTION_STATUS: status,\r\n                status: 'Active',\r\n                uniqueno: uniqueno,\r\n                margin: 'actual',\r\n                fxrefno: '-',\r\n                refTypeId: '40a27e7f-3f50-406f-a872-2ee7d9436df9'\r\n              }\r\n            };\r\n\r\n            response.push(data);\r\n            uniqueno++;\r\n          } else {\r\n            for (var j = 0; j < result[1].length; j++) {\r\n              if (\r\n                result[0].data[i]['INT ALLOC GROUP ID'] == result[1][j]['INT ALLOC GROUP ID'] &&\r\n                result[0].data[i]['PRODUCT SPECS'] == result[1][j]['PRODUCT SPECS'] &&\r\n                result[0].data[i]['CONTRACT ITEM NO'] == result[1][j]['CONTRACT ITEM NO']\r\n              ) {\r\n                if (result[1][j].fxrefno) {\r\n                  var fxr = result[1][j].fxrefno;\r\n                } else {\r\n                  fxr = '-';\r\n                }\r\n                if (result[1][j]['status'] == 'Active') {\r\n                  var data = {\r\n                    ...result[0].data[i],\r\n                    ...{\r\n                      budgetmargin: result[1][j].budgetmargin,\r\n                      quantityr: '-',\r\n                      actualmargin: result[1][j].actualmargin,\r\n                      cpname: result[0].data[i]['CP NAME'],\r\n                      margindata: result[1][j].margindata,\r\n                      actualmargindata: result[1][j].actualmargindata,\r\n                      status: 'Active',\r\n                      margin: 'actual',\r\n                      time: result[1][j].sys__updatedOn ? result[1][j].sys__updatedOn : result[1][j].sys__createdOn,\r\n                      EXECUTION_STATUS: status,\r\n                      statusremark: result[1][j].statusremark,\r\n                      fxrefno: fxr,\r\n                      refTypeId: '40a27e7f-3f50-406f-a872-2ee7d9436df9',\r\n                      sys__UUID: result[1][j].sys__UUID,\r\n                      uniqueno: uniqueno\r\n                    }\r\n                  };\r\n\r\n                  response.push(data);\r\n                } else if (result[1][j]['status'] == '-' && result[1][j]['budgetmargin'] != 0) {\r\n                  var data = {\r\n                    ...result[0].data[i],\r\n                    ...{\r\n                      budgetmargin: '-',\r\n                      quantityr: '-',\r\n                      actualmargin: result[1][j].actualmargin,\r\n                      margindata: result[1][j].margindata,\r\n                      actualmargindata: result[1][j].actualmargindata,\r\n                      status: 'Active',\r\n                      margin: 'actual',\r\n                      EXECUTION_STATUS: status,\r\n                      fxrefno: fxr,\r\n                      refTypeId: '40a27e7f-3f50-406f-a872-2ee7d9436df9',\r\n                      sys__UUID: result[1][j].sys__UUID,\r\n                      uniqueno: uniqueno\r\n                    }\r\n                  };\r\n\r\n                  response.push(data);\r\n                } else if (result[1][j]['status'] == '-') {\r\n                  var data = {\r\n                    ...result[0].data[i],\r\n                    ...{\r\n                      budgetmargin: '-',\r\n                      quantityr: '-',\r\n                      actualmargin: result[1][j].actualmargin,\r\n                      cpname: result[0].data[i]['CP NAME'],\r\n                      margindata: result[1][j].margindata,\r\n                      actualmargindata: result[1][j].actualmargindata,\r\n                      status: 'Active',\r\n                      margin: 'actual',\r\n                      EXECUTION_STATUS: status,\r\n                      fxrefno: fxr,\r\n                      refTypeId: '40a27e7f-3f50-406f-a872-2ee7d9436df9',\r\n                      sys__UUID: result[1][j].sys__UUID,\r\n                      uniqueno: uniqueno\r\n                    }\r\n                  };\r\n\r\n                  response.push(data);\r\n                } else if (result[1][j]['status'] == 'Failed') {\r\n                  var data = {\r\n                    ...result[0].data[i],\r\n                    ...{\r\n                      budgetmargin: '-',\r\n                      quantityr: '-',\r\n                      actualmargin: result[1][j].actualmargin,\r\n                      cpname: result[0].data[i]['CP NAME'],\r\n                      margindata: result[1][j].margindata,\r\n                      actualmargindata: result[1][j].actualmargindata,\r\n                      status: 'Failed',\r\n                      margin: 'actual',\r\n                      fxrefno: fxr,\r\n                      statusremark: result[1][j].statusremark,\r\n                      time: result[1][j].sys__updatedOn ? result[1][j].sys__updatedOn : result[1][j].sys__createdOn,\r\n                      EXECUTION_STATUS: status,\r\n                      refTypeId: '40a27e7f-3f50-406f-a872-2ee7d9436df9',\r\n                      sys__UUID: result[1][j].sys__UUID,\r\n                      uniqueno: uniqueno\r\n                    }\r\n                  };\r\n\r\n                  response.push(data);\r\n                } else {\r\n                  var data1 = {\r\n                    ...result[0].data[i],\r\n                    ...{\r\n                      budgetmargin: '-',\r\n                      quantityr: '-',\r\n                      actualmargin: result[1][j].actualmargin,\r\n                      status: 'Closed',\r\n                      margindata: result[1][j].margindata,\r\n                      actualmargindata: result[1][j].actualmargindata,\r\n                      cpname: result[0].data[i]['CP NAME'],\r\n                      refTypeId: '40a27e7f-3f50-406f-a872-2ee7d9436df9',\r\n                      sys__UUID: result[1][j].sys__UUID,\r\n                      fxrefno: fxr,\r\n                      EXECUTION_STATUS: status,\r\n                      uniqueno: uniqueno\r\n                    }\r\n                  };\r\n\r\n                  response.push(data1);\r\n                }\r\n                uniqueno++;\r\n                break;\r\n              }\r\n              if (j == result[1].length - 1) {\r\n                var data = {\r\n                  ...result[0].data[i],\r\n                  ...{\r\n                    budgetmargin: 0,\r\n                    quantityr: '-',\r\n                    actualmargin: 0,\r\n                    cpname: result[0].data[i]['CP NAME'],\r\n                    status: 'Active',\r\n                    margin: 'actual',\r\n                    EXECUTION_STATUS: status,\r\n                    fxrefno: '-',\r\n                    uniqueno: uniqueno,\r\n                    refTypeId: '40a27e7f-3f50-406f-a872-2ee7d9436df9'\r\n                  }\r\n                };\r\n\r\n                response.push(data);\r\n                uniqueno++;\r\n                break;\r\n              }\r\n            }\r\n          }\r\n        }\r\n        //console.log('Response - ' + JSON.stringify(response));\r\n      success(response,200);  \r\n      })\r\n      .catch(function(err) {\r\n        console.log('Error Executing Processor -' + err);\r\n   error(err,500);     \r\n      });\r\n   ",
  "sys__UUID": "fc8d8c22-f892-4be2-a619-77911eaae416",
  "sys__createdOn": ISODate("2019-05-20T09:29:21.300Z"),
  "sys__createdBy": "Bravo"
}
