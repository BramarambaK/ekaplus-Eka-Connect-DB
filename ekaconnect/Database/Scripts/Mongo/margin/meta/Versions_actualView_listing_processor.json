{
    "_id" : ObjectId("5da588584392954a9a1b9005"),
    "name" : "Versions_actualView_listing_processor",
    "type" : "processor",
    "refType" : "app",
    "version" : "V2",
    "refTypeId" : "40a27e7f-3f50-406f-a872-2ee7d9436df9",
    "snippet" : " \r\n    if (req.body.selectedData) {\r\n      var sel = req.body.selectedData.actualmarginsysuuid;\r\n      if (req.body.selectedData.compositeViewactualmargin) {\r\n        var versionUT = '_UT_VIEW_VERSION_HISTORY_ACTUAL_MARGIN';\r\n      } else {\r\n        var versionUT = '_UT_VIEW_VERSION_HISTORY';\r\n      }\r\n    } else {\r\n      if (req.body.actuallisting) {\r\n        var sel = req.body.actuallisting.sys__UUID;\r\n        var versionUT = '_UT_VIEW_VERSION_HISTORY_ACTUAL_MARGIN';\r\n      } else {\r\n        var sel = req.body.listing.actualmarginsysuuid;\r\n        var versionUT = '_UT_VIEW_VERSION_HISTORY';\r\n      }\r\n    }\r\n\r\n    var versioningData = {\r\n      method: 'GET',\r\n      url:\r\n        req.body.propertyList.eka_connect_host +\r\n        '/workflow/' +\r\n        '40a27e7f-3f50-406f-a872-2ee7d9436df9/' +\r\n        versionUT +\r\n        '/data/' +\r\n        sel +\r\n        '/versions',\r\n      headers: {\r\n        Authorization: req.headers.authorization,\r\n        'X-TenantID': req.headers['x-tenantid'],\r\n        json: true\r\n      }\r\n    };\r\n\r\n    function get_header() {\r\n      return new Promise(function(resolve, reject) {\r\n        // console.log('Request - ' + versioningData.url);\r\n        request(versioningData, function(err, response, body) {\r\n          // console.log('Response - ' + body);\r\n          if (err || body.error) reject(body);\r\n          else {\r\n            // console.log('Success');\r\n            resolve(body);\r\n          }\r\n        });\r\n      });\r\n    }\r\n\r\n    Promise.all([get_header()])\r\n      .then(function(result) {\r\n        result = JSON.parse(result);\r\n        // console.log(result);\r\n        var response = result.versions;\r\n\r\n        var responseversion;\r\n        var versionmargin;\r\n        if (req.body.versionmargin) {\r\n          versionmargin = req.body.versionmargin;\r\n        } else {\r\n          versionmargin = req.body.viewactualmargin;\r\n        }\r\n\r\n        if (response.length == 0) {\r\n       error('No Margin created',500);   \r\n        } else {\r\n          if (versionmargin) {\r\n            var versionno = versionmargin.actualviewversiondropdown.version.split('n')[1];\r\n            if (response[versionno - 1].margindata) {\r\n              responseversion = response[versionno - 1].margindata;\r\n            } else {\r\n              responseversion = response[versionno - 1].actualmargindata;\r\n            }\r\n            var createdate = new Date(\r\n              response[versionno - 1].sys__createdOn\r\n                ? response[versionno - 1].sys__createdOn\r\n                : response[versionno - 1].sys__updatedOn\r\n            ).toString();\r\n            var username = response[versionno - 1].sys__createdBy\r\n              ? response[versionno - 1].sys__createdBy\r\n              : response[versionno - 1].sys__updatedBy;\r\n\r\n            createdate = createdate.split(' ');\r\n            responseversion.versiondropdown = {\r\n              history:\r\n                'By ' + username + ' ' + createdate[2] + '-' + createdate[1] + '-' + createdate[3] + ' ' + createdate[4]\r\n            };\r\n\r\n            responseversion.shares.versionsharemerge = '';\r\n            responseversion.shares.trademarginaftershare = '';\r\n            responseversion.shares.roceaftershare = '';\r\n\r\n            if (responseversion.remark.remark) {\r\n              responseversion.remark.remark = responseversion.remark.remark;\r\n            } else {\r\n              responseversion.remark.remark = '';\r\n            }\r\n            if (responseversion.ratesinput) {\r\n              responseversion.ratesinput.fxrefno = responseversion.ratesinput.fxrefno;\r\n            } else {\r\n              responseversion.ratesinput = {\r\n                fxrefno: ''\r\n              };\r\n              responseversion.ratesinput.fxrefno = '';\r\n            }\r\n          } else {\r\n            if (response[response.length - 1].margindata) {\r\n              response[response.length - 1].margindata.versiondropdown = {\r\n                version: 'version' + response.length.toString()\r\n              };\r\n              responseversion = response[response.length - 1].margindata;\r\n            } else {\r\n              response[response.length - 1].actualmargindata.versiondropdown = {\r\n                version: 'version' + response.length.toString()\r\n              };\r\n              responseversion = response[response.length - 1].actualmargindata;\r\n            }\r\n            if (responseversion.shares.sharepercentage.value != '') {\r\n              responseversion.shares.versionsharemerge =\r\n                responseversion.shares.shares +\r\n                ' | ' +\r\n                responseversion.shares.sharepercentage +\r\n                '% | ' +\r\n                responseversion.shares.sharevalue;\r\n            } else {\r\n              responseversion.shares.versionsharemerge = '';\r\n              responseversion.shares.trademarginaftershare = '';\r\n              responseversion.shares.roceaftershare = '';\r\n            }\r\n            if (responseversion.remark.remark) {\r\n              responseversion.remark.remark = responseversion.remark.remark;\r\n            } else {\r\n              responseversion.remark.remark = '';\r\n            }\r\n            if (responseversion.ratesinput) {\r\n              responseversion.ratesinput.fxrefno = responseversion.ratesinput.fxrefno;\r\n            } else {\r\n              responseversion.ratesinput = {\r\n                fxrefno: ''\r\n              };\r\n              responseversion.ratesinput.fxrefno = '';\r\n            }\r\n          }\r\n          responseversion.actualviewversiondropdown = responseversion.versiondropdown;\r\n          responseversion.listingactualmarginVersion = responseversion.listingactualmargin;\r\n          responseversion.tradeMarginVersion = responseversion.tradeMargin;\r\n          responseversion.sharesversion = responseversion.shares;\r\n          responseversion.ratesinputversion = responseversion.ratesinput;\r\n          responseversion.ratesversion = responseversion.rates;\r\n          responseversion.remarkversion = responseversion.remark;\r\n   success(responseversion,200);       \r\n        }\r\n      })\r\n      .catch(function(err) {\r\n      error('Version is not available',500); \r\n      });\r\n   ",
    "sys__UUID" : "bd90f393-c705-47d9-a335-478d3c8b1850",
    "sys__createdOn" : ISODate("2019-05-26T09:52:10.548Z"),
    "sys__createdBy" : "admin@ekaplus.com"
}