{
  "_id": ObjectId("5ce7af1191dafc459c6f49f4"),
  "name": "CALCULATE_MARGIN",
  "type": "processor",
  "refType": "app",
  "refTypeId": "40a27e7f-3f50-406f-a872-2ee7d9436df9",
  "version":"V2",
  "snippet": "\r\n    var currencyFormatter = require('currency-formatter');\r\n    if (req.body.compositeViewactualmargin) {\r\n      var list = req.body.actuallisting;\r\n    } else {\r\n      var list = req.body.listing;\r\n    }\r\n\r\n    var affiliateMarginDropdown = [];\r\n    var result = [];\r\n    var defaultMargin = [];\r\n\r\n    var body = req.body;\r\n    var trademargin = 0;\r\n    var saleContractTotal = 0;\r\n    var totalfinancingdays = 0;\r\n    var percentage = 0;\r\n    var roce = 0;\r\n    var sum = 0;\r\n    var listing = body.compositeView;\r\n    var totalAmt = 0;\r\n    var fDays = 0;\r\n    var totalfinancingdaysPurchase = 0;\r\n    var totalMaintransport = 0;\r\n    var totalPurchase = 0;\r\n    var totalSale = 0;\r\n    var totalfinancingdaysSales = 0;\r\n    var totalAmtSale = 0;\r\n    var totalAmtPurchase = 0;\r\n    var totalsalematerial = 0;\r\n    var compositeData;\r\n    var compositelisting;\r\n    var financingtotalpurchase = 0;\r\n    var financingtotalsales = 0;\r\n\r\n    if (body.compositeView) {\r\n      compositeData = body.compositeView;\r\n      compositelisting = compositeData.listingmargin;\r\n    } else if (body.compositeViewInterestEdit) {\r\n      compositeData = body.compositeViewInterestEdit;\r\n      compositelisting = compositeData.listingmargin;\r\n    } else if (body.compositeViewactualmargin) {\r\n      compositeData = body.compositeViewactualmargin;\r\n      compositelisting = compositeData.listingactualmargin;\r\n    }\r\n    if (compositeData.viewmarginInterestEdit.interest != '') {\r\n      for (var i = 0; i < compositelisting.length; i++) {\r\n        if (\r\n          compositelisting[i]['COST GROUP NAME'] != 'Expense Total' &&\r\n          compositelisting[i]['COST GROUP NAME'] != 'Income Total' &&\r\n          compositelisting[i].financingdays == ''\r\n        ) {\r\n          compositelisting[i].financingdays = 0;\r\n        }\r\n        if (compositelisting[i]['COST COMPONENT NAME'] === 'Purchase Material Cost') {\r\n          totalPurchase =\r\n            totalPurchase + compositelisting[i].totalAmountMarginCurrency * compositelisting[i].financingdays;\r\n        }\r\n        if (compositelisting[i]['COST COMPONENT NAME'] === 'Sales Material Cost') {\r\n          totalSale = totalSale + compositelisting[i].totalAmountMarginCurrency * compositelisting[i].financingdays;\r\n          totalsalematerial = totalsalematerial + compositelisting[i].totalAmountMarginCurrency;\r\n        }\r\n\r\n        if (compositelisting[i]['COST COMPONENT NAME'] === 'Main transport') {\r\n          totalMaintransport =\r\n            totalMaintransport + compositelisting[i].totalAmountMarginCurrency * compositelisting[i].financingdays;\r\n        }\r\n        if (compositelisting[i]['COST GROUP NAME'] === 'Expense Total') {\r\n          trademargin =\r\n            trademargin +\r\n            compositelisting[i]['totalAmountMarginCurrency']['value'] +\r\n            compositelisting[i]['financing']['value'];\r\n          financingtotalpurchase = compositelisting[i]['financing']['value'];\r\n          totalfinancingdaysPurchase = totalfinancingdaysPurchase + compositelisting[i]['financingdays']['value'];\r\n        } else if (compositelisting[i]['COST GROUP NAME'] == 'Income Total') {\r\n          saleContractTotal = compositelisting[i]['totalAmountMarginCurrency']['value'];\r\n          trademargin =\r\n            trademargin +\r\n            compositelisting[i]['totalAmountMarginCurrency']['value'] +\r\n            compositelisting[i]['financing']['value'];\r\n          financingtotalsales = compositelisting[i]['financing']['value'];\r\n          totalfinancingdaysSales = totalfinancingdaysSales + compositelisting[i]['financingdays']['value'];\r\n        }\r\n      }\r\n\r\n      percentage = (trademargin \/ totalsalematerial) * 100;\r\n      \/\/ var A = totalfinancingdaysPurchase * totalAmtPurchase;\r\n      \/\/ var B = totalfinancingdaysSales * totalAmtSale;\r\n      var C = financingtotalsales + financingtotalpurchase;\r\n      \/\/ var D = totalFinancingDaysMainTransport * totalAmtMaintransport;\r\n      var A = totalPurchase;\r\n      var B = totalSale;\r\n      var D = totalMaintransport;\r\n      roce = (((trademargin + C) * 0.6601) \/ (B \/ 365 + A \/ 365 + D \/ 365)) * 100;\r\n      var roceroundoff = parseFloat(roce.toFixed(2));\r\n      var trademarginroundoff = parseFloat(trademargin.toFixed(5));\r\n      var percentageroundoff = parseFloat(percentage.toFixed(2));\r\n      var trademarginaftersharesbefore = parseFloat(\r\n        ((trademarginroundoff * compositeData.shares.sharepercentage) \/ 100).toFixed(5)\r\n      );\r\n      var trademarginaftershare = trademarginaftersharesbefore + trademarginroundoff;\r\n      var percentageaftershares = (trademarginaftershare \/ saleContractTotal) * 100;\r\n      var percentageaftersharesroundoff = parseFloat(percentageaftershares.toFixed(2));\r\n\r\n      var collectiontime = 0;\r\n      var compositetime = 0;\r\n      var timeInMss1 = new Date().getTime();\r\n\r\n      var c = req.body.propertyList.currencyToConvert;\r\n      var d = currencyFormatter.format(trademarginroundoff, { minimumFractionDigits: 2, locale: c });\r\n      if (percentageroundoff == 'Infinity' || percentageroundoff == '-Infinity') {\r\n        percentageformat = 0;\r\n      } else {\r\n        var percentageformat = currencyFormatter.format(percentageroundoff, {\r\n          minimumFractionDigits: 2,\r\n          locale: c\r\n        });\r\n        percentageformat = percentageformat.split('\u20AC')[0];\r\n      }\r\n      if (roceroundoff == 'Infinity' || roceroundoff == '-Infinity') {\r\n        roceformat = 0;\r\n      } else {\r\n        var roceformat = currencyFormatter.format(roceroundoff, { minimumFractionDigits: 2, locale: c });\r\n        roceformat = roceformat.split('\u20AC')[0];\r\n      }\r\n      if (isNaN(percentageroundoff)) {\r\n        percentageroundoff = 0;\r\n      }\r\n      if (isNaN(roceroundoff)) {\r\n        roceroundoff = 0;\r\n      }\r\nsuccess({\r\n        flag: compositeData.flag,\r\n        viewmarginInterestEdit: compositeData.viewmarginInterestEdit,\r\n        rates: compositeData.rates,\r\n        ratesinput: compositeData.ratesinput,\r\n        ratesvalues: compositeData.ratesvalues,\r\n        saveflag: false,\r\n        tradeMargin: {\r\n          trademarginroundoff: trademarginroundoff,\r\n          saleContractTotal: saleContractTotal,\r\n          sumDaysPurchaseSale: C,\r\n          totalPurchase: totalPurchase,\r\n          totalSale: totalSale,\r\n          totalMaintransport: totalMaintransport,\r\n          totalsalematerial: totalsalematerial,\r\n\r\n          trademargin:\r\n            d.split('\u20AC')[0] + ' ' + compositeData.viewmargin.contractValueUOM + ' | ' + percentageformat + '%',\r\n          roce: roceformat + '%'\r\n        },\r\n        listingactualmargin: compositelisting,\r\n        listingmargin: compositelisting,\r\n        viewmargin: compositeData.viewmargin,\r\n        remark: compositeData.remark,\r\n        shares: {\r\n          sharepercentage: {\r\n            value: null,\r\n            disable: false\r\n          },\r\n          shares: {\r\n            value: null,\r\n            disable: false\r\n          },\r\n          sharevalue: {\r\n            value: null,\r\n            disable: false\r\n          },\r\n          trademarginaftershare: '',\r\n          roceaftershare: ''\r\n        }\r\n      },200);\r\n     \r\n\r\n      var timeInMss2 = new Date().getTime();\r\n      compositetime = timeInMss2 - timeInMss1;\r\n      console.log('Collection time ' + collectiontime \/ 1000 + ' s');\r\n      console.log('Calculation time ' + compositetime \/ 1000 + ' s');\r\n    } else {\r\n     error('Please fill interest',500); \r\n    }\r\n",
  "sys__UUID": "b613f52e-0482-4bcd-9fb3-d6420847d316",
  "sys__createdOn": ISODate("2019-05-24T08:45:04.944Z"),
  "sys__createdBy": "admin@ekaplus.com"
}
