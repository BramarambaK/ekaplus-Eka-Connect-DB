{
  "_id": "salesexecution_TRM_API_processor_WRNT",
  "name": "salesexecution_TRM_API_processor_WRNT",
  "type": "processor",
  "refType": "app",
  "refTypeId": "ada131db-5171-4b9c-b6d6-caae0c6cd2f5",
  "snippet": "\r\nvar moment = require('moment');\r\nvar connectBody = {\r\n    appId: req.body.appId,\r\n    workFlowTask: 'dummystocklist'\r\n};\r\nvar connectUrl = req.body.propertyList.eka_connect_host + '/workflow/data';\r\nvar connect = {\r\n    method: 'POST',\r\n    body: connectBody,\r\n    url: connectUrl,\r\n    headers: {\r\n        Authorization: req.headers.authorization,\r\n        'X-TenantID': req.headers['x-tenantid']\r\n    },\r\n    json: true\r\n};\r\nfunction get_connect() {\r\n    return new Promise(function (resolve, reject) {\r\n        request(connect, function (err, response, body) {\r\n            if (response.statusCode >= 200 && response.statusCode <= 299) {\r\n                resolve(body);\r\n            }\r\n            else {\r\n                reject(body);\r\n            }\r\n        });\r\n    });\r\n}\r\nvar platformurl = req.body.propertyList.platform_url + '/api/logisticinternal/warrantSalesLoading/create';\r\nvar platformapi = {\r\n    method: 'POST',\r\n    url: platformurl,\r\n    headers: {\r\n        Authorization: req.headers.authorization\r\n    },\r\n    json: true\r\n};\r\nfunction get_platform(outputData) {\r\n    platformapi.body = outputData;\r\n    console.log(platformapi);\r\n    return new Promise(function (resolve, reject) {\r\n        request(platformapi, function (err, response, body) {\r\n            if (response.statusCode >= 200 && response.statusCode <= 299) {\r\n                resolve(body);\r\n            }\r\n            else {\r\n                reject(body);\r\n            }\r\n        });\r\n    });\r\n}\r\n\r\nget_connect().then(function (result1) {\r\n    var stocklistData = result1.data;\r\n    var selectedData = req.body;\r\n    var stocks = [];\r\n    let stock = stocklistData\r\n        .filter(item => item.edmarkrefno == selectedData.edmarkrefno)\r\n        .map(item2 => item2.stock_ref_no);\r\n    console.log(stock);\r\n    let outputData = {\r\n        activityDate: selectedData.activityDate,\r\n        modeOfTransportName: 'Title Transfer',\r\n        originCityName: selectedData.storage_location,\r\n        destinationCityName: selectedData.storage_location,\r\n        contractRefNo: selectedData.sales_contract_ref_no,\r\n        itemNo: '1',\r\n        deskStkList: stock,\r\n        bookingRefNo: selectedData.edmarkrefno,\r\n        extRefNo: selectedData.edmarkrefno,\r\n        internalRemarks: 'test remarks'\r\n    };\r\n    console.log(outputData);\r\n    get_platform(outputData)\r\n        .then(function (result2) {\r\n            console.log(result2);\r\n            if (!result2.externalRefNo) {\r\n                res.status(500).send('Error in Sales Contract Execution:(GMR Ref No is not available from TRM)');\r\n            } else if (result2.externalRefNo && result2.status == 'success') {\r\n                var output = {};\r\n                output = {\r\n                    GMR_Ref_No: result2.externalRefNo,\r\n                    title_transfer_status: 'Out',\r\n                    contract_ref_no: selectedData.sales_contract_ref_no,\r\n                    edmarkrefno: selectedData.edmarkrefno,\r\n                    GMR_creation_date: moment\r\n                        .utc(new Date())\r\n                        .utcOffset('+0530')\r\n                        .format('DD-MMM-YYYY')\r\n                };\r\n                res.status(200).send(output);\r\n            } else {\r\n                if (result2.description) {\r\n                    res.status(500).send('Error in Sales Contract Execution:(' + result2.description + ')');\r\n                } else {\r\n                    res.status(500).send('Sales Contract Execution is failing, please check');\r\n                }\r\n            }\r\n        })\r\n        .catch(err => {\r\n            res.status(500).send('Sales Contract Execution is failing, please check');\r\n        });\r\n});\r\n",
  "sys__UUID": "4cad348b-2fff-4096-8fe5-7967242d449d",
  "sys__createdBy": "ekauser@ekaplus.com"
}
