{
  "_id": "validating_file_upload_WARRANT",
  "name": "validating_file_upload",
  "type": "processor",
  "refType": "app",
  "refTypeId": "ada131db-5171-4b9c-b6d6-caae0c6cd2f5",
  "snippet": "\r\nconst moment = require('moment');\r\nvar fileID = req.body.id;\r\nvar fileDetailsURL =\r\n    req.body.propertyList.eka_connect_host +\r\n    '/data/ada131db-5171-4b9c-b6d6-caae0c6cd2f5/b0895c93-0738-4cd8-a3ce-0546c47c70f5?documentId=' +\r\n    fileID;\r\nvar fileDetails = {\r\n    method: 'GET',\r\n    url: fileDetailsURL,\r\n    headers: {\r\n        Authorization: req.headers.authorization,\r\n        'X-TenantID': req.headers['x-tenantid']\r\n    },\r\n    json: true\r\n};\r\nfunction get_fileDetails() {\r\n    return new Promise(function (resolve, reject) {\r\n        request(fileDetails, function (err, response, body) {\r\n            if (response.statusCode >= 200 && response.statusCode <= 299) {\r\n                resolve(body);\r\n            }\r\n            else {\r\n                reject(body);\r\n            }\r\n        });\r\n    });\r\n}\r\nvar defaultDataURL5 = req.body.propertyList.eka_connect_host + '/workflow/data';\r\n\r\nvar defaultdata5 = {\r\n    method: 'POST',\r\n    url: defaultDataURL5,\r\n    headers: {\r\n        Authorization: req.headers.authorization,\r\n        'X-TenantID': req.headers['x-tenantid']\r\n    },\r\n    json: true\r\n};\r\nfunction get_defaultData5(quality) {\r\n    defaultdata5.body = {};\r\n    defaultdata5.body = {\r\n        appId: 'ada131db-5171-4b9c-b6d6-caae0c6cd2f5',\r\n        workFlowTask: 'stocklisttrm',\r\n        payLoadData: {\r\n            quality: quality\r\n        }\r\n    };\r\n    return new Promise(function (resolve, reject) {\r\n        request(defaultdata5, function (err, response, body) {\r\n            if (response.statusCode >= 200 && response.statusCode <= 299) {\r\n                resolve(body);\r\n            }\r\n            else {\r\n                reject(body);\r\n            }\r\n        });\r\n    });\r\n}\r\n\r\nvar mdmData = {\r\n    method: 'POST',\r\n    url: req.body.propertyList.eka_mdm_host + '/mdm/ada131db-5171-4b9c-b6d6-caae0c6cd2f5/data',\r\n    headers: {\r\n        Authorization: req.headers.authorization,\r\n        'X-TenantID': req.headers['x-tenantid'],\r\n        'Content-Type': 'application/json'\r\n    },\r\n    json: true\r\n};\r\nfunction get_mdmData(body) {\r\n    mdmData.body = [];\r\n    mdmData.body = body;\r\n    return new Promise(function (resolve, reject) {\r\n        request(mdmData, function (err, response, body) {\r\n            if (response.statusCode >= 200 && response.statusCode <= 299) {\r\n                resolve(body);\r\n            }\r\n            else {\r\n                reject(body);\r\n            }\r\n        });\r\n    });\r\n}\r\n// let data = req.body.bulkPayLoadData;\r\n// data = JSON.parse(JSON.stringify(data));\r\nlet finalData = [];\r\nlet mappedData = {};\r\nlet body = [];\r\nif (req.body && req.body['instrument_name']) {\r\n    body = [\r\n        {\r\n            serviceKey: 'qualityMapInstrument',\r\n            dependsOn: [req.body.instrument_name]\r\n        }\r\n    ];\r\n}\r\nget_mdmData(body).then(function (result3) {\r\n    var mdmQuality = [];\r\n    for (var i = 0; i < result3.qualityMapInstrument.length; i++) {\r\n        mdmQuality.push(result3.qualityMapInstrument[i]['value']);\r\n    }\r\n    var quality = mdmQuality.toString();\r\n    get_fileDetails().then(function (result1) {\r\n        var fileDetails = result1;\r\n        let data = [];\r\n        for (var i = 0; i < fileDetails.length; i++) {\r\n            data.push(fileDetails[i]['fileContent']);\r\n        }\r\n        get_defaultData5(quality).then(function (collection) {\r\n            for (var k = 0; k < collection.data.length; k++) {\r\n                if (collection.data[k]['ext_stock_ref_no']) {\r\n                    mappedData[collection.data[k]['ext_stock_ref_no']] = collection.data[k];\r\n                }\r\n            }\r\n\r\n            for (var i = 0; i < data.length; i++) {\r\n                if (data[i]['External Stock Ref No'] && mappedData[data[i]['External Stock Ref No']]) {\r\n                    mappedData[data[i]['External Stock Ref No']]['status'] = true;\r\n                    finalData.push(mappedData[data[i]['External Stock Ref No']]);\r\n                } else if (data[i]['External Stock Ref No']) {\r\n                    data[i]['status'] = false;\r\n                    data[i]['error'] = 'External ST Refno NOT MATCHED';\r\n                    data[i]['ext_stock_ref_no'] = data[i]['External Stock Ref No'];\r\n                    finalData.push(data[i]);\r\n                }\r\n            }\r\n            var validatedata = {};\r\n            validatedata['data'] = finalData;\r\n            res.status(200).send(validatedata['data']);\r\n        });\r\n    });\r\n});\r\n",
  "sys__UUID": "714afb2e-8dae-4802-b0db-6d99b8149d33",
  "sys__createdBy": "ekauser@ekaplus.com"
}
