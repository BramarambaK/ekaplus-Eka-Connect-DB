{
  "_id": "patch_multi_data_with_regrading_validation_Warrant",
  "name": "patchmultidata_regrading_validation",
  "type": "processor",
  "refType": "app",
  "refTypeId": "ada131db-5171-4b9c-b6d6-caae0c6cd2f5",
  "snippet": "\r\n    var defaultDataURL1 = req.body.propertyList.eka_mdm_host + '/mdm/ada131db-5171-4b9c-b6d6-caae0c6cd2f5/data';\r\n    var defaultdata1 = {\r\n      method: 'POST',\r\n      body: [\r\n        {\r\n          serviceKey: 'requestTypeMapInstrument',\r\n          dependsOn: [req.body.selectedData.data[0].instrument_name]\r\n        }\r\n      ],\r\n      url: defaultDataURL1,\r\n      headers: {\r\n        Authorization: req.headers.authorization,\r\n        'X-TenantID': req.headers['x-tenantid']\r\n      },\r\n      json: true\r\n    };\r\n    function get_mappedRequestType() {\r\n      return new Promise(function (resolve, reject) {\r\n        request(defaultdata1, function (err, response, body) {\r\n          if (response.statusCode >= 200 && response.statusCode <= 299) {\r\n            resolve(body);\r\n          }\r\n          else {\r\n            reject(body);\r\n          }\r\n        });\r\n      });\r\n    }\r\n    if (req.body.selectedData.data) {\r\n      const sData = req.body.selectedData.data;\r\n      let validateMap = {\r\n        warehouse: sData[0].warehouse ? sData[0].warehouse : '',\r\n        quality: sData[0].quality ? sData[0].quality : '',\r\n        instrument_name: sData[0].instrument_name ? sData[0].instrument_name : '',\r\n        instrument_name_value: sData[0].instrument_name_value ? sData[0].instrument_name_value : '',\r\n        product: sData[0].product ? sData[0].product : '',\r\n        origin: sData[0].origin ? sData[0].origin : '',\r\n        cropyear: sData[0].cropyear ? sData[0].cropyear : '',\r\n        Profit_Center: sData[0].Profit_Center ? sData[0].Profit_Center : ''\r\n      };\r\n      for (let i = 0; i < sData.length; i++) {\r\n        if (\r\n          !(\r\n            sData[i]['product'] &&\r\n            sData[i]['product'] == validateMap['product'] &&\r\n            (sData[i]['quality'] && sData[i]['quality'] == validateMap['quality']) &&\r\n            (sData[i]['origin'] && sData[i]['origin'] == validateMap['origin']) &&\r\n            (sData[i]['cropyear'] && sData[i]['cropyear'] == validateMap['cropyear'])\r\n          )\r\n        ) {\r\n          res.status(500).send('Please select Stocks having same Product, Quality, Origin and Crop Year');\r\n          break;\r\n        }\r\n        if (!(sData[i]['warehouse'] && sData[i]['warehouse'] == validateMap['warehouse'])) {\r\n          res.status(500).send('Select records belongs to same Warehouse');\r\n          break;\r\n        }\r\n        if (!(sData[i]['Profit_Center'] && sData[i]['Profit_Center'] == validateMap['Profit_Center'])) {\r\n          res.status(500).send('Select records belongs to same Profit Center');\r\n          break;\r\n        }\r\n        if (!(sData[i]['instrument_name'] && sData[i]['instrument_name'] == validateMap['instrument_name'])) {\r\n          res.status(500).send('Select records belongs to same Exchange Instrument');\r\n          break;\r\n        }\r\n\r\n        if (sData[i]['ispreviousregrade']) {\r\n          res.status(500).send('Select records which are regrading for the first time');\r\n          break;\r\n        }\r\n      }\r\n      req.body['data_transfer'] = req.body.selectedData.data;\r\n      req.body['activityDate'] = new Date();\r\n      get_mappedRequestType().then(function (requestType) {\r\n        if (requestType.hasOwnProperty('requestTypeMapInstrument'))\r\n          if (requestType.requestTypeMapInstrument.find(item => item.value === 'Re-Grading')) {\r\n            var response = {};\r\n            response = {\r\n              activityDate: req.body.activityDate,\r\n              data_transfer: req.body.data_transfer,\r\n              selectedData: req.body.selectedData\r\n            }\r\n            res.status(200).send(response);\r\n          } else {\r\n            res.status(500).send('selected records not valid for Regrading');\r\n          }\r\n        else {\r\n          res.status(500).send('Failed to get mdm data');\r\n        }\r\n      });\r\n    }\r\n ",
  "sys__UUID": "d95f43d4-0a2b-49bd-9cfa-8b8073ae54ad",
  "sys__createdBy": "ekauser@ekaplus.com"
}
