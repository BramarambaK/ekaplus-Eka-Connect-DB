{
  "_id": "savedecertify_processor_warrant",
  "name": "savedecertify",
  "type": "processor",
  "refType": "app",
  "refTypeId": "ada131db-5171-4b9c-b6d6-caae0c6cd2f5",
  "snippet": "\r\nvar save_data_connect = {\r\n    method: 'PUT',\r\n    url:\r\n        req.body.propertyList.eka_connect_host +\r\n        '/data/updateBulk/ada131db-5171-4b9c-b6d6-caae0c6cd2f5/00b0627c-e0dd-4530-a765-116ab9748487',\r\n    body: {},\r\n    headers: {\r\n        Authorization: req.headers.authorization,\r\n        'X-TenantID': req.headers['x-tenantid']\r\n    },\r\n    json: true\r\n};\r\nfunction save_data(outputData) {\r\n    save_data_connect.body = {};\r\n    save_data_connect.body.data = outputData;\r\n    return new Promise(function (resolve, reject) {\r\n        request(save_data_connect, function (err, response, body) {\r\n            if (response.statusCode >= 200 && response.statusCode <= 299) {\r\n                resolve(body);\r\n            }\r\n            else {\r\n                reject(body);\r\n            }\r\n        });\r\n    });\r\n}\r\nvar url = req.body.propertyList.platform_url + '/api/logistic/stockDetailsUpdate';\r\nvar apiDetails = {\r\n    method: 'PUT',\r\n    url: url,\r\n    headers: {\r\n        Authorization: req.headers.authorization,\r\n        'Content-Type': 'application/json'\r\n    },\r\n    json: true\r\n};\r\nfunction post_data(body) {\r\n    apiDetails.body = [];\r\n    apiDetails.body = body;\r\n    console.log(apiDetails.body);\r\n    return new Promise(function (resolve, reject) {\r\n        request(apiDetails, function (err, response, body) {\r\n            console.log(body);\r\n            if (response.statusCode >= 200 && response.statusCode <= 299) {\r\n                resolve(body);\r\n            }\r\n            else {\r\n                reject(body);\r\n            }\r\n        });\r\n    });\r\n}\r\nconst moment = require('moment');\r\nif (!req.body['data_transfer']) {\r\n    res.status(500).send('Please select valid records');\r\n}\r\nlet data = req.body['data_transfer'];\r\nif (data.length > req.body.propertyList.property_default_selection) {\r\n    res.status(500).send('Please select maximum 50 records');\r\n} else {\r\n    if (!req.body['warrant_remarks'] || req.body['warrant_remarks'] == '') {\r\n        res.status(500).send('Please fill the mandatory fields');\r\n    }\r\n    let f = true;\r\n    for (let i = 0; i < data.length; i++) {\r\n        if (moment(req.body['activityDate']) >= moment(data[i]['activityDate'])) {\r\n            console.log(data[i]['certification_status']);\r\n            if (data[i]['certification_status'] == 'Not-Certified') data[i]['certification_status'] = 'Certified';\r\n            else if (data[i]['certification_status'] == 'Certified') data[i]['certification_status'] = 'Not-Certified';\r\n            data[i]['activityDate'] = req.body['activityDate'];\r\n            data[i]['warrant_remarks'] = req.body['warrant_remarks'];\r\n            data[i]['id'] = data[i]['_id'];\r\n            delete data[i]['_id'];\r\n        } else {\r\n            f = false;\r\n            break;\r\n        }\r\n    }\r\n    if (f) {\r\n        save_data(data).then(function (result) {\r\n            console.log('Data saved in Connect');\r\n            var bulkPayLoadData = data;\r\n            var body = [];\r\n            for (var i = 0; i < bulkPayLoadData.length; i++) {\r\n                if (bulkPayLoadData[i]['grading_status'] == 'NA') bulkPayLoadData[i]['grading_status'] = 'Pending';\r\n                var final_weight_date = moment\r\n                    .utc(bulkPayLoadData[i]['final_weight_date'])\r\n                    .utcOffset('+0530')\r\n                    .format('YYYY-MM-DD');\r\n                var Grading_Date = moment\r\n                    .utc(bulkPayLoadData[i]['Grading_Date'])\r\n                    .utcOffset('+0530')\r\n                    .format('YYYY-MM-DD');\r\n                var exchange_type = '';\r\n                var productClass = '';\r\n                if (bulkPayLoadData[i]['exchange_type']) {\r\n                    exchange_type = bulkPayLoadData[i]['exchange_type'];\r\n                }\r\n                if (bulkPayLoadData[i]['class']) {\r\n                    productClass = bulkPayLoadData[i]['class'];\r\n                }\r\n                body.push({\r\n                    certificationStatus: bulkPayLoadData[i]['certification_status'],\r\n                    gradingStatus: bulkPayLoadData[i]['grading_status'],\r\n                    externalStkRefNo: bulkPayLoadData[i]['ext_stock_ref_no'],\r\n                    gradingDate: Grading_Date,\r\n                    finalWeightDate: final_weight_date,\r\n                    exchangeType: exchange_type,\r\n                    productClass: productClass,\r\n                    isDeleted: 'N',\r\n                    goodsRecordDetailPkDO: {\r\n                        internalGrdRefNo: bulkPayLoadData[i]['internal_grd_dgrd_ref_no']\r\n                    }\r\n                });\r\n            }\r\n            post_data(body)\r\n                .then(function (result) {\r\n                    res.status(200).send(result);\r\n                })\r\n                .catch(err => {\r\n                    res.status(500).send('Post to TRM Api not working');\r\n                });\r\n        });\r\n    } else\r\n        res\r\n            .status(500)\r\n            .send('Selected Record should have the activity Date less than or equal to the given Activity Date');\r\n}\r\n",
  "sys__UUID": "97f40c2b-a110-4cb2-93fa-846b682b7d9b",
  "sys__createdBy": "Bravo"
}
