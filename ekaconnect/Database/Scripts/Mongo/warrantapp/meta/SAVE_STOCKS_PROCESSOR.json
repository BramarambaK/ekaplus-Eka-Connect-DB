{
  "_id": "SAVE_STOCKS_PROCESSOR",
  "name": "SAVE_STOCKS_PROCESSOR",
  "type": "processor",
  "refType": "app",
  "refTypeId": "ada131db-5171-4b9c-b6d6-caae0c6cd2f5",
  "snippet": "\r\nvar url = req.body.propertyList.platform_url + '/api/logistic/stockDetailsUpdate';\r\nvar apiDetails = {\r\n    method: 'PUT',\r\n    url: url,\r\n    headers: {\r\n        Authorization: req.headers.authorization,\r\n        'Content-Type': 'application/json'\r\n    },\r\n    json: true\r\n};\r\nfunction post_data(body) {\r\n    apiDetails.body = [];\r\n    apiDetails.body = body;\r\n    console.log(apiDetails.body);\r\n    return new Promise(function (resolve, reject) {\r\n        request(apiDetails, function (err, response, body) {\r\n            console.log(body);\r\n            if (response.statusCode >= 200 && response.statusCode <= 299) {\r\n                resolve(body);\r\n            }\r\n            else {\r\n                reject(body);\r\n            }\r\n        });\r\n    });\r\n}\r\nvar collectionData = req.body.selectedData[0];\r\nvar selected = req.body;\r\nvar int_stock_ref_no = JSON.parse(selected.internalstock);\r\nvar selectedData = selected.selectedData;\r\n// var ext_stock_ref_no = selected.ext_stock_ref_no_array.split(',');\r\nvar output = [];\r\nvar body = [];\r\nvar grading_date;\r\nvar final_weight_date;\r\nvar exchange_type = '';\r\nvar productClass = '';\r\nvar no_Of_Units = '';\r\nvar quantity_unit = '';\r\n\r\nif (collectionData.no_Of_Units) {\r\n    no_Of_Units = collectionData.no_Of_Units;\r\n}\r\nif (collectionData.quantity_unit) {\r\n    quantity_unit = collectionData.quantity_unit;\r\n}\r\nconsole.log('int_stock_ref_no:' + int_stock_ref_no);\r\nfor (var i = 0; i < int_stock_ref_no.length; i++) {\r\n    grading_date = '';\r\n    if (int_stock_ref_no[i].grading_date) {\r\n        grading_date = int_stock_ref_no[i].grading_date;\r\n        grading_date = grading_date.substring(0, 10);\r\n    }\r\n    final_weight_date = '';\r\n    if (int_stock_ref_no[i].final_weight_date) {\r\n        final_weight_date = int_stock_ref_no[i].final_weight_date;\r\n        final_weight_date = final_weight_date.substring(0, 10);\r\n    }\r\n    exchange_type = '';\r\n    if (int_stock_ref_no[i].exchangeType) {\r\n        exchange_type = int_stock_ref_no[i]['exchangeType'];\r\n    }\r\n    productClass = '';\r\n    if (int_stock_ref_no[i].productClass) {\r\n        productClass = int_stock_ref_no[i]['productClass'];\r\n    }\r\n    body.push({\r\n        certificationStatus: 'Certified',\r\n        gradingStatus: 'Passed',\r\n        externalStkRefNo: int_stock_ref_no[i]['externalStkRefNo'],\r\n        gradingDate: grading_date,\r\n        finalWeightDate: final_weight_date,\r\n        exchangeType: exchange_type,\r\n        productClass: productClass,\r\n        isDeleted: 'N',\r\n        goodsRecordDetailPkDO: {\r\n            internalGrdRefNo: int_stock_ref_no[i]['internalGrdRefNo']\r\n        }\r\n    });\r\n    output.push({\r\n        activityDate: selected.activityDate,\r\n        corporate: selected.corporate,\r\n        instrument_name: selected.instrument_name,\r\n        instrument_name_value: selected.instrument_name,\r\n        request_type: 'Grading',\r\n        warrant_remarks: 'warrant_remarks',\r\n        stock_ref_no: int_stock_ref_no[i]['internalStockRefNo'],\r\n        ext_stock_ref_no: int_stock_ref_no[i]['externalStkRefNo'],\r\n        quality: collectionData['quality'],\r\n        warehouse: collectionData['warehouse'],\r\n        grading_status: 'Passed',\r\n        certification_status: 'Certified',\r\n        exchangeDeliveryStatus: 'Received from Exchange',\r\n        shed: collectionData['storage_location'],\r\n        Profit_Center: collectionData['Profit_Center'],\r\n        Strategy: collectionData['Strategy'],\r\n        cropyear: collectionData['crop_year'],\r\n        origin: collectionData['origin'],\r\n        product: collectionData['product'],\r\n        port_name: collectionData['port_name'],\r\n        Weight_Update_Available: 'N',\r\n        title_transfer_status: 'In',\r\n        actual_quantity: selectedData[i]['quantity'],\r\n        Packing_Size: selectedData[i]['Packing_Size'],\r\n        no_of_units: collectionData['no_Of_Units'],\r\n        Quantity_UOM: collectionData['quantity_unit'],\r\n        exchange_lot: selectedData[i]['exchange_lots'],\r\n        Stock_Update_Status: 'Pending',\r\n        final_weight_date: final_weight_date,\r\n        Grading_Date: grading_date\r\n    });\r\n}\r\npost_data(body)\r\n    .then(function (result) {\r\n        console.log(result);\r\n        res.status(200).send(output);\r\n    })\r\n    .catch(err => {\r\n        res.status(500).send('Post to TRM Api not working');\r\n    });\r\n",
  "sys__UUID": "6839890f-b744-431a-8f49-c706d5ed5356",
  "sys__createdBy": "ekauser@ekaplus.com"
}
