{
    "_id" : "Formula_List_mdm_processor_Ags",
    "name" : "Formula_List_mdm_processor",
    "type" : "processor",
    "refType" : "app",
    "version":"V2",
    "refTypeId" : "5d907cd2-7785-4d34-bcda-aa84b2158415",
    "snippet" : "    var defaultDataURL =\r\n      req.body.propertyList.eka_connect_host + '/workflow/data';\r\n      var dbody = {\r\n        \"appId\":\"84d7b167-1d9f-406d-b974-bea406a25f9a\",\r\n        \"workFlowTask\":\"formula_list\"\r\n      }\r\n      var defaultdata = {\r\n        method: 'POST',\r\n        url: defaultDataURL,\r\n        body:dbody,\r\n        headers: {\r\n          Authorization: req.headers.authorization,\r\n          'X-TenantID': req.headers['x-tenantid']\r\n        },\r\n        json: true\r\n      };\r\n      function get_defaultData() {\r\n        return new Promise(function(resolve, reject) {\r\n          request(defaultdata, function(err, response, body) {\r\n            if (err || body.error) reject(body);\r\n            else {\r\n              resolve(body);\r\n            }\r\n          });\r\n        });\r\n      }\r\n\t  \r\n\t  var mdmUrl =\r\n      req.body.propertyList.eka_mdm_host + '/mdm/5d907cd2-7785-4d34-bcda-aa84b2158415/data';\r\n      var mdmPayload = {\r\n        method: 'POST',\r\n        url: mdmUrl,\r\n        body:[{\r\n\"serviceKey\": \"productpricetypelist\",\r\n\"dependsOn\" : [],\r\n}]\t,\r\n        headers: {\r\n          Authorization: req.headers.authorization,\r\n          'X-TenantID': req.headers['x-tenantid']\r\n        },\r\n        json: true\r\n      };\r\n      function get_mdm() {\r\n        return new Promise(function(resolve, reject) {\r\n          request(mdmPayload, function(err, response, body) {\r\n            if (err || body.error) reject(body);\r\n            else {\r\n              resolve(body);\r\n            }\r\n          });\r\n        });\r\n      }\r\n  if(req.headers.hasOwnProperty('device-id')){\r\n        defaultdata.headers['Device-Id'] = req.headers['device-id']\r\nmdmPayload .headers['Device-Id'] = req.headers['device-id']\r\n\r\n      }\r\n\t  get_defaultData().then(function(result) {\r\n\t   req.body.mdmProcessorServiceKey = JSON.parse(req.body.mdmProcessorServiceKey);\r\n\t   var data = {};\r\n        var index = 6\r\n        for(var i = 0 ;i<req.body.mdmProcessorServiceKey.length;i++){\r\n          if(req.body.mdmProcessorServiceKey[i].serviceKey === 'formulaList'){\r\n            index = i;\r\n            break\r\n          }\r\n        }\r\n        \r\n        if (\r\n          req.body &&\r\n          req.body.mdmProcessorServiceKey &&\r\n          req.body.mdmProcessorServiceKey[index] &&\r\n          req.body.mdmProcessorServiceKey[index].serviceKey === 'formulaList'\r\n        )\r\n        {\r\n          \r\n          var mdmData = [];\r\n          \r\n          for(var i=0; i<result.data.length; i++){\r\n\t\t  if(result.data[i].triggerPricing && !result.data[i]._autoCreated)\r\n            mdmData.push({ key: result.data[i]._id, value: result.data[i].formulaName});\r\n          }\r\n          data = { formulaList : mdmData }; \r\n        }\r\n        \r\n        for(var i = 0 ;i<req.body.mdmProcessorServiceKey.length;i++){\r\n          if(req.body.mdmProcessorServiceKey[i].serviceKey === 'priceTypeContract'){\r\n            mdmPayload.body[0].dependsOn.push(req.body.mdmProcessorServiceKey[i].dependsOn[0])\r\n            break\r\n          }\r\n        }\r\n\r\n       get_mdm().then(data2=>{\r\n        var updatedmdm = []  \r\n        for(var i=0; i<data2.productpricetypelist.length; i++){\r\n\t\t  if(data2.productpricetypelist[i].key ==='On Call Basis Fixed' || data2.productpricetypelist[i].key ==='Fixed' || data2.productpricetypelist[i].key ==='Flat' )\r\n            updatedmdm.push({ key: data2.productpricetypelist[i].key, value: data2.productpricetypelist[i].value});\r\n          }\r\n          data['priceTypeContract']= updatedmdm\r\n    success(data,200);\r\n}).catch(err => {\r\n    console.log(err);\r\n  });\r\n  }).catch(err => {\r\n    console.log(err);\r\n  });",
    "sys__UUID" : "5eb6cfe1-f51f-4a2b-9d4a-65cfcb4f8ac5",
    "sys__createdOn" : ISODate("2019-05-22T09:51:04.600Z"),
    "sys__createdBy" : "avinash@ekaplus.com"
}