{
    "_id" : "Contract_Header_Details_QTC",
    "name" : "Contract_Header_Details_QTC",
    "type" : "processor",
    "refType" : "app",
    "refTypeId" : "5d907cd2-7785-4d34-bcda-aa84b2158415",
    "snippet" : "\r\n    function createbody(method,host,url_end_Point,body = {},Connection = false){\r\n      let bdy = {\r\n        method: method,\r\n        url : req.body.propertyList[host] + url_end_Point,\r\n        headers: {\r\n          Authorization: req.headers.authorization,\r\n          'X-TenantID': req.headers['x-tenantid']\r\n        },\r\n        json: true,\r\n        body: body\r\n      };\r\n      if(Connection) bdy.headers['Connection'] = \"keep-alive\"\r\n      return  bdy\r\n    }\r\n  function call_API(url_details) {\r\n    return new Promise(function(resolve, reject) {\r\n      request(url_details, function(err, response, body) {\r\n        if (err|| body.error) reject(body);\r\n        else {\r\n          resolve(body);\r\n        }\r\n      });\r\n    });\r\n  }\r\n  function idtovalue(mdmdata,key){\r\n    if(mdmdata){\r\n    for(let i=0;i<mdmdata.length;i++){\r\n      if(mdmdata[i].key == key) return mdmdata[i].value\r\n    } \r\n  }\r\n  return key\r\n}\r\n call_API(createbody('GET','eka_trm_physicals_api_host','\/contract\/trm?contractRefNo=' + req.body.selectedData.internalContractRefNo,{},true)).then((contract_data)=>{\r\n   call_API(createbody('GET','eka_connect_host','\/meta\/object\/5335f2cf-8169-48af-bc38-d52a551d7be1')).then((object)=>{\r\n    call_API(createbody('GET','eka_connect_host','\/meta\/object\/ad612d3a-45d0-4b8a-919f-94f4b503e7dc')).then((object_default)=>{\r\n      object.fields = {\r\n        ...object.fields,\r\n        ...object_default.fields\r\n      }\r\n       let arr = []\r\n       for (let key in object.fields){\r\n         if(object.fields[key].hasOwnProperty('serviceKey') && object.fields[key]['serviceKey']!=''){\r\n           if(object.fields[key].hasOwnProperty('serviceKey') && object.fields[key].hasOwnProperty('parent'))\r\n           arr.push({'serviceKey' : object.fields[key]['serviceKey'],dependsOn:object.fields[key].parent.map((item)=>{\r\n            if(contract_data[item]==null) return 'not defined' \r\n            return contract_data[item]\r\n           })\r\n          })\r\n          else if(object.fields[key].hasOwnProperty('serviceKey') && object.fields[key].hasOwnProperty('dependsOn')){\r\n            arr.push({'serviceKey' : object.fields[key]['serviceKey'],dependsOn:object.fields[key]['dependsOn']})\r\n          }\r\n           else\r\n           arr.push({'serviceKey' : object.fields[key]['serviceKey']})\r\n         }\r\n       }\r\n    Promise.all([arr].map(eachitem=>\r\n      call_API(createbody('POST','eka_mdm_host','\/mdm\/5d907cd2-7785-4d34-bcda-aa84b2158415\/data',eachitem)))).then(respo => {     \r\n        let items = Object.values(respo).map((item,index)=>{\r\n          let displayValue = {}\r\n          for( let k in object.fields){\r\n            if(object.fields[k].hasOwnProperty('dropdownValue') && contract_data[k]){\r\n              displayValue[object.fields[k].dropdownValue] = idtovalue(item[object.fields[k].serviceKey],contract_data[k])\r\n            }\r\n          }\r\n          contract_data = {\r\n            ... contract_data,\r\n            ... displayValue\r\n          }\r\n          if (req.body.selectedData){\r\n            contract_data = {\r\n              ... contract_data,\r\n              ... req.body.selectedData\r\n            }\r\n          }\r\n          contract_data['contractTypeDisplayName'] = contract_data.contractType == 'P' ? 'Purchase':'Sale'\r\n          console.log(displayValue)\r\n          return contract_data\r\n        })\r\n        res.status(200).send(items)\r\n    \r\n    \r\n      \r\n      \r\n      \r\n      \r\n      }).catch(err=>{\r\n        res.status(500).send(err)\r\n      })\r\n    }).catch(err=>{\r\n      res.status(500).send(err)\r\n    })\r\n   }).catch(err=>{\r\n    res.status(500).send(err)\r\n  })\r\n }).catch(err=>{\r\n  res.status(500).send(err)\r\n})\r\n",
    "sys__UUID" : "6a44f696-a19b-4da1-bd25-1de7dfb4fbeb",
    "sys__createdOn" : ISODate("2019-06-24T13:35:31.281Z"),
    "sys__createdBy" : "avinash@ekaplus.com"
}