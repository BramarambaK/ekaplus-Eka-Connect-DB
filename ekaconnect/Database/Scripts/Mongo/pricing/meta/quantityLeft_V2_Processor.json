{
    "_id" : "quantityLeft_V2_Processor",
    "name" : "quantityLeft_V2_Processor",
    "type" : "processor",
    "refType" : "app",
    "refTypeId" : "84d7b167-1d9f-406d-b974-bea406a25f9a",
    "snippet" : "\r\n  \r\n  const { internalContractItemRefNo, internalContractRefNo } = req.body.bulkPayLoadData[0];\r\n  function createbody(method,host,url_end_Point,body = {}){\r\n    let bdy = {\r\n      method: method,\r\n      url : req.body.propertyList[host] + url_end_Point,\r\n      headers: {\r\n        Authorization: req.headers.authorization,\r\n        'X-TenantID': req.headers['x-tenantid'],\r\n        'Connection': \"keep-alive\"\r\n      },\r\n      json: true,\r\n      body: body\r\n    };\r\n    return  bdy\r\n  }\r\nfunction call_API(url_details) {\r\n  return new Promise(function(resolve, reject) {\r\n    request(url_details, function(err, response, body) {\r\n      if (err|| body.error) reject(body);\r\n      else {\r\n        resolve(body);\r\n      }\r\n    });\r\n  });\r\n}\r\ncall_API(createbody('POST','eka_connect_host','\/workflow\/data?internalContractRefNo='+internalContractRefNo,{\r\n  appId: \"5d907cd2-7785-4d34-bcda-aa84b2158415\",\r\n  workFlowTask: \"contract_list\",\r\n})).then((contract)=>{\r\n let item = contract.data[0].itemDetails.find((i)=> internalContractItemRefNo ==  i.internalItemRefNo)\r\n let displayValue = JSON.parse(item.itemDisplayValue)\r\n call_API(createbody('POST','eka_connect_host','\/workflow\/data?internalContractItemRefNo='+internalContractItemRefNo,{\r\n  appId: \"84d7b167-1d9f-406d-b974-bea406a25f9a\",\r\n  workFlowTask: \"trigger_data_list\",\r\n})).then((fixtaion)=>{\r\n  if (item.toleranceMax) {\r\n    item.toleranceType === \"Percentage\"\r\n      ? (item.itemQty = (item.itemQty + (Number(item.toleranceMax) * Number(item.itemQty)) \/ 100))\r\n      : (item.itemQty = (item.itemQty + Number(item.toleranceMax)));\r\n  }\r\nlet final = {\r\n  'unfixedQuantity' : Number(item.itemQty),\r\n  'itemQtyUnit' : displayValue.hasOwnProperty('itemQtyUnitIdDisplayName')?displayValue.itemQtyUnitIdDisplayName:''\r\n }\r\n if(Array.isArray(fixtaion.data) && fixtaion.data.length > 0){\r\nlet latest_fixation = fixtaion.data.sort(function(a,b){\r\n  return new Date(b.sys__createdOn) - new Date(a.sys__createdOn);\r\n})[0]\r\nfinal = {\r\n  'unfixedQuantity' : Number(latest_fixation.itemUnfixedQty),\r\n  'itemQtyUnit' : latest_fixation.itemQtyUnit\r\n }\r\n }\r\n res.status(200).send(final)\r\n}).catch(err=>{\r\n  res.status(500).send(err)\r\n})\r\n}).catch(err=>{\r\n  res.status(500).send(err)\r\n})\r\n\r\n\r\n",
    "sys__UUID" : "0f5daf1e-6e53-4eaa-8dc7-b43687c03810",
    "sys__createdBy" : "avinash@ekaplus.com"
}