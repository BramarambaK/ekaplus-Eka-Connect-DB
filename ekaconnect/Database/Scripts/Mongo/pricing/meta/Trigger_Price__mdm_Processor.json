{
    "_id" : "Trigger_price_mdm_processor",
    "name" : "Mdm_Processor",
    "refType" : "app",
    "refTypeId" : "84d7b167-1d9f-406d-b974-bea406a25f9a",
    "snippet" : "\r\n    \r\n    var mdmdata = {};\r\n    \r\n    req.body.mdmProcessorServiceKey = JSON.parse(req.body.mdmProcessorServiceKey);\r\n       var ket = 0\r\n           for(var i = 0 ;i<req.body.mdmProcessorServiceKey.length;i++){\r\n             if(req.body.mdmProcessorServiceKey[i].serviceKey === 'productPriceUnit'){\r\n               ket = i;\r\n               break\r\n             }\r\n           }\r\n           \r\n           if (\r\n             req.body &&\r\n             req.body.mdmProcessorServiceKey &&\r\n             req.body.mdmProcessorServiceKey[ket] &&\r\n             req.body.mdmProcessorServiceKey[ket].serviceKey === 'productPriceUnit'\r\n           )\r\n       {\r\n          mdmdata['productPriceUnit'] = req.body.selectedData.productPriceUnit\r\n       \r\n       }\r\n   \r\n     if(req.body.selectedData && req.body.selectedData.fixationMethod==='Index'){\r\n     var mdmData =[]\r\n     var moment = require('moment');\r\n     var today = new Date()\r\n     today = moment(today).format('YYYY-MM-DD');\r\n     today = today + 'T00:00:00';\r\n     var defaultDataURL2 =\r\n     req.body.propertyList.eka_connect_host +'/collectionmapper/' +req.body.appId +'/formula/fetchCollectionRecords';\r\n     \r\n     var defaultdata2 = {\r\n       method: 'POST',\r\n       url: defaultDataURL2,\r\n       body:{\r\n         criteria: { filter: [  {\r\n           \"fieldName\": \"Instrument Name\",\r\n           \"value\": \"NYMEX Light Sweet Crud Oil(WTI) Future\",\r\n           \"operator\": \"in\"\r\n         },\r\n         {\r\n           \"fieldName\": \"Pricing Date\",\r\n           \"value\": \"2019-04-17T00:00:00\",\r\n           \"operator\": \"in\"\r\n         }\r\n      ]},  \r\n        collectionName: 'DS-Market Prices',\r\n        start: 0,\r\n        limit: 1000\r\n      }\r\n     ,\r\n       headers: {\r\n         Authorization: req.headers.authorization,\r\n         'X-TenantID': req.headers['x-tenantid'],\r\n         'Content-Type': 'application/json',\r\n         'ttl': 300,\r\n       },\r\n       json: true\r\n     };\r\n     if(req.body.selectedData && req.body.selectedData.indexName && req.body.selectedData.fixationDate){\r\n       defaultdata2.body.criteria.filter[0].value = req.body.selectedData.indexName\r\n       defaultdata2.body.criteria.filter[1].value = moment(req.body.selectedData.fixationDate).format('YYYY-MM-DD') + 'T00:00:00'\r\n     }\r\n     function get_defaultData2() {\r\n       return new Promise(function(resolve, reject) {\r\n         request(defaultdata2, function(err, response, body) {\r\n           if (err || body.error) reject(body);\r\n           else {\r\n             resolve(body);\r\n           }\r\n         });\r\n       });\r\n     }\r\n     \r\n     var defaultDataURL =\r\n         req.body.propertyList.eka_connect_host + '/workflow/data';\r\n         var dbody = {\r\n           \"appId\":\"84d7b167-1d9f-406d-b974-bea406a25f9a\",\r\n           \"workFlowTask\":\"basecurve_list\"\r\n         }\r\n         var defaultdata = {\r\n           method: 'POST',\r\n           url: defaultDataURL,\r\n           body:dbody,\r\n           headers: {\r\n             Authorization: req.headers.authorization,\r\n             'X-TenantID': req.headers['x-tenantid']\r\n           },\r\n           json: true\r\n         };\r\n         function get_defaultData() {\r\n           return new Promise(function(resolve, reject) {\r\n             request(defaultdata, function(err, response, body) {\r\n               if (err || body.error) reject(body);\r\n               else {\r\n                 resolve(body);\r\n               }\r\n             });\r\n           });\r\n         }\r\n         var defaultDataURL4 = req.body.propertyList.eka_connect_host + '/workflow';\r\n     var dbody = {\r\n       \"appId\": \"84d7b167-1d9f-406d-b974-bea406a25f9a\",\r\n       \"workflowTaskName\": \"fx_rate\",\r\n       \"task\": \"fx_rate\",\r\n       \"output\": {\r\n         \"fx_rate\": {}\r\n       }\r\n       \r\n     };\r\n    \r\n     var defaultdata4 = {\r\n       method: 'POST',\r\n       url: defaultDataURL4,\r\n       body: dbody,\r\n       headers: {\r\n         Authorization: req.headers.authorization,\r\n         'X-TenantID': req.headers['x-tenantid']\r\n       },\r\n       json: true\r\n     };\r\n     function get_defaultData4() {\r\n       return new Promise(function(resolve, reject) {\r\n         request(defaultdata4, function(err, response, body) {\r\n           if (err || body.error) reject(body);\r\n           else {\r\n             resolve(body);\r\n           }\r\n         });\r\n       });\r\n     }\r\n   \r\n   \r\n   \r\n       get_defaultData().then(function(result) {   \r\n           var index = 6\r\n           for(var i = 0 ;i<req.body.mdmProcessorServiceKey.length;i++){\r\n             if(req.body.mdmProcessorServiceKey[i].serviceKey === 'indexCurve'){\r\n               index = i;\r\n               break\r\n             }\r\n           }\r\n           \r\n           if (\r\n             req.body &&\r\n             req.body.mdmProcessorServiceKey &&\r\n             req.body.mdmProcessorServiceKey[index] &&\r\n             req.body.mdmProcessorServiceKey[index].serviceKey === 'indexCurve'\r\n           )\r\n           {\r\n             \r\n             \r\n             for(var i=0; i<result.data[0].data.length; i++){\r\n               mdmData.push({ key: result.data[0].data[i].map.curveName, value: result.data[0].data[i].map.curveName});\r\n             }\r\n       mdmData.sort(function(a, b) {\r\n              var nameA = a.key.toUpperCase();\r\n             var nameB = b.key.toUpperCase(); \r\n             if (nameA < nameB) {\r\n                return -1;\r\n             }\r\n             if (nameA > nameB) {\r\n                return 1;\r\n             }\r\n             return 0;\r\n            });\r\n             mdmdata = { 'indexCurve' : mdmData }; \r\n           }\r\n            \r\n       \r\n           if (req.body.selectedData.indexName && (((req.body.selectedData.indexName.hasOwnProperty('value') && req.body.selectedData.indexName.value!='')) || (!req.body.selectedData.indexName.hasOwnProperty('value')&&req.body.selectedData.indexName!=''))  ){\r\n          get_defaultData2().then(data2=>{\r\n            if(data2.length>0){\r\n              if(data2[0]['Settle Price']){\r\n               \r\n           mdmdata['indexCurvePrice']=data2[0]['Settle Price']\r\n           mdmdata['priceunitforindex']= data2[0]['Price Unit']\r\n          }\r\n            }\r\n            else{\r\n              mdmdata['indexCurvePrice']='NA'\r\n              mdmdata['priceunitforindex']= 'NA'\r\n            }\r\n     res.status(200).send(mdmdata);\r\n     }).catch(err => {\r\n       console.log(err);\r\n       res.status(500).send(err)\r\n     });\r\n   }\r\n   else res.status(200).send(mdmdata);\r\n  \r\n   })\r\n }\r\n else{\r\n   \r\n   res.status(200).send(mdmdata);\r\n }\r\n     \r\n  ",
    "sys__UUID" : "be07fc42-7838-49a5-b0a4-3cd02db779d1",
    "sys__createdBy" : "avinash.singh@ekaplus.com",
    "type" : "processor"
}