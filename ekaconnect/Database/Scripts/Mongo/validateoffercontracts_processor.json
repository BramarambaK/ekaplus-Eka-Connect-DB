{
  "_id": "validateoffercontracts_processor",
  "name": "validateoffercontracts_processor",
  "type": "processor",
  "refType": "app",
  "refTypeId": "12325a98-a959-4939-9005-4158d136afcd",
  "snippet": "const send = (status, message) => res.status(status).send(message);\r\nconst formElementName = 'offercontracts';\r\nconst mapping = {\r\n    contractType :\"offercontracttype\",\r\n     product:\"offerproduct\",\r\n     quality :\"offerquality\",\r\n     cropYear :\"offerseason\",\r\n     offersustainable :\"offersustainable\",\r\n     dischargeLocationCity :\"offerregion\",\r\n     offersite:\"offersite\",\r\n     INCOTerm:\"offerdeliverterm\",\r\n     shipmentPeriodFrom:\"offerdeliveryperiod\",\r\n     contractItemQuantity:\"offerquantity\",\r\n     contractPrice:\"offerprice\",\r\n     offerExpiryDate:\"offerexpiry\"\r\n }\r\nconst data = req.body.bulkPayLoadData.map((i, index) => ({ ...i, _groupNo: i._groupNo || index})) || [];\r\nconst commonMessage = 'Entry errors identified. Please review your inputs.';\r\nconst findEmptyField = (data) => (field, callback) => {\r\n  const e = data.filter(\r\n    (i) => (field == 'shipmentPeriodFrom' || field =='shipmentPeriodTo') && i['INCOTerm'] != 'DB'? false : i[field] === null || i[field] === '' || i[field] === undefined\r\n    );\r\n  if (e && e.length > 0) {\r\n    const msg = callback(e);\r\n    return {\r\n      errorCode: '004',\r\n      errorMessage: msg,\r\n      errorContext: null,\r\n      errorLocalizedMessage: msg,\r\n      errors: [\r\n        {\r\n          errorCode: '004',\r\n          errorMessage: msg,\r\n          errorContext: `{formarray:offercontracts}`,\r\n          errorLocalizedMessage: msg,\r\n          errors: [\r\n            ...e.reduce((acc, curr) => {\r\n              acc.add(curr._groupNo);\r\n              return acc;\r\n            }, new Set()),\r\n          ].map((i) => ({\r\n            errorCode: '004',\r\n            errorMessage: msg,\r\n            errorContext: `{formarray:${i}}`,\r\n            errorLocalizedMessage: msg,\r\n            errors: [\r\n              {\r\n                errorCode: '004',\r\n                errorMessage: msg,\r\n                errorContext: `{field:${mapping[field]}}`,\r\n                errorLocalizedMessage: msg,\r\n                errors: null,\r\n              },\r\n            ],\r\n          })),\r\n        },\r\n      ],\r\n    };\r\n  }\r\n  return null;\r\n};\r\nconst equal = (i, j) =>\r\n  i.product == j.product &&\r\n  i.cropYear == j.cropYear &&\r\n  i.quality == j.quality &&\r\n  i.contractItemQuantity == j.contractItemQuantity &&\r\n  i.contractPrice == j.contractPrice &&\r\n  i.dischargeLocationCity == j.dischargeLocationCity &&\r\n  i.INCOTerm == j.INCOTerm &&\r\n  i.shipmentPeriodFrom == j.shipmentPeriodFrom &&\r\n  i.shipmentPeriodTo == j.shipmentPeriodTo &&\r\n  i.offerExpiryDate == j.offerExpiryDate &&\r\n  i.offersustainable == j.offersustainable &&\r\n  i.contractType == j.contractType &&\r\n  i.BPRefNo == j.BPRefNo;\r\n\r\nconst invalidMessages = [\r\n  {\r\n    key: 'BPRefNo',\r\n    message: () => `Please choose NGR`,\r\n  },\r\n  {\r\n    key: 'cropYear',\r\n    message: () => `Please choose season`,\r\n  },\r\n  {\r\n    key: 'dischargeLocationCity',\r\n    message: () => `Please select a valid Port zone\/Delivery zone`,\r\n  },\r\n  {\r\n    key: 'product',\r\n    message: (e) => `Please select a valid commodity`,\r\n  },\r\n  {\r\n    key: 'quality',\r\n    message: (e) => `Please select the grade(s)`,\r\n  },\r\n  {\r\n    key: 'offersite',\r\n    message: (e) => `Please select the site`,\r\n  },\r\n  {\r\n    key: 'contractItemQuantity',\r\n    message: (e) => `Please enter Offer quantity`,\r\n  },\r\n  {\r\n    key: 'contractPrice',\r\n    message: (e) => `Please enter Offer price`,\r\n  },\r\n  {\r\n    key: 'INCOTerm',\r\n    message: (e) => `Please select Delivery term`,\r\n  },\r\n  {\r\n    key: 'shipmentPeriodFrom',\r\n    message: (e) => `Please select Delivery period`,\r\n  },\r\n  {\r\n    key: 'shipmentPeriodTo',\r\n    message: (e) => `Please select Delivery period`,\r\n  },\r\n  {\r\n    key: 'offerExpiryDate',\r\n    message: (e) => `Please select Offer expire date`,\r\n  },\r\n  {\r\n    key: 'offersustainable',\r\n    message: (e) => `Please select Sustainable`,\r\n  },\r\n  {\r\n    key: 'contractType',\r\n    message: (e) => `Please select Contract type`,\r\n  }\r\n];\r\nconst duplicateMessage =\r\n  'Please review errors or duplicates marked below and ensure entry is correct before proceeding to next step.';\r\n\r\ntry {\r\n  if (data.length > 0) {\r\n    if (data.length <= 10) {\r\n      const _findEmptyField = findEmptyField(data);\r\n      for (let i of invalidMessages) {\r\n        const error = _findEmptyField(i.key, i.message);\r\n        if (error) {\r\n          return send(400, error);\r\n        }\r\n      }\r\n\r\n      const duplicate = [\r\n        ...data\r\n          .filter((i, index, arr) => arr.findIndex((j) => equal(i, j)) != index)\r\n          .reduce((acc, curr) => {\r\n            acc.add(curr._groupNo);\r\n            return acc;\r\n          }, new Set()),\r\n      ];\r\n\r\n      if (duplicate && duplicate.length > 0) {\r\n        return send(400, {\r\n          errorCode: '004',\r\n          errorMessage: commonMessage,\r\n          errorContext: null,\r\n          errorLocalizedMessage: commonMessage,\r\n          errors: [\r\n            {\r\n              errorCode: '004',\r\n              errorMessage: duplicateMessage,\r\n              errorContext: '{formarray:offercontracts}',\r\n              errorLocalizedMessage: duplicateMessage,\r\n              errors: duplicate.map((i) => ({\r\n                errorCode: '004',\r\n                errorMessage: duplicateMessage,\r\n                errorContext: `{formarray:${i}}`,\r\n                errorLocalizedMessage: duplicateMessage,\r\n                errors: null,\r\n              })),\r\n            },\r\n          ],\r\n        });\r\n      } else {\r\n        send(200, data);\r\n      }\r\n    } else {\r\n      send(400, 'Maximum of 10 records are allowed');\r\n    }\r\n  } else {\r\n    send(400, 'No data to be saved');\r\n  }\r\n} catch (err) {\r\n  send(500, {\r\n    errorCode: '004',\r\n    errorMessage: err.message || err,\r\n    errorContext: err.message || err,\r\n    errorLocalizedMessage: 'Internal server error',\r\n  });\r\n}",
  "sys__UUID": "8b990c2d-3fcf-4ecf-9efb-0107c6d9d8fb"
}
