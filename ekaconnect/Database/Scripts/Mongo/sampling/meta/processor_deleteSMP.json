{
    "_id" : "processor_deleteSMP",
    "name" : "sampleDelete",
    "type" : "processor",
    "refType" : "app",
    "refTypeId" : "bcb79287-04fb-4af2-ae97-61af272b2c45",
    "snippet" : "\r\n    if (req.body.bulkPayLoadData) {\r\n      var bulkdata = req.body.bulkPayLoadData;\r\n      var object = 'd6df33f0-0e8d-46de-91b4-9968484b5fba';\r\n      var ekaEntity =\r\n        req.body.propertyList.eka_connect_host +\r\n        `\/data\/bcb79287-04fb-4af2-ae97-61af272b2c45\/${object}?sample_instruction_id=${\r\n          bulkdata[0].sample_instruction_id\r\n        }`;\r\n\r\n      var FirstPageData = {\r\n        method: 'GET',\r\n        url: ekaEntity,\r\n        headers: {\r\n          Authorization: req.headers.authorization,\r\n          'Content-Type': 'application\/json',\r\n          'X-TenantID': req.headers['x-tenantid']\r\n        },\r\n        json: true\r\n      };\r\n      var get_platformEntityLiquidityPlanData = function get_platformEntityLiquidityPlanData(object, bulkdata) {\r\n        FirstPageData.url =\r\n          req.body.propertyList.eka_connect_host +\r\n          `\/data\/bcb79287-04fb-4af2-ae97-61af272b2c45\/${object}?sample_instruction_id=${\r\n            bulkdata[0].sample_instruction_id\r\n          }`;\r\n        return new Promise(function(resolve, reject) {\r\n          request(FirstPageData, function(err, response, body) {\r\n            if (response.statusCode >= 200 && response.statusCode <= 299) {\r\n              resolve(body);\r\n            } else {\r\n              reject(body);\r\n            }\r\n          });\r\n        });\r\n      };\r\n      Promise.all([\r\n        get_platformEntityLiquidityPlanData('d6df33f0-0e8d-46de-91b4-9968484b5fba', bulkdata),\r\n        get_platformEntityLiquidityPlanData('4638683b-aa06-474c-8cd6-66b8a463b769', bulkdata)\r\n      ]).then(result => {\r\n        console.log(result);\r\n        var removedRowId = [];\r\n        var instructionId=bulkdata[0].instructionagainstdrawnfrom;\r\n        if (instructionId === 'Purchase-Unallocated') {\r\n          result[0] = result[1].map(item => {\r\n            item.Purchase_Ref_No = item.ref_no;\r\n            return item;\r\n          \r\n          });\r\n          bulkdata.forEach(element => {\r\n            element.Linked_Ref_No=element.ref_no;\r\n          });\r\n        }\r\n        if (bulkdata[0].Linked_Ref_No) {\r\n          var removedRow = result[0].filter(function(ar) {\r\n            return !bulkdata.find(function(rm) {\r\n              return ar.Purchase_Ref_No === rm.Linked_Ref_No;\r\n            });\r\n          });\r\n          removedRowId = removedRow.map(a => a.Purchase_Ref_No);\r\n          console.log(removedRowId);\r\n          \/\/************************Delete from Database***************************\/\/\r\n\r\n          var connectDeleteUrl =\r\n            req.body.propertyList.eka_connect_host + `\/data\/bcb79287-04fb-4af2-ae97-61af272b2c45\/${object}\/bulkDelete`;\r\n          var connectDelete = {\r\n            method: 'DELETE',\r\n            url: connectDeleteUrl,\r\n            headers: {\r\n              Authorization: req.headers.authorization,\r\n              'Content-Type': 'application\/json',\r\n              'X-TenantID': req.headers['x-tenantid']\r\n            },\r\n            json: true\r\n          };\r\n\r\n          function get_connect_delete(body, object, fieldName) {\r\n            connectDelete.body = {};\r\n            body.filterData.filter[0].fieldName = fieldName;\r\n            connectDelete.body = body;\r\n\r\n            connectDelete.url =\r\n              req.body.propertyList.eka_connect_host +\r\n              `\/data\/bcb79287-04fb-4af2-ae97-61af272b2c45\/${object}\/bulkDelete`;\r\n            return new Promise(function(resolve, reject) {\r\n              request(connectDelete, function(err, response, body) {\r\n                if (response.statusCode >= 200 && response.statusCode <= 299) {\r\n                  resolve(body);\r\n                } else {\r\n                  reject(body);\r\n                }\r\n              });\r\n            });\r\n          }\r\n\r\n          if (removedRowId[0]) {\r\n            var filterBody = {\r\n              filterData: {\r\n                filter: [\r\n                  {\r\n                    fieldName: 'Purchase_Ref_No',\r\n                    value: removedRowId,\r\n                    operator: 'in'\r\n                  },\r\n                  {\r\n                    fieldName: 'sample_instruction_id',\r\n                    value: bulkdata[0].sample_instruction_id,\r\n                    operator: 'eq'\r\n                  }\r\n                ]\r\n              }\r\n            };\r\n            Promise.all([\r\n              get_connect_delete(filterBody, 'd6df33f0-0e8d-46de-91b4-9968484b5fba', 'Purchase_Ref_No'),\r\n              get_connect_delete(filterBody, '4638683b-aa06-474c-8cd6-66b8a463b769', instructionId=='Purchase-Unallocated'? 'ref_no':'Linked_Ref_No')\r\n            ]).then(function(result) {\r\n              res.status(200).send(result);\r\n            });\r\n          } else {\r\n            res.status(200).send({ data: [] });\r\n          }\r\n        } else {\r\n          res.status(200).send({ data: [] });\r\n        }\r\n      });\r\n    }\r\n  ",
    "sys__UUID" : "6daa0942-9883-450c-bfdf-3aacfa9617eb",
    "sys__createdBy" : "Vicky@ekaplus.com"
}