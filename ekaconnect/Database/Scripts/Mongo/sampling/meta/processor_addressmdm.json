{
  "_id": "processor_addressmdm",
  "name": "addressmdm",
  "type": "processor",
  "refType": "app",
  "version": "V2",
  "refTypeId": "bcb79287-04fb-4af2-ae97-61af272b2c45",
  "snippet": "req.body.mdmProcessorServiceKey = JSON.parse(req.body.mdmProcessorServiceKey);\r\nlet ad = req.body.mdmProcessorServiceKey.find(\r\n  (item) => item.serviceKey === \"address1\"\r\n);\r\nfunction get_cp_domain_collection() {\r\n  let api = {\r\n    method: \"POST\",\r\n    url:\r\n      req.body.propertyList.eka_connect_host +\r\n      \"/collectionmapper/e4ba81fc-1304-4f01-b641-7425da52a666/e833e4b5-e278-4769-b02e-d7f9483a230d/fetchCollectionRecords\",\r\n    headers: {\r\n      \"Content-Type\": \"application/json\",\r\n      \"X-TenantID\": req.headers[\"x-tenantid\"],\r\n      Authorization: req.headers.authorization,\r\n      ttl: 300,\r\n      \"X-Remote-User\": \"ekaApp\",\r\n      Connection: \"keep-alive\",\r\n    },\r\n    body: {\r\n      collectionName: \"Sampling CP details\",\r\n      criteria: {\r\n        filter: [\r\n          {\r\n            fieldName: \"CP Name\",\r\n            value: ad.dependsOn[1] ? ad.dependsOn[1] : \"xyz\",\r\n            operator: \"in\",\r\n          },\r\n        ],\r\n      },\r\n    },\r\n    json: true,\r\n  };\r\n  return new Promise(function (resolve, reject) {\r\n    request(api, function (err, response, body) {\r\n      if (response.statusCode >= 200 && response.statusCode <= 299) {\r\n        resolve(body);\r\n      } else if (response.statusCode == 400) {\r\n        resolve([]);\r\n      } else {\r\n        reject(body);\r\n      }\r\n    });\r\n  });\r\n}\r\nif (\r\n    req.body.selectedData.instructionagainst ==\r\n      \"Sales Contract-Unallocated\" ||\r\n    req.body.selectedData.hasOwnProperty(\"sampledrawnfromedit\")\r\n  ) {\r\n    success({ address1: req.body.selectedData.address }, 200);\r\n  }\r\nelse{\r\nget_cp_domain_collection()\r\n  .then((cp) => {\r\n    if (!(Array.isArray(cp)) || cp.length == 0) {\r\n        res.status(200).send({ address1: \"\" });\r\n      }\r\n    var cpid = cp[0].PROFILEID;\r\n\r\n    var addressmdm = {\r\n      method: \"POST\",\r\n      url:\r\n        req.body.propertyList.eka_mdm_host +\r\n        \"/mdm/masterdatas/\" +\r\n        req.body.appId +\r\n        \"/cpAddress\",\r\n      headers: {\r\n        Authorization: req.headers.authorization,\r\n        \"X-TenantID\": req.headers[\"x-tenantid\"],\r\n        \"Content-Type\": \"application/json\",\r\n        Connection: \"keep-alive\",\r\n      },\r\n      body: {\r\n        cpId: cpid,\r\n      },\r\n      json: true,\r\n    };\r\n\r\n    function get_addressmdm() {\r\n      return new Promise(function (resolve, reject) {\r\n        request(addressmdm, function (err, response, body) {\r\n          if (response.statusCode >= 200 && response.statusCode <= 299) {\r\n            resolve(body);\r\n          } else {\r\n            resolve(\"\");\r\n          }\r\n        });\r\n      });\r\n    }\r\n    if (\r\n      req.body.selectedData.instructionagainst ==\r\n        \"Sales Contract-Unallocated\" ||\r\n      req.body.selectedData.hasOwnProperty(\"sampledrawnfromedit\")\r\n    ) {\r\n      success({ address1: req.body.selectedData.address }, 200);\r\n    }\r\n    if (cpid)\r\n      get_addressmdm()\r\n        .then((data) => {\r\n          if (data) {\r\n            var a = data.cpAddress;\r\n            var b = a.replace(/[^0-9a-zA-Z'/, ]/g, \" \").replace(/ +/, \" \");\r\n\r\n            success({ address1: b }, 200);\r\n          } else {\r\n            success({ address1: \"\" }, 200);\r\n          }\r\n        })\r\n        .catch((err) => {\r\n          success({ address1: \"\" }, 200);\r\n          console.log(err);\r\n        });\r\n    else {\r\n      success({ address1: \"\" }, 200);\r\n    }\r\n  })\r\n  .catch((err) => {\r\n    console.log(err);\r\n    success({ address1: \"\" }, 200);\r\n  });\r\n}\r\n",
  "sys__UUID": "f52fc1c8-3ebf-456b-9bdd-f274dd3539f5",
  "sys__createdBy": "srini@ekaplus.com"
}
