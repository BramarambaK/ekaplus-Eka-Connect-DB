{
    "_id" : "_PROCESSOR_CONTRACTS_SAVE_BULKAMENDMENT_Processor",
    "name" : "_PROCESSOR_CONTRACTS_SAVE",
    "refType" : "app",
    "refTypeId" : "5d907cd2-7785-4d34-bcda-aa84b2158415",
    "snippet" : "var sendData = []\r\n    var moment = require('moment');\r\n    var defaultDataURL1 = req.body.propertyList.platform_url + '/api/contract/header/bulk';\r\n    var mdmUrl = req.body.propertyList.eka_connect_host + \"/workflow/mdm\";\r\n    var defaultdata1 = {\r\n      method: 'PUT',\r\n      url: defaultDataURL1,\r\n      body:{},\r\n      headers: {\r\n        Authorization: req.headers.authorization,\r\n        \"Content-Type\" : \"application/json\"\r\n      },\r\n      json: true\r\n    };\r\n\r\n    var mdmData = {\r\n      method: 'POST',\r\n      url: mdmUrl,\r\n      body:{  \r\n          \"appId\": \"5d907cd2-7785-4d34-bcda-aa84b2158415\",\r\n          \"data\": [\r\n            {\r\n              \"serviceKey\": \"businesspartnercontactperson\",\r\n              \"dependsOn\": [\r\n                \"ALL\"\r\n              ]\r\n            },\r\n            {\r\n              \"serviceKey\": \"incoterm\"\r\n            },\r\n            {\r\n              \"serviceKey\": \"paytermlist_phy\"\r\n            }\r\n          ],\r\n          \"workFlowTask\": \"listingcontract\"\r\n      },\r\n      headers: {\r\n        Authorization: req.headers.authorization,\r\n        \"Content-Type\" : \"application/json\",\r\n        \"X-TenantId\" : \"960integ\"\r\n      },\r\n      json: true\r\n    }\r\n    function get_MdmData() {\r\n      return new Promise(function(resolve, reject) {\r\n        request(mdmData, function(err, response, body) {\r\n          if (err || body.error) reject(body);\r\n          else {\r\n            resolve(body);\r\n          }\r\n        });\r\n      });\r\n    }\r\n\r\n    function get_defaultData1() {\r\n      return new Promise(function(resolve, reject) {\r\n        request(defaultdata1, function(err, response, body) {\r\n          if (err || body.error) reject(body);\r\n          else {\r\n            resolve(body);\r\n          }\r\n        });\r\n      });\r\n    }\r\n  \r\n    var data = req.body.bulkcontractsupdate.listingcontract;\r\n    let onlyMandatoryField = true;\r\n    if(req.body.bulkcontractsupdate.editcontract.incoTerm || req.body.bulkcontractsupdate.editcontract.payTerm || req.body.bulkcontractsupdate.editcontract.cpName){\r\n          onlyMandatoryField = false;\r\n    }\r\n   \r\n    if(onlyMandatoryField){\r\n        get_MdmData().then(function(result){\r\n          var data = result;\r\n          let lcdata = req.body.bulkcontractsupdate.listingcontract;\r\n          let ecdata = req.body.bulkcontractsupdate.editcontract;\r\n          let cpNameMdm = data[\"businesspartnercontactperson\"];\r\n          let payTermMdm = data[\"paytermlist_phy\"];\r\n          let incotermMdm = data[\"incoterm\"];\r\n          for(let i=0; i < cpNameMdm.length; i++){\r\n                if(cpNameMdm[i].value == lcdata[0].cpName){\r\n                  ecdata['cpProfileId'] = cpNameMdm[i].key;\r\n                  break;\r\n                }\r\n          }\r\n          for(let i=0; i < payTermMdm.length; i++){\r\n            if(payTermMdm[i].value == lcdata[0].payTerm){\r\n              ecdata['paymentTermId'] = payTermMdm[i].key;\r\n              break;\r\n            }\r\n          }\r\n          for(let i=0; i < incotermMdm.length; i++){\r\n            if(incotermMdm[i].value == lcdata[0].incoTerm){\r\n              ecdata['incotermId'] = incotermMdm[i].key;\r\n              break;\r\n            }\r\n          }\r\n           \r\n          for(let i=0;i<lcdata.length;i++){\r\n            sendData.push({})\r\n            sendData[i]['amendmentDate'] =moment(req.body.bulkcontractsupdate.editcontract.amendmentDate).format('YYYY-MM-DD')+ 'T18:30:00.000+0000';\r\n            sendData[i]['amendmentReason'] =req.body.bulkcontractsupdate.editcontract.amendmentReason;\r\n            sendData[i]['internalContractRefNo']  = lcdata[i]['internalContractRefNo'];\r\n            sendData[i]['contractRefNo']  = lcdata[i]['contractRefNo'];\r\n            sendData[i]['incotermId'] = req.body.bulkcontractsupdate.editcontract.incotermId;\r\n            sendData[i]['paymentTermId'] = req.body.bulkcontractsupdate.editcontract.paymentTermId;\r\n            sendData[i]['cpProfileId'] = req.body.bulkcontractsupdate.editcontract.cpProfileId;\r\n            sendData[i][\"approvalManagementDO\"] = req.body.bulkcontractsupdate.editcontract.approvalManagementDO;\r\n          }\r\n          \r\n          defaultdata1.body = sendData;\r\n          console.log(JSON.stringify(defaultdata1));\r\n          get_defaultData1().then(function (ctrm) {\r\n            console.log(ctrm);\r\n\t\t\tif(Array.isArray(ctrm)){\r\n        res.status(200).send(ctrm);\r\n\t\t}\r\n\t\telse res.status(500).send('Bulk Upload API is failing, Please check');\r\n          }).catch(function (err) {\r\n            console.log(err);\r\n            res.status(500).send(err);\r\n          });\r\n        })\r\n    }else{\r\n      for(let i=0;i<data.length;i++){\r\n        sendData.push({})\r\n        sendData[i]['amendmentDate'] =moment(req.body.bulkcontractsupdate.editcontract.amendmentDate).format('YYYY-MM-DD')+ 'T18:30:00.000+0000';\r\n        sendData[i]['amendmentReason'] =req.body.bulkcontractsupdate.editcontract.amendmentReason;\r\n        sendData[i]['internalContractRefNo']  = data[i]['internalContractRefNo'];\r\n        sendData[i]['contractRefNo']  = data[i]['contractRefNo'];\r\n        if(req.body.bulkcontractsupdate.editcontract.incoTerm){\r\n          sendData[i]['incotermId'] = req.body.bulkcontractsupdate.editcontract.incoTerm;\r\n          sendData[i]['incoTerm'] = req.body.bulkcontractsupdate.editcontract.incoTermDisplayName;\r\n        }\r\n        if(req.body.bulkcontractsupdate.editcontract.payTerm){\r\n          sendData[i]['paymentTermId'] = req.body.bulkcontractsupdate.editcontract.payTerm;\r\n          sendData[i]['paymentTerm'] = req.body.bulkcontractsupdate.editcontract.payTermDisplayName;\r\n        }\r\n        if(req.body.bulkcontractsupdate.editcontract.cpName){\r\n          sendData[i]['cpProfileId'] = req.body.bulkcontractsupdate.editcontract.cpName;\r\n        }\r\n        sendData[i][\"approvalManagementDO\"] = req.body.bulkcontractsupdate.editcontract.approvalManagementDO;\r\n      }\r\n  \r\n      defaultdata1.body = sendData;\r\n      console.log(JSON.stringify(defaultdata1));\r\n      get_defaultData1().then(function (ctrm) {\r\n\t  if(Array.isArray(ctrm)){\r\n        res.status(200).send(ctrm);\r\n\t\t}\r\n\t\telse res.status(500).send('Bulk Upload API is failing, Please check');\r\n      }).catch(function (err) {\r\n        console.log(err);\r\n        res.status(500).send(err);\r\n      });\r\n    }",
    "sys__UUID" : "4523d816-48ef-4fbf-8b77-42d011637d53",
    "sys__createdBy" : "gopal.gupta@ekaplus.com",
    "type" : "processor"
}