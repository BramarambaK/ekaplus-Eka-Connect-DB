{
    "_id" : "listing_component_gmr_processor",
    "name" : "gmr_listing_processor",
    "type" : "processor",
    "refType" : "app",
    "refTypeId" : "5d907cd2-7785-4d34-bcda-aa84b2158415",
    "snippet" : " \r\n    var data = [];\r\n    var defaultData = req.body.propertyList.eka_connect_host + '/workflow/data';\r\n    var defaultdata = {\r\n      method: 'POST',\r\n       url: defaultData,\r\n       body:{\r\n       \"appId\": \"5d907cd2-7785-4d34-bcda-aa84b2158415\",\r\n       \"workFlowTask\": \"contract_list\",\r\n       \"filterData\": {\r\n       \"filter\": [\r\n         {\r\n           \"fieldName\": \"internalContractRefNo\",\r\n           \"value\": [],\r\n           \"operator\": \"in\"\r\n         },\r\n       {\r\n       \"fieldName\": \"contractState\",\r\n           \"value\": ['trade'],\r\n           \"operator\": \"in\"\r\n       }\r\n       ]\r\n     }\r\n   },\r\n       headers: {\r\n         Authorization: req.headers.authorization,\r\n         'X-TenantID': req.headers['x-tenantid']\r\n       },\r\n       json: true\r\n     };\r\n     function get_default() {\r\n       return new Promise(function(resolve, reject) {\r\n         request(defaultdata, function(err, response, body) {\r\n           if (err || body.error) reject(body);\r\n           else {\r\n             resolve(body);\r\n           }\r\n         });\r\n       });\r\n     }\r\n     var defaultDataURL1 =\r\n       req.body.propertyList.eka_connect_host + '/data/5d907cd2-7785-4d34-bcda-aa84b2158415/a17ad3d2-8c98-461d-98c7-d91e953aa819'\r\n \r\n \r\n     var defaultdata1 = {\r\n       method: 'GET',\r\n       url: defaultDataURL1,\r\n       headers: {\r\n         Authorization: req.headers.authorization,\r\n         'X-TenantID': req.headers['x-tenantid']\r\n       },\r\n       json: true\r\n     };\r\n     function get_defaultData() {\r\n       return new Promise(function (resolve, reject) {\r\n         request(defaultdata, function (err, response, body) {\r\n           if (err || body.error) reject(body);\r\n           else {\r\n             resolve(body);\r\n           }\r\n         });\r\n       });\r\n     }\r\n     var defaultDataURL1 =\r\n       req.body.propertyList.eka_connect_host + '/data/5d907cd2-7785-4d34-bcda-aa84b2158415/a17ad3d2-8c98-461d-98c7-d91e953aa819'\r\n \r\n \r\n     var defaultdata1 = {\r\n       method: 'GET',\r\n       url: defaultDataURL1,\r\n       headers: {\r\n         Authorization: req.headers.authorization,\r\n         'X-TenantID': req.headers['x-tenantid']\r\n       },\r\n       json: true\r\n     };\r\n     function get_defaultData1() {\r\n       return new Promise(function (resolve, reject) {\r\n         request(defaultdata1, function (err, response, body) {\r\n           if (err || body.error) reject(body);\r\n           else {\r\n             resolve(body);\r\n           }\r\n         });\r\n       });\r\n     }\r\n     var defaultDataURL2 =\r\n       req.body.propertyList.eka_connect_host + '/data/84d7b167-1d9f-406d-b974-bea406a25f9a/formula'\r\n \r\n \r\n     var defaultdata2 = {\r\n       method: 'GET',\r\n       url: defaultDataURL2,\r\n       headers: {\r\n         Authorization: req.headers.authorization,\r\n         'X-TenantID': req.headers['x-tenantid']\r\n       },\r\n       json: true\r\n     };\r\n     function get_defaultData2() {\r\n       return new Promise(function (resolve, reject) {\r\n         request(defaultdata2, function (err, response, body) {\r\n           if (err || body.error) reject(body);\r\n           else {\r\n             resolve(body);\r\n           }\r\n         });\r\n       });\r\n     }\r\n     var defaultDataURL3 =\r\n       req.body.propertyList.platform_url + '/api/contract/items/' + req.body.queryParams.internalGmrRefNo\r\n     var defaultdata3 = {\r\n       method: 'GET',\r\n       url: defaultDataURL3,\r\n       headers: {\r\n         Authorization: req.headers.authorization,\r\n         'X-TenantID': req.headers['x-tenantid']\r\n       },\r\n       json: true\r\n     };\r\n     function get_defaultData3() {\r\n       return new Promise(function (resolve, reject) {\r\n         request(defaultdata3, function (err, response, body) {\r\n           if (err || body.error) reject(body);\r\n           else {\r\n             resolve(body);\r\n           }\r\n         });\r\n       });\r\n     }\r\n\t var defaultDataURL5 =\r\n      req.body.propertyList.platform_url + '/api/contract/gmr/';\r\n      var defaultdata5 = {\r\n        method: 'GET',\r\n        url: defaultDataURL5,\r\n        headers: {\r\n          Authorization: req.headers.authorization,\r\n          'X-TenantID': req.headers['x-tenantid']\r\n        },\r\n        json: true\r\n      };\r\n      function get_defaultData5() {\r\n        return new Promise(function(resolve, reject) {\r\n          request(defaultdata5, function(err, response, body) {\r\n            if (err || body.error) reject(body);\r\n            else {\r\n              resolve(body);\r\n            }\r\n          });\r\n        });\r\n      }\r\n      var defaultDataURL6 =\r\n      req.body.propertyList.eka_connect_host + '/workflow/data';\r\n      var dbody = {\r\n        \"appId\":\"5d907cd2-7785-4d34-bcda-aa84b2158415\",\r\n        \"workFlowTask\":\"gmr_executed_list\"\r\n      }\r\n      var defaultdata6 = {\r\n        method: 'POST',\r\n        url: defaultDataURL6,\r\n        body:dbody,\r\n        headers: {\r\n          Authorization: req.headers.authorization,\r\n          'X-TenantID': req.headers['x-tenantid']\r\n        },\r\n        json: true\r\n      };\r\n      function get_defaultData6() {\r\n        return new Promise(function(resolve, reject) {\r\n          request(defaultdata6, function(err, response, body) {\r\n            if (err || body.error) reject(body);\r\n            else {\r\n              resolve(body);\r\n            }\r\n          });\r\n        });\r\n      }\r\n    //   function wait(ms){\r\n    //     var start = new Date().getTime();\r\n    //     var end = start;\r\n    //     while(end < start + ms) {\r\n    //       end = new Date().getTime();\r\n    //    }\r\n    //  }\r\n     get_defaultData3().then(function (gmr_list) {\r\n       var componentDetails = []\r\n     var internalContractRefNo=[]\r\n      for(var k =0;k<gmr_list.items.length;k++){\r\n        internalContractRefNo.push(gmr_list.items[k].internalRefNo)\r\n      }\r\n      defaultdata.body.filterData.filter[0].value = internalContractRefNo\r\n       get_defaultData().then(function (contract) {\r\n         let contract_list = contract.data\r\n         for(var i=0;i<contract_list.length;i++){\r\n           for(var j =0;j<gmr_list.items.length;j++){\r\n               var itemno=Number(gmr_list.items[j].itemRefNo.split(gmr_list.items[j].refNo+'.')[1])\r\n               gmr_list.items[j]['formulaId']=contract_list[i].itemDetails[itemno-1].pricing.pricingFormulaId\r\n               gmr_list.items[j]['componentId']=contract_list[i].itemDetails[itemno-1].internalItemRefNo\r\n           }\r\n         }\r\n          get_defaultData2().then(function (formula) {\r\n           for(var i=0;i<formula.length;i++){\r\n             for(var j =0;j<gmr_list.items.length;j++){\r\n               if(gmr_list.items[j].formulaId===formula[i]._id){\r\n                 gmr_list.items[j]['expression']=formula[i].formulaName+'('+formula[i].newFormulaExp+')'\r\n               }\r\n             }\r\n           }\r\n\t \t   \r\n\tvar eka_trm_version = 913\r\n\tif(req.body.propertyList.eka_ctrm_version[0].value) eka_trm_version = Number(req.body.propertyList.eka_ctrm_version[0].value.split('.').join(''))\r\n\tif(eka_trm_version<914){\r\n\t \t    get_defaultData6().then(function (gmrDetail) {\r\n\t\t\tlet total = gmrDetail.data\r\n           for(var i=0;i<total.length;i++){\r\n             for(var j =0;j<gmr_list.items.length;j++){\r\n               if(gmr_list.items[j].componentId===total[i].internlContractItemRefNo && req.body.queryParams.internalGmrRefNo===total[i].internalGMRRefNo){\r\n                 gmr_list.items[j]['totalQuantity']=total[i].executedQuantity\r\n                 if(total[i].gmrQtyUnit){\r\n                  gmr_list.items[j]['totalQuantity'] =  gmr_list.items[j]['totalQuantity'] + ' '+total[i].gmrQtyUnit\r\n                 }\r\n                 break\r\n               }\r\n             }\r\n           }\r\n\t\t   \r\n         get_defaultData1().then(function (component) {\r\n           for(var j =0;j<gmr_list.items.length;j++){\r\n             gmr_list.items[j]['componentDetails'] = []\r\n           for(var i=0;i<component.length;i++){\r\n               if(gmr_list.items[j].componentId===component[i].internalContractItemRefNo && component[i].internalContractItemRefNo&&component[i].internalGmrRefNo === req.body.queryParams.internalGmrRefNo){\r\n\t\t\t      \r\n\t\t\t     component[i]['internalGmrRefNo'] = req.body.queryParams.internalGmrRefNo\r\n\t\t\t\t component[i]['gmrRefNo'] = req.body.queryParams.gmrRefNo\r\n                 gmr_list.items[j]['componentDetails'].push(component[i])\r\n                 if(gmr_list.items[j]['components'])\r\n                 gmr_list.items[j]['components']=gmr_list.items[j]['components']+','+component[i].productComponentName + '- ' + component[i].componentPercentage + '%'\r\n                 else{\r\n                 gmr_list.items[j]['components']=component[i].productComponentName + '- ' + component[i].componentPercentage + '%'\r\n                 }\r\n                 if(gmr_list.items[j]['actualQty'])\r\n                 gmr_list.items[j]['actualQty']=gmr_list.items[j]['actualQty']+','+component[i].productComponentName + '- ' + (((Number(component[i].componentPercentage)*Number(gmr_list.items[j]['totalQuantity']))/100).toFixed(2))\r\n                 else{\r\n                 gmr_list.items[j]['actualQty']=component[i].productComponentName + '- ' +  (((Number(component[i].componentPercentage)*Number(gmr_list.items[j]['totalQuantity']))/100).toFixed(2))\r\n                 }\r\n\t\t\t\t }\r\n \r\n               \r\n\t\t\t   \r\n             }\r\n           }\r\n\t\t    for(var j =0;j<gmr_list.items.length;j++){\r\n             \r\n\t\t\t if(gmr_list.items[j]['componentDetails'].length ==0){\r\n           for(var i=0;i<component.length;i++){\r\n               if(gmr_list.items[j].componentId===component[i].internalContractItemRefNo && component[i].internalContractItemRefNo){\r\n\t\t\t     component[i]['internalGmrRefNo'] = req.body.queryParams.internalGmrRefNo\r\n\t\t\t\t component[i]['gmrRefNo'] = req.body.queryParams.gmrRefNo\r\n                 gmr_list.items[j]['componentDetails'].push(component[i])\r\n                 if(gmr_list.items[j]['components'])\r\n                 gmr_list.items[j]['components']=gmr_list.items[j]['components']+','+component[i].productComponentName + '- ' + component[i].componentPercentage + '%'\r\n                 else{\r\n                 gmr_list.items[j]['components']=component[i].productComponentName + '- ' + component[i].componentPercentage + '%'\r\n                 }\r\n                 if(gmr_list.items[j]['actualQty'])\r\n                 gmr_list.items[j]['actualQty']=gmr_list.items[j]['actualQty']+','+component[i].productComponentName + '- ' + (((Number(component[i].componentPercentage)*Number(gmr_list.items[j]['totalQuantity']))/100).toFixed(2))\r\n                 else{\r\n                 gmr_list.items[j]['actualQty']=component[i].productComponentName + '- ' +  (((Number(component[i].componentPercentage)*Number(gmr_list.items[j]['totalQuantity']))/100).toFixed(2))\r\n                 }\r\n\t\t\t\t \r\n \r\n               }\r\n\t\t\t   \r\n             }\r\n           }\r\n\t\t   }\r\n           for(var i=0;i<gmr_list.items.length;i++){\r\n             if(gmr_list.items[i].components){\r\n             data.push({ \"actualQty\":gmr_list.items[i].actualQty,\"totalQuantity\":gmr_list.items[i].totalQuantity,\"itemRefNo\": gmr_list.items[i].itemRefNo, expression: gmr_list.items[i].expression, components: gmr_list.items[i].components, \"componentDetails\":  gmr_list.items[i].componentDetails});}\r\n           }\r\n            res.status(200).send(data);\r\n         }).catch(err => {\r\n         console.log(err);\r\n     res.status(500).send(err);\r\n       });\r\n      });\r\n\t\t   }\r\n\t\t   else{\r\n  Promise.all(gmr_list.items.map(group =>{\r\n    defaultdata5.url = req.body.propertyList.platform_url + '/api/contract/gmr/'+group.componentId;\r\n     return get_defaultData5()}))\r\n    .then(results => {\r\n      for(var i = 0;i<results.length;i++){\r\n        for(var j = 0;j<results[i].items.length;j++){\r\n          if(req.body.queryParams.internalGmrRefNo===results[i].items[j].internalRefNo){\r\n              gmr_list.items[i]['totalQuantity']=results[i].items[j].currenQty + ' ' + results[i].items[j].qtyUnit\r\n                }\r\n        }\r\n      }\r\n\t\t\r\n         get_defaultData1().then(function (component) {\r\n           for(var j =0;j<gmr_list.items.length;j++){\r\n             gmr_list.items[j]['componentDetails'] = []\r\n           for(var i=0;i<component.length;i++){\r\n               if(gmr_list.items[j].componentId===component[i].internalContractItemRefNo && component[i].internalContractItemRefNo&&component[i].internalGmrRefNo === req.body.queryParams.internalGmrRefNo){\r\n\t\t\t      \r\n\t\t\t     component[i]['internalGmrRefNo'] = req.body.queryParams.internalGmrRefNo\r\n\t\t\t\t component[i]['gmrRefNo'] = req.body.queryParams.gmrRefNo\r\n                 gmr_list.items[j]['componentDetails'].push(component[i])\r\n                 if(gmr_list.items[j]['components'])\r\n                 gmr_list.items[j]['components']=gmr_list.items[j]['components']+','+component[i].productComponentName + '- ' + component[i].componentPercentage + '%'\r\n                 else{\r\n                 gmr_list.items[j]['components']=component[i].productComponentName + '- ' + component[i].componentPercentage + '%'\r\n                 }\r\n\t\t\t\t if(gmr_list.items[j]['totalQuantity']){\r\n                 if(gmr_list.items[j]['actualQty'])\r\n                 gmr_list.items[j]['actualQty']=gmr_list.items[j]['actualQty']+','+component[i].productComponentName + '- ' + (((Number(component[i].componentPercentage)*Number(gmr_list.items[j]['totalQuantity'].split(' ')[0]))/100).toFixed(2))\r\n                 else{\r\n                 gmr_list.items[j]['actualQty']=component[i].productComponentName + '- ' +  (((Number(component[i].componentPercentage)*Number(gmr_list.items[j]['totalQuantity'].split(' ')[0]))/100).toFixed(2))\r\n                 }\r\n\t\t\t\t }\r\n\t\t\t\t }\r\n \r\n               \r\n\t\t\t   \r\n             }\r\n           }\r\n\t\t    for(var j =0;j<gmr_list.items.length;j++){\r\n             \r\n\t\t\t if(gmr_list.items[j]['componentDetails'].length ==0){\r\n           for(var i=0;i<component.length;i++){\r\n               if(gmr_list.items[j].componentId===component[i].internalContractItemRefNo && component[i].internalContractItemRefNo){\r\n\t\t\t     component[i]['internalGmrRefNo'] = req.body.queryParams.internalGmrRefNo\r\n\t\t\t\t component[i]['gmrRefNo'] = req.body.queryParams.gmrRefNo\r\n                 gmr_list.items[j]['componentDetails'].push(component[i])\r\n                 if(gmr_list.items[j]['components'])\r\n                 gmr_list.items[j]['components']=gmr_list.items[j]['components']+','+component[i].productComponentName + '- ' + component[i].componentPercentage + '%'\r\n                 else{\r\n                 gmr_list.items[j]['components']=component[i].productComponentName + '- ' + component[i].componentPercentage + '%'\r\n                 }\r\n\t\t\t\t if(gmr_list.items[j]['totalQuantity']){\r\n                 if(gmr_list.items[j]['actualQty'])\r\n                 gmr_list.items[j]['actualQty']=gmr_list.items[j]['actualQty']+','+component[i].productComponentName + '- ' + (((Number(component[i].componentPercentage)*Number(gmr_list.items[j]['totalQuantity'].split(' ')[0]))/100).toFixed(2))\r\n                 else{\r\n                 gmr_list.items[j]['actualQty']=component[i].productComponentName + '- ' +  (((Number(component[i].componentPercentage)*Number(gmr_list.items[j]['totalQuantity'].split(' ')[0]))/100).toFixed(2))\r\n                 }\r\n\t\t\t\t }\r\n \r\n               }\r\n\t\t\t   \r\n             }\r\n           }\r\n\t\t   }\r\n           for(var i=0;i<gmr_list.items.length;i++){\r\n             if(gmr_list.items[i].components){\r\n             data.push({ \"actualQty\":gmr_list.items[i].actualQty,\"internalItemRefNo\":gmr_list.items[i]['componentId'],\"internalGmrRefNo\":req.body.queryParams.internalGmrRefNo,\"totalQuantity\":gmr_list.items[i].totalQuantity,\"itemRefNo\": gmr_list.items[i].itemRefNo, expression: gmr_list.items[i].expression, components: gmr_list.items[i].components, \"componentDetails\":  gmr_list.items[i].componentDetails});}\r\n           }\r\n            res.status(200).send(data);\r\n         }).catch(err => {\r\n         console.log(err);\r\n     res.status(500).send(err);\r\n       });\r\n      })\r\n\t  }\r\n      \r\n       }).catch(err => {\r\n         console.log(err);\r\n     res.status(500).send(err);\r\n       });\r\n       }).catch(err => {\r\n         console.log(err);\r\n     res.status(500).send(err);\r\n       });\r\n     }).catch(err => {\r\n         console.log(err);\r\n     res.status(500).send(err);\r\n       });\r\n       ;\r\n\r\n  ",
    "sys__UUID" : "9cfab60d-eb39-4966-83e2-16edcc682843",
    "sys__createdOn" : ISODate("2019-05-22T09:51:04.600Z"),
    "sys__createdBy" : "avinash.singh@ekaplus.com"
}