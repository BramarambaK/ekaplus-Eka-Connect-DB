{
  "_id": "validateallocatetickets_processor",
  "name": "validateallocatetickets_processor",
  "type": "processor",
  "refType": "app",
  "refTypeId": "12325a98-a959-4939-9005-4158d136afcd",
  "snippet": "var moment = require('moment')\r\n    const send = (status, message) => res.status(status).send(message);\r\n    const data = req.body.bulkPayLoadData || [];\r\n    const AESToffset = 10 * 60 * 60 * 1000;\r\n    const miliInDay = 24 * 60 * 60 * 1000;\r\n\r\n    if (data.length > 0) {\r\n      const beforeStartDate =\r\n        data.filter(i => i.sellingOption == 'Contract' && i.acquirer.split('#')[1] && i.shipmentStartDate && ((new Date(i.shipmentStartDate)).getTime() - AESToffset > (new Date()).getTime())) || [];\r\n      const afterEndDate =\r\n        data.filter(i => i.sellingOption == 'Contract' && i.acquirer.split('#')[1] && i.shipmentEndDate && ((new Date(i.shipmentEndDate)).getTime() - AESToffset + miliInDay < (new Date()).getTime())) || [];\r\n      const nonFixedSpread =\r\n        data.filter(i => i.sellingOption == 'Contract' && i.acquirer.split('#')[1] && i.isMultiGrade == 'Y' && i.spread && i.spread.toLowerCase() != 'fixed') || [];\r\n      const unapprovedContract =\r\n        data.filter(i => i.sellingOption == 'Contract' && i.acquirer.split('#')[1] && i.approvalStatus && i.approvalStatus.toLowerCase() != 'approved' && i.approvalStatus.toLowerCase() != 'withdrawn' && i.approvalStatus.toLowerCase() != 'rejected') || [];\r\n\r\n      if (unapprovedContract.length > 0)\r\n        send(400, 'You cannot proceed to allocate tickets to this contract. Contract amendment pending approval.');\r\n      else if (nonFixedSpread.length > 0)\r\n        send(400, 'You cannot proceed to allocate tickets to this contract. Grade spreads must be fixed via Request Contract Amendment, before Tickets can be allocated. If you have not fixed the Grade spreads prior to the Fix Price Date, please contact Cargill.');\r\n      else if (beforeStartDate.length > 0) send(400, 'Delivery period of selected contract has not opened yet.');\r\n      else if (afterEndDate.length > 0) send(400, 'Delivery period of selected contract has closed.');\r\n      else send(200, data);\r\n    } else send(400, 'No data to be saved');",
  "sys__UUID": "3e439cb4-57b4-4558-94a1-00dbf1c3abdb"
}
