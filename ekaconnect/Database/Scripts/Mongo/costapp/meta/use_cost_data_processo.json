{
    "_id" : "use_cost_data_processor",
    "name" : "usecost",
    "type" : "processor",
    "refType" : "app",
    "refTypeId" : "d33143ac-4164-4a3f-8d30-61d845c9eeed",
    "snippet" : "var connectData = {\r\n      method: 'GET',\r\n      url:\r\n        req.body.propertyList.eka_connect_host +\r\n        '/data/d33143ac-4164-4a3f-8d30-61d845c9eeed/2f787174-8ed0-4d5d-8f93-b38ab0edc05a',\r\n      headers: {\r\n        Authorization: req.headers.authorization,\r\n        'X-TenantID': req.headers['x-tenantid'],\r\n        json: true\r\n      }\r\n    };\r\n\r\n    function get_connectData() {\r\n      return new Promise(function(resolve, reject) {\r\n        request(connectData, function(err, response, body) {\r\n          if (response.statusCode >= 200 && response.statusCode <= 299) {\r\n            resolve(body);\r\n          } else {\r\n            reject(body);\r\n          }\r\n        });\r\n      });\r\n    }\r\n    var costcomponents = {\r\n      method: 'POST',\r\n      url: req.body.propertyList.eka_ctrm_host + '/mdmapi/data',\r\n      headers: {\r\n        Authorization: req.headers.authorization\r\n      },\r\n      body: [\r\n        {\r\n          serviceKey: 'costcomponents',\r\n          attributeThree: 'CONTRACT',\r\n          attributeone: 'CONTRACT'\r\n        }\r\n      ],\r\n      json: true\r\n    };\r\n    function get_costcomponents() {\r\n      return new Promise(function(resolve, reject) {\r\n        request(costcomponents, function(err, response, body) {\r\n          console.log('Request Body - ' + JSON.stringify(body));\r\n          if (response.statusCode >= 200 && response.statusCode <= 299) {\r\n            resolve(body);\r\n          } else {\r\n            reject(body);\r\n          }\r\n        });\r\n      });\r\n    }\r\n\r\n    get_connectData()\r\n      .then(function(result) {\r\n        get_costcomponents().then(costcomponents => {\r\n          var validcostcomponents = costcomponents.hasOwnProperty('costcomponents') ? costcomponents.costcomponents : []\r\n          validcostcomponents = validcostcomponents.reduce((acc,item)=>{\r\n            acc[item.key] = 'true'\r\n            return acc\r\n          },{})\r\n          var selectedData = JSON.parse(result);\r\n          selectedData = selectedData.filter((item) => {\r\n            if(item.hasOwnProperty('costComponent') && item.costComponent in validcostcomponents){\r\n              return item\r\n            }\r\n          })\r\n          var finalData = [];\r\n          var flatFlag = false;\r\n\r\n          if (req.body.queryParams.priceType === 'Flat') flatFlag = true;\r\n          for (var i = 0; i < selectedData.length; i++) {\r\n            delete selectedData[i].object;\r\n            delete selectedData[i].sys__UUID;\r\n            delete selectedData[i].sys__createdOn;\r\n            delete selectedData[i].sys__createdBy;\r\n            delete selectedData[i].sys__state;\r\n            delete selectedData[i]._id;\r\n            delete selectedData[i].userId;\r\n            delete selectedData[i].sys__updatedBy;\r\n            delete selectedData[i].sys__updatedOn;\r\n            delete selectedData[i].refTypeId;\r\n            delete selectedData[i].refType;\r\n            delete selectedData[i].sys__version;\r\n            delete selectedData[i].sys__data__state;\r\n            selectedData[i] = {\r\n              ...selectedData[i],\r\n              ...req.body.queryParams\r\n            };\r\n            if (flatFlag) finalData.push(selectedData[i]);\r\n            else if (selectedData[i].rateTypePrice != '% of Price') finalData.push(selectedData[i]);\r\n          }\r\n          res.status(200).send(finalData);\r\n        });\r\n      })\r\n      .catch(err => {\r\n        res.status(500).send('failed to connect to mdmapi');\r\n      });\r\n  ",
    "sys__UUID" : "fffad4dc-f14e-4b96-bfc4-df483965a124",
    "sys__createdBy" : "srini@ekaplus.com"
}