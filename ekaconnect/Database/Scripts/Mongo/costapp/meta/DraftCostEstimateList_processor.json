{
    "_id" : "draft_list_and_save",
    "name" : "DraftCostEstimateList",
    "type" : "processor",
    "refType" : "app",
    "refTypeId" : "d33143ac-4164-4a3f-8d30-61d845c9eeed",
    "snippet" : "var paramString = \"\";\r\nvar contractType;\r\nvar object = \"00189ca9-cfc1-4327-95ac-f937f22deb60\";\r\nfor (var key in req.body.queryParams) {\r\n  if (key === \"entityType\" || key === \"draftEstimateNo\") {\r\n    if (paramString) {\r\n      paramString = paramString + \"&\";\r\n    }\r\n    paramString = paramString + key + \"=\" + req.body.queryParams[key];\r\n  }\r\n}\r\nif (\r\n  req.body.queryParams.contractType &&\r\n  req.body.queryParams.contractType == \"P\"\r\n)\r\n  contractType = \"Purchase\";\r\nelse if (\r\n  req.body.queryParams.contractType &&\r\n  req.body.queryParams.contractType == \"S\"\r\n)\r\n  contractType = \"Sale\";\r\nvar saveBody = {\r\n  attributes: [\r\n    {\r\n      attributeName: \"Contract Type\",\r\n      attributeValue: contractType,\r\n    },\r\n    {\r\n      attributeName: \"Contract Incoterm\",\r\n      attributeValue: req.body.queryParams.contractIncoTerm,\r\n    },\r\n    {\r\n      attributeName: \"Valuation Incoterm\",\r\n      attributeValue: req.body.queryParams.valuationIncoTerm,\r\n    },\r\n    {\r\n      attributeName: \"Payment Term\",\r\n      attributeValue: req.body.queryParams.paymentTerm,\r\n    },\r\n  ],\r\n  draftEstimateNo: req.body.queryParams.draftEstimateNo,\r\n  entityType: req.body.queryParams.entityType,\r\n};\r\nvar connectData = {\r\n  method: \"GET\",\r\n  url:\r\n    req.body.propertyList.eka_connect_host +\r\n    `\/data\/d33143ac-4164-4a3f-8d30-61d845c9eeed\/${object}?${paramString}`,\r\n  headers: {\r\n    Authorization: req.headers.authorization,\r\n    \"X-TenantID\": req.headers[\"x-tenantid\"],\r\n    json: true,\r\n  },\r\n};\r\nfunction get_connectData() {\r\n  return new Promise(function (resolve, reject) {\r\n    request(connectData, function (err, response, body) {\r\n      if (err || body.error) reject(body);\r\n      else {\r\n        resolve(body);\r\n      }\r\n    });\r\n  });\r\n}\r\nvar saveToDraft = {\r\n  method: \"POST\",\r\n  url:\r\n    req.body.propertyList.eka_utility_host +\r\n    \"\/costapp\/saveMandatoryCostsToDraft\",\r\n  headers: {\r\n    Authorization: req.headers.authorization,\r\n    \"X-TenantID\": req.headers[\"x-tenantid\"],\r\n  },\r\n  json: true,\r\n  body: saveBody,\r\n};\r\nfunction save_draft() {\r\n  return new Promise(function (resolve, reject) {\r\n    request(saveToDraft, function (err, response, body) {\r\n      if (err || body.error) reject(body);\r\n      else {\r\n        resolve(body);\r\n      }\r\n    });\r\n  });\r\n}\r\nvar updateDrafts = {\r\n  method: \"POST\",\r\n  url:\r\n    req.body.propertyList.eka_utility_host +\r\n    \"\/costapp\/v1\/updateContractItemCostEstimates\",\r\n  headers: {\r\n    Authorization: req.headers.authorization,\r\n    \"X-TenantID\": req.headers[\"x-tenantid\"],\r\n  },\r\n  json: true,\r\n  body: req.body.queryParams,\r\n};\r\nfunction update_drafts() {\r\n  return new Promise(function (resolve, reject) {\r\n    request(updateDrafts, function (err, response, body) {\r\n      if (err || body.error) reject(body);\r\n      else {\r\n        resolve(body);\r\n      }\r\n    });\r\n  });\r\n}\r\n\r\n\/\/Get corporateId and corporateName from mdm\r\nvar ctrm_corporate_details = {\r\n  method: \"GET\",\r\n  url:\r\n    req.body.propertyList.eka_trm_physicals_api_host +\r\n    \"\/user\/data\",\r\n  headers: {\r\n    Authorization: req.headers.authorization,\r\n    \"X-TenantID\": req.headers[\"x-tenantid\"],\r\n    \"Content-Type\":\"application\/json\",\r\n    \"Accept\":\"application\/json\",\r\n    \"Connection\": \"keep-alive\"\r\n  },\r\n  json: true,\r\n  body: {},\r\n};\r\n\r\nfunction get_ctrm_corporate_details() {\r\n  return new Promise(function (resolve, reject) {\r\n    console.log(\"Request URL- \" + ctrm_corporate_details.url);\r\n    request(ctrm_corporate_details, function (err, response, body) {\r\n      console.log(\"Response - \" + JSON.stringify(body));\r\n      if (err || body.error) reject(body);\r\n      else {\r\n        console.log(\"Success\");\r\n        resolve(body);\r\n      }\r\n    });\r\n  });\r\n}\r\n\r\nget_ctrm_corporate_details().then(function (corporateDetails) {\r\n    if (corporateDetails.corporateId) {\r\n        saveBody.attributes.push(\r\n            {\r\n                attributeName: \"corporateId\",\r\n                attributeValue: corporateDetails.corporateId,\r\n            });\r\n      }\r\n      else {\r\n        res.status(500).send(\"corporateId is fetched empty\/null from mdm\");\r\n      }\r\n      if (corporateDetails.corporateDO.corporateName) {\r\n        saveBody.attributes.push(\r\n            {\r\n                attributeName: \"corporateName\",\r\n                attributeValue: corporateDetails.corporateDO.corporateName,\r\n            });\r\n      }\r\n      else {\r\n        res.status(500).send(\"corporateName is fetched empty\/null from mdm\");\r\n      }\r\n    save_draft().then(function (data) {\r\n        update_drafts().then(function (updatedData) {\r\n            get_connectData().then(function (result) {\r\n            result = JSON.parse(result);\r\n            res.status(200).send(result);\r\n            });\r\n        });\r\n    });\r\n});\r\n",
    "sys__UUID" : "a5ef899d-f31f-4b16-a448-1722125a4853"
}