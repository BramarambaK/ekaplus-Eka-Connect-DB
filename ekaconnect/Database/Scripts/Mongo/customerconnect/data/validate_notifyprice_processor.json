{
    "_id" : "validate_notifyprice_processor",
    "name" : "validate_notifyprice_processor",
    "type" : "processor",
    "refType" : "app",
    "refTypeId" : "12325a98-a959-4939-9005-4158d136afcd",
    "snippet" : "const getRequestBody = (url) => ({\r\n      method: 'GET',\r\n      url,\r\n      headers: {\r\n        Authorization: req.headers.authorization,\r\n        'X-TenantID': req.headers['x-tenantid']\r\n      },\r\n      json: true\r\n    });\r\n  \r\n    const connectPriceData = (queryparams) => getRequestBody(setQueryParams(req.body.propertyList.eka_connect_host +\r\n      \"\/data\/12325a98-a959-4939-9005-4158d136afcd\/8f13785a-0475-47c5-ab59-f42c132d6a33\", queryparams));\r\n    const connectVolumeLimitsData = (queryparams) => getRequestBody(setQueryParams(req.body.propertyList.eka_connect_host + \r\n      '\/data\/12325a98-a959-4939-9005-4158d136afcd\/c98119db-1f7c-4802-b72a-6678f1ecc0f3',queryparams));\r\n    function setQueryParams(url,queryparams) {\r\n      let _urlParams = [];\r\n      for(let i in queryparams){\r\n      _urlParams.push(`${i}=${queryparams[i]}`);\r\n    }\r\n    return url+'?'+_urlParams.join('&');\r\n    }\r\n    function getData(requestBody) {\r\n      return new Promise(function(resolve, reject) {\r\n        request(requestBody, function(err, response, body) {\r\n          if (response.statusCode >= 200 && response.statusCode <= 299) {\r\n            resolve(body);\r\n          } else {\r\n            reject(body);\r\n          }\r\n        });\r\n      });\r\n    }\r\n     \r\n    let requetParams = {};\r\n    const tonnagelimits = req.body.bulkPayLoadData\r\n    let arr = [];\r\n    if(tonnagelimits) {\r\n        tonnagelimits.forEach(function (tonnagelimit) {\r\n          let message = '';\r\n          requetParams = {\r\n            account: tonnagelimit.account,\r\n            harvestseason: tonnagelimit.harvestseason,\r\n            grade: tonnagelimit.grade,\r\n            site: tonnagelimit.site\r\n          }\r\n          getData(connectVolumeLimitsData(requetParams))\r\n            .then(function (volumelists) {\r\n              if(volumelists && volumelists.length > 0) {\r\n              volumelists.forEach(volumelist => {\r\n                if(volumelist) {\r\n                  if(tonnagelimit.account == volumelist.account \r\n                    && tonnagelimit.harvestseason == volumelist.harvestseason) {\r\n                    tonnagelimit.commodity = volumelist.commodity;\r\n                    tonnagelimit.portzone = volumelist.portzone;\r\n                    let reqParam = {commodity : volumelist.commodity};\r\n                    getData(connectPriceData(reqParam)).\r\n                    then(function (price) {\r\n                      if(price && price.length > 0) { \r\n                          if(parseInt(price[0].minimumValue) < parseInt(tonnagelimit.prices) && parseInt(tonnagelimit.prices) < parseInt(price[0].maximumValue) ) {\r\n                            let startdate = Date.parse(tonnagelimit.startdate);\r\n                            let enddate = Date.parse(tonnagelimit.enddate);\r\n                            if (startdate > enddate) {\r\n                              message = \"Start Date cannot br greater than End Date\";\r\n                              arr.push(`false@${message}`);\r\n                            } else {\r\n                              arr.push('true@');\r\n                            }\r\n                          } else {\r\n                            message = \"Price should be in between min and max price\";\r\n                            arr.push(`false@${message}`);\r\n                          }\r\n                      }\r\n                      let flag;\r\n                      for (let index = 0; index < arr.length; index++) {\r\n                        var temp = arr[index].split('@')[0];\r\n                        if(temp == 'false') {\r\n                          flag = false;\r\n                          res.status(500).send(arr[index].split('@')[1]);  \r\n                        } \r\n                        flag = true;\r\n                      }\r\n                      if(flag && arr.length == tonnagelimits.length) {\r\n                        res.status(200).send(tonnagelimits) \r\n                      }\r\n                    }).catch(console.log);\r\n                  }\r\n                }\r\n              }) \r\n             }\r\n            }).catch(console.log);\r\n          })\r\n      } ",
    "sys__UUID" : "4536a35a-509d-40da-9edc-3f149230ebe7"
}