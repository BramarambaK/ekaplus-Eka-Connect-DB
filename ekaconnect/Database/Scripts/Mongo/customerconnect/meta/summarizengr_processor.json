{
  "_id": "summarizengr_processor",
  "name": "summarizengr_processor",
  "type": "processor",
  "refType": "app",
  "refTypeId": "12325a98-a959-4939-9005-4158d136afcd",
  "snippet": " const dataToSend = {\r\n      submittickettransfertableview: [],\r\n      selectedtickets: []\r\n    };\r\n    const send = (status, message) => res.status(status).send(message);\r\n    const formElementName = 'ngrdetails';\r\n    const commonMessage = 'Entry errors identified. Please review your inputs.';\r\n    const data = req.body.data.map((i, index) => ({ ...i, _groupNo: i._groupNo || index })) || [];\r\n    const findEmptyField = data => (field, callback) => {\r\n      const e = data.filter(i => (i.transferMethod == 'By tonnage' ? i[field] > i.totalQuantity : i[field] > 100));\r\n      if (e && e.length > 0) {\r\n        const msg = callback(e);\r\n        return {\r\n          errorCode: '004',\r\n          errorMessage: msg,\r\n          errorContext: null,\r\n          errorLocalizedMessage: msg,\r\n          errors: [\r\n            {\r\n              errorCode: '004',\r\n              errorMessage: msg,\r\n              errorContext: `{formarray:ngrdetails}`,\r\n              errorLocalizedMessage: msg,\r\n              errors: [\r\n                ...e.reduce((acc, curr) => {\r\n                  acc.add(curr._groupNo);\r\n                  return acc;\r\n                }, new Set())\r\n              ].map(i => ({\r\n                errorCode: '004',\r\n                errorMessage: msg,\r\n                errorContext: `{formarray:${i}}`,\r\n                errorLocalizedMessage: msg,\r\n                errors: [\r\n                  {\r\n                    errorCode: '004',\r\n                    errorMessage: msg,\r\n                    errorContext: `{field:${field}}`,\r\n                    errorLocalizedMessage: msg,\r\n                    errors: null\r\n                  }\r\n                ]\r\n              }))\r\n            }\r\n          ]\r\n        };\r\n      }\r\n      return null;\r\n    };\r\n\r\n    const invalidMessages = [\r\n      {\r\n        key: 'transferquantitypercentage',\r\n        message: () => `Cannot exceed 100%`\r\n      }\r\n    ];\r\n    const invalidMessagestonnage = [\r\n      {\r\n        key: 'transferqty',\r\n        message: () => `Cannot exceed total quantity`\r\n      }\r\n    ];\r\n    try {\r\n      if (data.length > 0) {\r\n        if (data.length <= 10) {\r\n          const _findEmptyField = findEmptyField(data);\r\n          let errormsgs = [];\r\n          if (data[0].transferMethod === 'By tonnage') errormsgs = invalidMessagestonnage;\r\n          else errormsgs = invalidMessages;\r\n          for (let i of errormsgs) {\r\n            const error = _findEmptyField(i.key, i.message);\r\n            if (error) {\r\n              return send(400, error);\r\n            } else {\r\n              data[0].bpName = req.body.bpName;\r\n              data[0].bpRefNo = req.body.bpRefNo;\r\n              dataToSend.submittickettransfertableview = data;\r\n              dataToSend.selectedtickets = req.body.selectedtickets;\r\n              let totalQuantity = data[0].totalQuantity;\r\n              let exceedQuantity = data.reduce((acc, curr) => {\r\n                if (curr.transferMethod !== 'By tonnage') {\r\n                  acc += curr.transferquantity;\r\n                } else {\r\n                  acc += curr.transferqty;\r\n                }\r\n                return acc;\r\n              }, 0);\r\n              if (data.length > 1 && Number(exceedQuantity.toFixed(2)) !== Number(totalQuantity)) {\r\n                send(400, {\r\n                  errorCode: '004',\r\n                  errorMessage: 'Must match total transfer quantity',\r\n                  errorContext: null,\r\n                  errorLocalizedMessage: 'Must match total transfer quantity'\r\n                });\r\n              } else if (Number(exceedQuantity.toFixed(2)) > Number(totalQuantity)) {\r\n                send(400, {\r\n                  errorCode: '004',\r\n                  errorMessage: 'Please review your inputs, transfer quantity exceeds total quantity',\r\n                  errorContext: null,\r\n                  errorLocalizedMessage: 'Please review your inputs, transfer quantity exceeds total quantity'\r\n                });\r\n              } else {\r\n                send(200, dataToSend);\r\n              }\r\n            }\r\n          }\r\n        } else {\r\n          send(400, 'Maximum of 4 records are allowed');\r\n        }\r\n      } else {\r\n        send(400, 'No data to be saved');\r\n      }\r\n    } catch (err) {\r\n      send(500, {\r\n        errorCode: '004',\r\n        errorMessage: err.message || err,\r\n        errorContext: err.message || err,\r\n        errorLocalizedMessage: 'Internal server error'\r\n      });\r\n    }",
  "sys__UUID": "34a67153-5695-4187-9d46-20bd521200fc"
}
