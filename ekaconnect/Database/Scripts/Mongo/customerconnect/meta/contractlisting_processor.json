{
  "_id": "contractlisting_processor",
  "name": "contractlisting_processor",
  "type": "processor",
  "refType": "app",
  "refTypeId": "12325a98-a959-4939-9005-4158d136afcd",
  "snippet": "const userInfo = req.body.propertyList.eka_connect_host + '/api/userinfo';\r\nconst getData_ = url =>\r\n  new Promise(function(resolve, reject) {\r\n    request(\r\n      {\r\n        method: 'GET',\r\n        url,\r\n        headers: {\r\n          Authorization: req.headers.authorization,\r\n          'Content-Type': 'application/json',\r\n          'X-TenantID': req.headers['x-tenantid']\r\n        },\r\n        json: true\r\n      },\r\n      function(err, response, body) {\r\n        if (response && response.statusCode >= 200 && response.statusCode <= 299) {\r\n          resolve(body);\r\n        } else {\r\n          reject(body);\r\n        }\r\n      }\r\n    );\r\n  });\r\n\r\nconst connect = {\r\n  method: 'POST',\r\n  url: req.body.propertyList.eka_connect_host + `/workflow/data/`,\r\n  headers: {\r\n    Authorization: req.headers.authorization,\r\n    'X-TenantID': req.headers['x-tenantid']\r\n  },\r\n  body: {\r\n    appId: '12325a98-a959-4939-9005-4158d136afcd',\r\n    workFlowTask: 'contractqueryElastic',\r\n    qP: {\r\n      from: 0,\r\n      size: 10000,\r\n      sort: [\r\n        {\r\n          'sys__updatedOn.raw': {\r\n            order: 'desc'\r\n          }\r\n        },\r\n        {\r\n          'requestIdUnique.raw': {\r\n            order: 'desc'\r\n          }\r\n        }\r\n      ]\r\n    }\r\n  },\r\n  json: true\r\n};\r\n\r\nfunction get_elasticData() {\r\n  return new Promise(function(resolve, reject) {\r\n    request(connect, function(error, response, body) {\r\n      if (response.statusCode >= 200 && response.statusCode <= 299) {\r\n        resolve(body);\r\n      } else {\r\n        reject(body);\r\n      }\r\n    });\r\n  });\r\n}\r\n\r\n// getData_(userInfo)\r\n//   .then(t => {\r\n    get_elasticData()\r\n      .then(records => {\r\n        let sysTemp = [\r\n          'contractRefNo',\r\n          'product',\r\n          'quality',\r\n          'cropYear',\r\n          'contractItemQuantityInBase',\r\n          'itemOpenQuantityInBase',\r\n          'priceDetails',\r\n          'dischargeLocationCity',\r\n          'INCOTerm',\r\n          'shipmentPeriodFrom',\r\n          'shipmentPeriodTo',\r\n          'brokerRefNo',\r\n          'requestId',\r\n          'contractItemQuantity',\r\n          'contractPrice',\r\n          'requestType',\r\n          'requestedDate',\r\n          'requestedBy',\r\n          'bidid',\r\n          'approvalStatus',\r\n          'shipmentFrom',\r\n          'shipmentTo'\r\n        ].reduce((acc, curr) => ({ ...acc, [curr]: { show: true } }), {});\r\n        let result = records.data.map(i => {\r\n          i.contractStatus = [];\r\n          let directDelivery = !i.isDirectDelivery ? 'n' : i.isDirectDelivery.toLowerCase() == 'y' ? 'y' : 'n';\r\n          i.sys__state = { ...sysTemp, contractRefNo: { hyperlink: false }, contractRefNo: { show: true } };\r\n          //   if (\r\n          //     (i.hasOwnProperty('contractRefNo') && i.approvalStatus == 'Approved') ||\r\n          //     (i.hasOwnProperty('contractRefNo') &&\r\n          //       (i.approvalStatus == 'Rejected' || i.approvalStatus == 'Withdrawn'))\r\n          //   ) {\r\n          //     i.sys__state.contractRefNo.hyperlink = true;\r\n          //   } else {\r\n          //     i.sys__state.contractRefNo.hyperlink = false;\r\n          //   }\r\n          if(i.contractRefNo && i.contractRefNo !='-') {\r\n            i.sys__state.contractRefNo.hyperlink = true;  \r\n          } else {\r\n            i.sys__state.contractRefNo.hyperlink = false;\r\n          }\r\n          if (i.isRequestedByEkaCCSystem) {\r\n            // if (i.requestedBy == t.email || i.requestedBy == t.firstName + ' ' + t.lastName) {\r\n              i.shipmentFrom = i.amendedShipmentFrom ? moment(i.amendedShipmentFrom).format('DD/MM/YYYY') : i.shipmentPeriodFrom ? moment(i.shipmentPeriodFrom).format('DD/MM/YYYY') : '-';\r\n              i.shipmentTo =  i.amendedShipmentTo ? moment(i.amendedShipmentTo).format('DD/MM/YYYY') : i.shipmentPeriodTo ? moment(i.shipmentPeriodTo).format('DD/MM/YYYY') : '-';\r\n              i.contractStatus.push('Requests');\r\n            // }\r\n          } else {\r\n            if (\r\n              (i.fulfillmentStatus && i.fulfillmentStatus.toLowerCase() === 'fulfilled') ||\r\n              (i.positionStatus && i.positionStatus.toLowerCase() == 'cancelled') || (i.isDirectDelivery && i.isDirectDelivery.toLowerCase() == 'y')\r\n            ) {\r\n              i.shipmentFrom = i.amendedShipmentFrom ? moment(i.amendedShipmentFrom).format('DD/MM/YYYY') : i.shipmentPeriodFrom ? moment(i.shipmentPeriodFrom).format('DD/MM/YYYY') : '-';\r\n              i.shipmentTo =  i.amendedShipmentTo ? moment(i.amendedShipmentTo).format('DD/MM/YYYY') : i.shipmentPeriodTo ? moment(i.shipmentPeriodTo).format('DD/MM/YYYY') : '-';\r\n              i.contractStatus.push('Complete');\r\n            }\r\n            if (\r\n              i.fulfillmentStatus &&\r\n              i.fulfillmentStatus.toLowerCase() != 'fulfilled' &&\r\n              i.positionStatus &&\r\n              i.positionStatus.toLowerCase() != 'cancelled' &&\r\n              directDelivery.toLowerCase() != 'y'\r\n            ) {\r\n              i.contractStatus.push('Open');\r\n            }\r\n          }\r\n\r\n          return i;\r\n        });\r\n        res.status(200).send(result);\r\n      })\r\n      .catch(function(err) {\r\n        return res.status(500).send(err);\r\n      });\r\n  // })\r\n  // .catch(err => {\r\n  //   console.error(err);\r\n  //   return res.status(400).send('Error in fetching logged-in user details.');\r\n  // });",
  "sys__UUID": "eacf1a50-10f5-4b18-9f45-26885211228f"
}
