{
  "_id": "ticketsComposite_processor",
  "name": "ticketsComposite_processor",
  "type": "processor",
  "refType": "app",
  "refTypeId": "12325a98-a959-4939-9005-4158d136afcd",
  "snippet": "const connect = {\r\n  method: 'POST',\r\n  url: req.body.propertyList.eka_connect_host + `/workflow/data/`,\r\n  headers: {\r\n    Authorization: req.headers.authorization,\r\n    'X-TenantID': req.headers['x-tenantid'],\r\n  },\r\n  body: {\r\n    appId: '12325a98-a959-4939-9005-4158d136afcd',\r\n    workFlowTask: 'ticketsqueryElastic',\r\n    qP: {\r\n      from: 0,\r\n      size: 10000,\r\n    },\r\n  },\r\n  json: true,\r\n};\r\n\r\nfunction get_elasticData() {\r\n  return new Promise(function (resolve, reject) {\r\n    request(connect, function (error, response, body) {\r\n      if (response.statusCode >= 200 && response.statusCode <= 299) {\r\n        resolve(body);\r\n      } else {\r\n        reject(body);\r\n      }\r\n    });\r\n  });\r\n}\r\n\r\nget_elasticData()\r\n  .then((data) => {\r\n    let currentYear;\r\n    let result = data.data.filter((i) => {\r\n      if (i.location && i.bulkHandler) {\r\n        i.bulkHandler = i.location + ' - ' + i.bulkHandler;\r\n      }\r\n      if (i.ticketStatus == 'Complete' && i.cropYear == '2021/2022') {\r\n        currentYear = '2021/2022';\r\n      } else if (\r\n        !currentYear &&\r\n        i.ticketStatus == 'Complete' &&\r\n        i.cropYear == '2020/2021'\r\n      ) {\r\n        currentYear = '2020/2021';\r\n      }\r\n      if (\r\n        i.ticketStatus !== 'Complete' ||\r\n        (i.ticketStatus == 'Complete' &&\r\n          currentYear &&\r\n          i.cropYear == currentYear)\r\n      ) {\r\n        return i;\r\n      }\r\n    });\r\n    let latestYearData = result.filter((data) => {\r\n      if (data.ticketStatus == 'Complete' && data.cropYear == currentYear) {\r\n        data.currentYear = currentYear;\r\n        return data;\r\n      }\r\n      if (data.ticketStatus !== 'Complete') {\r\n        data.currentYear = currentYear;\r\n        return data;\r\n      }\r\n    });\r\n\r\n    res.status(200).send(latestYearData);\r\n  })\r\n  .catch(function (err) {\r\n    return res.status(500).send(err);\r\n  });\r\n",
  "sys__UUID": "8a2e3983-bdfb-4797-b3e0-aefe10d8260b"
}
