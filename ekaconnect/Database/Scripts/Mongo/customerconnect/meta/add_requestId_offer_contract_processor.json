{
  "_id": "add_requestId_offer_contract_processor",
  "name": "add_requestId_processor",
  "refType": "app",
  "refTypeId": "12325a98-a959-4939-9005-4158d136afcd",
  "snippet": "var payloadData;\r\nif(!Array.isArray(req.body.bulkPayLoadData)){\r\n  payloadData =[{...req.body}];\r\n  delete payloadData[0]['processorDetails'];\r\n  delete payloadData[0]['propertyList'];\r\n}\r\nelse{\r\n  payloadData = req.body.bulkPayLoadData;\r\n}\r\nvar moment = require('moment');\r\nvar requestConnectData = {\r\n  method: 'POST',\r\n  url: req.body.propertyList.eka_connect_host + '\/workflow',\r\n  headers: {\r\n    Authorization: req.headers.authorization,\r\n    'X-TenantID': req.headers['x-tenantid'],\r\n    requestid: req.headers['requestid'] + '-processor',\r\n  },\r\n  body: {\r\n    output: {\r\n      push_contractRequestData: [],\r\n    },\r\n    task: 'push_contractRequestData',\r\n    appId: '12325a98-a959-4939-9005-4158d136afcd',\r\n    workflowTaskName: 'push_contractRequestData',\r\n  },\r\n  json: true,\r\n};\r\nvar requestDetails = {\r\n  requestType: 'Offer to sell',\r\n  requestedDate: moment.utc().format('DD-MM-YYYY'),\r\n  requestedBy: 'Eka Customer Connect',\r\n  isRequestActive: true\r\n};\r\n\r\nfunction get_requestconnectData() {\r\n  return new Promise(function (resolve, reject) {\r\n    \/\/ console.log('get_requestconnectData Request-' +JSON.stringify(requestConnectData));\r\n    request(requestConnectData, function (err, response, body) {\r\n        \/\/ console.log('get_requestconnectData Response-' + JSON.stringify(body));\r\n      if (response.statusCode === 200) resolve(body);\r\n      else {\r\n        reject(err || body);\r\n      }\r\n    });\r\n  });\r\n}\r\n\r\n(async () => {\r\n  for (let i = 0; i < payloadData.length; i++) {\r\n    if (payloadData[i].isRequestedByEkaCCSystem && !payloadData[i].requestId)\r\n      requestConnectData.body.output.push_contractRequestData.push(\r\n        {...requestDetails, requestPayload: payloadData[i]}\r\n      );\r\n  }\r\n\r\n  var requestIdResponse;\r\n  if (requestConnectData.body.output.push_contractRequestData.length > 0)\r\n    requestIdResponse = await get_requestconnectData();\r\n  for (let i = 0; i < payloadData.length; i++) {\r\n    if (payloadData[i].isRequestedByEkaCCSystem && !payloadData[i].requestIdUnique) {\r\n      payloadData[i].requestId = requestIdResponse.data.pop().requestId;\r\n      payloadData[i].requestIdUnique = payloadData[i].requestId + '-';\r\n      payloadData[i].requestDateUTC = moment.utc().format('YYYY-MM-DDTHH:mm:ss.SSS[Z]');\r\n    } \r\n    else if(!payloadData[i].requestIdUnique && !payloadData[i].isRequestedByEkaCCSystem) {\r\n        payloadData[i].requestIdUnique = '-';\r\n    }\r\n  }\r\n  \/\/ console.log(payloadData);\r\n  res.status(200).send(payloadData);\r\n\r\n})().catch((err) => {\r\n  console.log(err);\r\n  res.status(500).send(err);\r\n});",
  "sys__UUID": "ea09b3d4-de13-40eb-963c-99dc3e4e393a",
  "type": "processor"
}