{
    "_id" : "expire_offer_contract_processor",
    "name" : "expire_offer_contract_processor",
    "refType" : "app",
    "refTypeId" : "12325a98-a959-4939-9005-4158d136afcd",
    "snippet" : "const appId = '12325a98-a959-4939-9005-4158d136afcd';\r\nconst contractDomainObjId = '46e84f42-6288-4027-b6d0-fd1c11019259';\r\nvar moment = require(\"moment\");\r\n\r\nvar currentDate = moment.utc().format('YYYY-MM-DDTHH:mm:ss[Z]');;\r\n console.log('currentDate:' + currentDate);\r\n\r\nvar connectDataContractDomain = {\r\n    method: \"GET\",\r\n    url: req.body.propertyList.eka_connect_host +\r\n        `/data/${appId}/${contractDomainObjId}`,\r\n    headers: {\r\n        Authorization: req.headers.authorization,\r\n        \"X-TenantID\": req.headers[\"x-tenantid\"]\r\n    },\r\n    body: {\r\n        filterData: {\r\n            filter: [\r\n                {\r\n                    fieldName: \"requestType\",\r\n                    operator: \"eq\",\r\n                    value: \"Offer to sell\"\r\n                },\r\n\t\t\t\t{\r\n                    fieldName: \"approvalStatus\",\r\n                    operator: \"ne\",\r\n                    value: \"Approved\"\r\n                },\r\n\t\t\t\t{\r\n                    fieldName: \"offerExpiryDate\",\r\n                    operator: \"lt\",\r\n                    value: `${currentDate}`\r\n                },\r\n\r\n                {\r\n                    fieldName: \"isRequestedByEkaCCSystem\",\r\n                    operator: \"eq\",\r\n                    value: true\r\n                }\r\n            ]\r\n        }\r\n    },\r\n    json: true\r\n};\r\n\r\nfunction get_connectData_contractDomain() {\r\n    return new Promise(function(resolve, reject) {\r\n        // console.log('ContractDomain Request - ' + connectDataContractDomain.url);\r\n        // console.log('ContractDomain Body -' + JSON.stringify(connectDataContractDomain.body));\r\n        request(connectDataContractDomain, function(err, response, body) {\r\n\t\t\t// console.log('ContractDomain Response - ' + JSON.stringify(body));\r\n\t\t\tif(response.statusCode >= 200 && response.statusCode <=299){\r\n\t\t\t\tresolve(body); //Success\r\n\t\t\t} else{\r\n\t\t\t\treject(body); //Failure\r\n\t\t\t}\r\n\t\t});\r\n    });\r\n};\r\n\r\nPromise.all([get_connectData_contractDomain()]).then(function(result) {\t\r\n\t\r\n\tvar contractDomainData = result[0];\r\n    var contractDomainDataToBeUpdated=[];\r\n    for (let i = 0; i < contractDomainData.length; i++) {\r\n        contractDomainDataToBeUpdated.push({\r\n            \"contractRefNo\": contractDomainData[i].contractRefNo,\r\n            \"contractItemRefNo\": contractDomainData[i].contractItemRefNo,\r\n            \"requestIdUnique\": contractDomainData[i].requestIdUnique,\r\n            \"requestId\": contractDomainData[i].requestId,\r\n            \"isRequestActive\": false,\r\n            \"approvalStatus\": \"Expired\"\r\n        });\r\n    }\r\n\r\n    console.log('No. of contractDomain records expired' + contractDomainDataToBeUpdated.length);\r\n    res.status(200).send(contractDomainDataToBeUpdated);\r\n}).catch(err => res.status(500).send(err));",
    "sys__UUID" : "1c08e3be-8e62-11ec-b909-0242ac120002",
    "type" : "processor"
}